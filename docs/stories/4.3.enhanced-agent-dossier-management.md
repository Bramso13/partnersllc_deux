# Story 4.3: Enhanced Agent Dossier Management View

## Status

Draft

## Story

**As an** agent,
**I want** comprehensive tools to manage dossiers including status changes, internal notes, and assignment,
**so that** I can handle exceptional cases and maintain clear records.

## Acceptance Criteria

1. Agent dossier view at `/admin/dossiers/[id]` shows all client-visible info plus admin controls
2. Admin actions sidebar includes:
   - Change Status dropdown (manually override status: QUALIFICATION, IN_PROGRESS, PENDING_REVIEW, COMPLETED, CANCELLED)
   - Assign to Agent dropdown (reassign dossier to different agent)
   - Add Internal Note text area (notes visible only to agents, not clients)
   - Complete Step button (manual override for step completion)
   - Cancel Dossier button (with confirmation modal)
3. Status change creates `DOSSIER_STATUS_CHANGED` event and notification to client
4. Internal notes stored in `dossier_notes` table: `dossier_id`, `agent_id`, `note_text`, `created_at`
5. Notes timeline displayed in agent view showing all historical notes
6. Assignment change updates `dossiers.assigned_agent_id`, creates event, notifies new agent
7. Full event log displayed in expandable section showing all system events with technical details (JSON payload)
8. Document history shows all versions of all documents with review details
9. Manual step completion bypasses auto-completion logic, allows completing even if docs not all approved (for exceptional cases)
10. Cancel dossier confirmation modal warns about implications, requires cancellation reason
11. Cancelled dossiers marked `status: CANCELLED`, `cancelled_at: now()`, `cancellation_reason` stored
12. Client notification sent when dossier cancelled
13. Audit trail tracks all agent actions (status changes, notes, assignments) with timestamps and agent names

## Tasks / Subtasks

- [ ] Build admin actions sidebar (AC: 1, 2)
  - [ ] Create sidebar component with action sections
  - [ ] Add styling and layout
  - [ ] Make responsive for mobile
- [ ] Implement status change dropdown (AC: 2, 3)
  - [ ] Create dropdown with all status options
  - [ ] Submit status change to backend API
  - [ ] Create DOSSIER_STATUS_CHANGED event
  - [ ] Send notification to client
  - [ ] Update dossier state in UI
- [ ] Implement agent assignment dropdown (AC: 2, 6)
  - [ ] Query list of available agents
  - [ ] Create dropdown component
  - [ ] Update dossiers.assigned_agent_id in database
  - [ ] Create assignment change event
  - [ ] Notify new agent of assignment
  - [ ] Add audit trail entry
- [ ] Build internal notes feature (AC: 2, 4, 5)
  - [ ] Create textarea component for note input
  - [ ] Implement note submission to `dossier_notes` table
  - [ ] Query and display notes timeline
  - [ ] Show agent name and timestamp for each note
  - [ ] Format notes chronologically
  - [ ] Make notes editable/deletable by original author (optional)
- [ ] Implement manual step completion (AC: 2, 9)
  - [ ] Create "Complete Step" button
  - [ ] Add confirmation modal
  - [ ] Update step status in database
  - [ ] Bypass auto-completion validation
  - [ ] Create event for manual completion
  - [ ] Log in audit trail
- [ ] Build dossier cancellation feature (AC: 2, 10, 11, 12)
  - [ ] Create "Cancel Dossier" button
  - [ ] Build confirmation modal with implications warning
  - [ ] Require cancellation reason textarea
  - [ ] Update dossier.status to CANCELLED
  - [ ] Store cancellation_reason and cancelled_at timestamp
  - [ ] Send notification to client
  - [ ] Log cancellation in audit trail
- [ ] Implement full event log (AC: 7)
  - [ ] Query all events from `dossier_events` for dossier
  - [ ] Create expandable/collapsible event log section
  - [ ] Display event details with JSON payload
  - [ ] Format timestamps and descriptions
  - [ ] Make JSON payload inspectable
- [ ] Build document history view (AC: 8)
  - [ ] Query all document versions with review history
  - [ ] Display document upload timeline
  - [ ] Show review details for each version
  - [ ] Display reviewer name and timestamps
  - [ ] Show approval/rejection status and reasons
- [ ] Implement audit trail (AC: 13)
  - [ ] Create audit log for all agent actions
  - [ ] Track status changes with before/after values
  - [ ] Log all note additions
  - [ ] Log all assignments with previous agent
  - [ ] Display audit trail with agent names and timestamps

## Dev Notes

### Database Schema Requirements

**dossier_notes table:**
```
- id: uuid (PK)
- dossier_id: uuid (FK)
- agent_id: uuid (FK)
- note_text: text
- created_at: timestamp
- updated_at: timestamp
```

**dossiers table additions:**
- `cancelled_at: timestamp (nullable)`
- `cancellation_reason: text (nullable)`

**dossier_events table structure:**
```
- id: uuid (PK)
- dossier_id: uuid (FK)
- event_type: enum (various)
- payload: jsonb
- created_at: timestamp
```

### Admin Actions Sidebar Layout

```
┌─────────────────────────────┐
│ Admin Actions               │
├─────────────────────────────┤
│ Status: [Dropdown ↓]        │
├─────────────────────────────┤
│ Assigned to: [Agent Name ↓] │
├─────────────────────────────┤
│ [Complete Step] Button      │
├─────────────────────────────┤
│ [Cancel Dossier] Button     │
├─────────────────────────────┤
│ Internal Notes:             │
│ [Textarea Area]             │
│ [Add Note] Button           │
└─────────────────────────────┘
```

### Event Types to Display

- `DOSSIER_CREATED`
- `DOSSIER_STATUS_CHANGED`
- `DOCUMENT_UPLOADED`
- `DOCUMENT_REVIEWED`
- `STEP_COMPLETED`
- `STEP_COMPLETED_MANUALLY`
- `ASSIGNMENT_CHANGED`
- `DOSSIER_CANCELLED`
- `MESSAGE_SENT`

### Cancellation Modal Warning

```
Title: "Cancel Dossier?"
Message: "This action will:
- Mark dossier as CANCELLED
- Send notification to client
- Prevent further processing
- Be recorded in audit trail

This action cannot be undone."

Fields:
- Cancellation Reason (textarea, required)
- [Cancel] [Confirm] buttons
```

### Audit Trail Display Format

```
[2026-01-06 14:30:45] Agent John Doe: Status changed from IN_PROGRESS → PENDING_REVIEW
[2026-01-06 13:22:10] Agent John Doe: Document rejected (Passport) - Reason: "Name does not match"
[2026-01-06 10:15:33] Agent Sarah Smith: Assigned dossier from Agent John Doe
[2026-01-06 09:45:12] Agent John Doe: Added internal note: "Client called, needs extension"
```

### Permission Checks

- Only assigned agent can change status/assignment (or admin override)
- All agents can view same dossier
- Internal notes only visible to agents with appropriate role
- Clients never see internal notes or admin actions

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/dossier-management/`
**Coverage Requirements:**
- Status change submission and event creation
- Agent assignment and notification
- Internal notes CRUD operations
- Manual step completion
- Dossier cancellation flow
- Event log display and formatting
- Document history rendering
- Audit trail accuracy
- Permission enforcement

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
