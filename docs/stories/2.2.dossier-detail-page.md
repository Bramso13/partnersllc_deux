# Story 2.2: Dossier Detail Page with Current Step Display

## Status

Ready for Review

## Story

**As a** client,
**I want** to view my dossier details including the current step and required actions,
**so that** I understand exactly what I need to do next to progress my case.

## Acceptance Criteria

1. Dossier detail page at `/dossier/[id]` shows comprehensive dossier information
2. Page header displays: Product name, Status badge, Overall progress bar (3/5 steps completed)
3. Current step section prominently displayed with: Step title, Step description, Step position (e.g., "Step 3 of 5")
4. Required documents for current step listed with document type names and descriptions
5. Document upload area visible only for current step (future steps hidden)
6. Completed steps shown in accordion above current step with checkmark icons
7. Future steps shown in accordion below current step with lock icons (disabled state)
8. Timeline section displays chronological history of all events (dossier created, document uploaded, step completed)
9. RLS policy enforces user can only view their own dossiers (403 error if accessing another user's dossier)
10. Page responsive: Single column on mobile, sidebar layout on desktop (main content + timeline sidebar)
11. Loading state shown while fetching dossier data
12. 404 page shown if dossier ID doesn't exist

## UI Design System & Visual DNA

**CRITICAL:** The implementation MUST respect the visual design system defined below. This is the DNA of the application. Any additional features should follow these design principles.

**Reference Mockup:** `uxpilot-export-1767639162734/2-Suivi de dossier LLC.html`

### Design Principles

- **Dark theme** with high contrast for readability
- **Card-based layout** with subtle hover animations
- **Visual hierarchy** using size, weight, and color
- **Status-driven colors** (success, warning, neutral states)
- **Smooth transitions** (0.3s ease-in-out for hover effects)

### Color System (Exact Values from Mockup)

```css
--brand-dark-bg: #191A1D         /* Main background */
--brand-dark-surface: #2D3033    /* Card/component background */
--brand-dark-border: #363636     /* Borders */
--brand-text-primary: #F9F9F9    /* Primary text */
--brand-text-secondary: #B7B7B7  /* Secondary text */
--brand-accent: #00F0FF          /* Cyan accent (current step, CTA) */
--brand-success: #4ADE80         /* Green (completed steps) */
--brand-warning: #FACC15         /* Yellow (in-progress) */
--brand-danger: #F95757          /* Red (errors, alerts) */
```

### Typography

- **Font Family:** Inter (system-ui fallback)
- **Page Title:** 3xl, bold, text-primary
- **Section Headers:** lg-xl, semibold, text-primary
- **Body Text:** sm-base, normal, text-secondary
- **Step Labels:** sm, medium, status-colored

### Step Card Component Visual Specs

**Layout Structure:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Icon] Step Title                    [Badge]â”‚
â”‚        Description text...                  â”‚
â”‚        [Action Button] (if current step)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Visual States:**

1. **Completed Step** (Ã‰tapes 1-2 in mockup):

   - Background: `brand-dark-bg`
   - Border: `1px solid brand-dark-border`
   - Icon: âœ“ checkmark in circular container
   - Icon Container: `bg-brand-success/20` with `ring-4 ring-brand-success/10`
   - Badge: "TerminÃ©" in `brand-success` with `bg-brand-success/10`
   - Hover: `translateY(-4px)` + subtle shadow

2. **Current Step (In Progress)** (Ã‰tape 3 in mockup):

   - Background: `brand-dark-bg`
   - Border: `2px solid brand-accent` (thicker, accent color)
   - Shadow: `shadow-glow-accent` (0 0 15px rgba(0, 240, 255, 0.15))
   - Icon: âœï¸ pencil in circular container
   - Icon Container: `bg-brand-warning/20` with `ring-4 ring-brand-warning/10`
   - Badge: "En cours" in `brand-warning` with `bg-brand-warning/10`
   - CTA Button: `bg-brand-accent text-brand-dark-bg` with hover opacity 90%
   - Step Label Color: `brand-warning`

3. **Future Step (Locked)** (Ã‰tapes 4-5 in mockup):
   - Background: `brand-dark-bg`
   - Border: `1px solid brand-dark-border`
   - Opacity: 0.6 (entire card)
   - Icon: ğŸ• clock in circular container
   - Icon Container: `bg-brand-dark-border` with `ring-4 ring-brand-dark-surface`
   - No badge
   - Text Color: `brand-text-secondary` (all text)

**Step Connector Line:**

- Vertical line connecting step icons
- Position: Absolute, left 20px, top 48px
- Width: 2px
- Color: `brand-dark-border`
- Hidden on last step

### Progress Bar (Summary Panel)

- Container: `h-2.5 rounded-full bg-brand-dark-surface`
- Fill: `bg-brand-accent rounded-full` with smooth transition (duration-500)
- Width: Dynamic percentage (e.g., 40% in mockup)
- Label: "Progression" + percentage in `brand-accent` color

### Card Hover Animations

```css
.card-hover {
  transition: all 0.3s ease-in-out;
}
.card-hover:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}
```

### Summary Panel (Right Sidebar - Desktop)

**Grid Layout:**

- Desktop: 12-column grid, main content (col-span-8), sidebar (col-span-4)
- Sidebar: Sticky positioning (top-8)
- Two cards: "Votre Dossier" + "Documents Requis"

**Votre Dossier Card:**

- Title + company name
- Progress bar with percentage
- "Prochaines Ã©tapes" checklist:
  - Current: âœ“ filled circle in `brand-warning`
  - Future: â—‹ empty circle in `brand-text-secondary`

**Documents Requis Card:**

- Icon + document name + status
- Status colors: `brand-success` (validated), `brand-warning` (pending)

### Spacing & Borders

- Card Padding: 24px (p-6)
- Border Radius: 16px (rounded-2xl for cards), 12px (rounded-xl for nav)
- Gap between steps: 24px (space-y-6)
- Grid gap: 32px (gap-8)

### Icon System

- **Step Icons:** FontAwesome solid
  - Completed: `fa-check`
  - In Progress: `fa-pencil-alt`
  - Pending: `fa-clock`
  - Documents: `fa-id-card`, `fa-file-invoice`, `fa-file-signature`
- Icon size in step circles: 40px Ã— 40px container

### Responsive Behavior

- **Mobile (<768px):** Single column, sidebar moves below main content
- **Desktop (â‰¥768px):** 2-column grid layout (8/4 split)

### Design Flexibility Guidelines

**The dev CAN add new features IF they:**

- Use the exact color system above
- Follow the card-based layout pattern
- Apply the same hover animations
- Maintain consistent spacing (multiples of 4px/8px)
- Use Inter font family
- Follow the status color conventions (success=green, warning=yellow, etc.)

**Any new components should inherit the visual DNA:**

- Dark backgrounds with subtle borders
- Rounded corners (12px-16px)
- Smooth transitions on interactions
- Status-driven color coding

## Tasks / Subtasks

- [x] Create dossier detail page component at `/dashboard/dossier/[id]` (AC: 1, 2, 9, 12)
  - [x] Build page header with product name and status badge
  - [x] Add overall progress bar
  - [x] Implement RLS-enforced dossier fetching
  - [x] Handle 404 when dossier doesn't exist
  - [x] Handle 403 when user is not dossier owner
- [x] Build current step section (AC: 3, 4, 5)
  - [x] Display step title and description prominently
  - [x] Show step position indicator (Step X of Y)
  - [x] List required documents for current step
  - [x] Show document type names and descriptions
  - [x] Include document upload area component
- [x] Implement completed steps accordion (AC: 6)
  - [x] Display completed steps above current step
  - [x] Add checkmark icons to completed steps
  - [x] Make accordion collapsible/expandable
- [x] Implement future steps accordion (AC: 7)
  - [x] Display future steps below current step
  - [x] Add lock icons to future steps
  - [x] Disable interaction (locked state)
- [x] Build timeline section (AC: 8)
  - [x] Create timeline component
  - [x] Display chronological events: dossier created, document uploaded, step completed
  - [x] Show event timestamps and descriptions
- [x] Implement responsive layout (AC: 10)
  - [x] Single column on mobile
  - [x] Sidebar layout on desktop (main content + timeline)
  - [x] Use Tailwind CSS for responsive design
- [x] Add loading state (AC: 11)
  - [x] Create loading skeleton
  - [x] Show while fetching dossier data

## Dev Notes

### Database Context

**Dossier & Steps:**

- Dossiers have `current_step_instance_id` pointing to active step
- Step instances track `started_at` and `completed_at`
- Steps belong to products with sequential ordering
- Must query step instances for the dossier with relationships to steps and documents

**Events Table Schema:**

- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `event_type`: ENUM (DOSSIER_CREATED, DOCUMENT_UPLOADED, STEP_COMPLETED, DOCUMENT_REVIEWED, DOSSIER_STATUS_CHANGED)
- `payload`: JSON (contains event-specific data)
- `created_at`: timestamp

**Document Type & Required Documents:**

- Each step has required document types
- Document types define what documents are needed per step
- Required documents table links steps to document types

### RLS Enforcement

Dashboard dossier fetch must verify user ownership:

```sql
-- Query with RLS enforcement
SELECT * FROM dossiers
WHERE id = $1 AND user_id = auth.uid()
```

If user attempts to access another user's dossier, return 403.
If dossier ID doesn't exist, return 404.

### Component Architecture

- **DossierDetailPage:** Server Component with RLS-enforced dossier fetching
- **PageHeader Component:** Shows product name, status badge, progress bar
- **CurrentStepSection Component:** Client Component displaying current step and document upload
- **StepAccordion Component:** Reusable accordion for completed/future steps
- **Timeline Component:** Displays chronological event history
- **DocumentList Component:** Lists required documents with upload area
- **LoadingSkeleton:** Shows while fetching

### Timeline Events

Query events in chronological order:

```typescript
// Pseudo-query
SELECT * FROM events
WHERE dossier_id = $1
ORDER BY created_at ASC
```

Map event_type to human-readable descriptions and icons.

### Responsive Design

- **Mobile:** Full width single column, accordions take full width
- **Tablet/Desktop:** Main content area (70%) + timeline sidebar (30%)
- Use Tailwind's `lg:` breakpoint for desktop layout

### Step Icons

- **Completed Steps:** Checkmark icon (green)
- **Current Step:** Highlight/border (accent color)
- **Future Steps:** Lock icon (gray, disabled)

### Testing

- Test dossier detail page loads correctly
- Verify RLS prevents accessing other users' dossiers
- Test 404 for non-existent dossier
- Verify step progression display (X of Y steps)
- Test timeline events display in chronological order
- Test responsive layout on different screen sizes

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Auto (Cursor IDE)

### Debug Log References

N/A

### Completion Notes

- CrÃ©ation de la page de dÃ©tail du dossier Ã  `/dashboard/dossier/[id]` avec toutes les fonctionnalitÃ©s demandÃ©es
- ImplÃ©mentation du header avec nom produit, badge statut, et barre de progression
- Section Ã©tape courante avec affichage des documents requis et zone d'upload
- AccordÃ©ons pour les Ã©tapes complÃ©tÃ©es (au-dessus) et futures (en dessous)
- Timeline avec Ã©vÃ©nements chronologiques depuis la table events et les step_instances
- Layout responsive: colonne unique sur mobile, sidebar sur desktop (8/4 split)
- Gestion des erreurs 404 (dossier introuvable) et 403 (non autorisÃ©) avec RLS
- Ã‰tat de chargement avec Suspense et LoadingSkeleton
- Utilisation du design system avec les couleurs exactes spÃ©cifiÃ©es dans la story
- Extension de `getDossierById` pour rÃ©cupÃ©rer les documents requis et les Ã©vÃ©nements de timeline
- Mise Ã  jour du lien dans le dashboard pour pointer vers la nouvelle route

### File List

**Nouveaux fichiers crÃ©Ã©s:**

- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/page.tsx` - Page serveur avec RLS enforcement
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/DossierDetailPageContent.tsx` - Composant client principal
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/components/PageHeader.tsx` - Header avec nom produit, badge statut, barre de progression
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/components/CurrentStepSection.tsx` - Section Ã©tape courante avec documents requis
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/components/StepAccordion.tsx` - AccordÃ©on pour Ã©tapes complÃ©tÃ©es/futures
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/components/TimelineSection.tsx` - Timeline avec Ã©vÃ©nements chronologiques

**Fichiers modifiÃ©s:**

- `partnersllc-app/lib/dossiers.ts` - Ajout des types DocumentType et TimelineEvent, extension de getDossierById pour rÃ©cupÃ©rer documents requis et Ã©vÃ©nements
- `partnersllc-app/app/(protected)/dashboard/page.tsx` - Mise Ã  jour du lien vers `/dashboard/dossier/[id]`

## QA Results

_Results from QA Agent review will be documented here._
