# Story 2.4: Agent Review Queue Interface

## Status

Draft

## Story

**As an** agent,
**I want** a centralized queue showing all pending document reviews across all dossiers,
**so that** I can efficiently process reviews in priority order without missing any submissions.

## Acceptance Criteria

1. Agent review queue page at `/admin/reviews` accessible to users with AGENT or ADMIN role
2. Table displays all documents with `status: PENDING` from latest version across all dossiers
3. Table columns: Document Type, Client Name, Dossier Product, Uploaded Date, File Size, Actions
4. Table sortable by Uploaded Date (default: oldest first to ensure SLA compliance)
5. Table filterable by: Document Type (dropdown), Date Range (date picker), Dossier Product (dropdown)
6. Search bar filters by client name or dossier ID
7. Pagination implemented: 25 reviews per page with page navigation
8. Each row shows "Review" button opening document review modal
9. Badge shows total count of pending reviews in page header
10. Auto-refresh every 60 seconds to show newly uploaded documents
11. Empty state when no pending reviews: "All caught up! No pending reviews."
12. Loading skeleton shown while fetching reviews
13. RLS policy allows agents to read all documents (not just their assigned dossiers)

## Tasks / Subtasks

- [ ] Create review queue page at `/admin/reviews` (AC: 1)
  - [ ] Implement role-based access control (AGENT, ADMIN only)
  - [ ] Build page layout and header
  - [ ] Add page title and description
- [ ] Build review table component (AC: 2, 3)
  - [ ] Create table with columns: Document Type, Client Name, Dossier Product, Uploaded Date, File Size, Actions
  - [ ] Fetch pending documents from database
  - [ ] Display documents with latest version only
- [ ] Implement table sorting (AC: 4)
  - [ ] Make Uploaded Date sortable
  - [ ] Set default sort: oldest first (ascending)
  - [ ] Allow toggle between ascending/descending
- [ ] Implement table filtering (AC: 5)
  - [ ] Add Document Type dropdown filter
  - [ ] Add Date Range date picker filter
  - [ ] Add Dossier Product dropdown filter
  - [ ] Update table when filters change
- [ ] Build search bar (AC: 6)
  - [ ] Create search input component
  - [ ] Filter by client name or dossier ID
  - [ ] Real-time search as user types
- [ ] Implement pagination (AC: 7)
  - [ ] Set page size to 25 items
  - [ ] Create pagination controls
  - [ ] Handle page navigation
- [ ] Add Review button (AC: 8)
  - [ ] Create "Review" button per row
  - [ ] Trigger document review modal on click
- [ ] Add pending review count badge (AC: 9)
  - [ ] Display badge in page header
  - [ ] Show total count of pending reviews
- [ ] Implement auto-refresh (AC: 10)
  - [ ] Refresh table every 60 seconds
  - [ ] Fetch latest pending documents
- [ ] Create empty state (AC: 11)
  - [ ] Show "All caught up! No pending reviews." when no pending docs
- [ ] Add loading skeleton (AC: 12)
  - [ ] Create loading skeleton component
  - [ ] Show while fetching reviews
- [ ] Implement RLS for agent access (AC: 13)
  - [ ] Allow agents to read all documents (not just assigned dossiers)
  - [ ] Override user-specific RLS for agents/admins

## Dev Notes

### Database Context

**Document Versions Table:**
- `id`: UUID primary key
- `document_id`: UUID foreign key
- `version_number`: integer
- `file_path`: text
- `file_size`: integer (bytes)
- `mime_type`: text
- `status`: ENUM (PENDING, APPROVED, REJECTED, OUTDATED)
- `created_at`: timestamp

**Documents Table:**
- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `document_type_id`: UUID foreign key
- `step_instance_id`: UUID foreign key
- `uploaded_by`: ENUM (USER, AGENT)
- `current_version_id`: UUID foreign key to document_versions
- `created_at`: timestamp

**Document Types:**
- `id`: UUID primary key
- `name`: text
- `slug`: text

**Dossiers:**
- `id`: UUID primary key
- `user_id`: UUID (client user)
- `product_id`: UUID foreign key
- `status`: ENUM

**Users (Clients):**
- `id`: UUID primary key
- `email`: text
- `full_name`: text

**Products:**
- `id`: UUID primary key
- `name`: text

### Query for Pending Reviews

Fetch all pending documents with their related information:

```typescript
// Pseudo-query - get documents with PENDING status (latest version only)
SELECT
  dv.id as version_id,
  d.id as document_id,
  dt.name as document_type_name,
  u.full_name as client_name,
  doss.id as dossier_id,
  p.name as product_name,
  dv.created_at as uploaded_date,
  dv.file_size,
  dv.file_path,
  dv.mime_type
FROM document_versions dv
JOIN documents d ON d.current_version_id = dv.id
JOIN document_types dt ON d.document_type_id = dt.id
JOIN dossiers doss ON d.dossier_id = doss.id
JOIN users u ON doss.user_id = u.id
JOIN products p ON doss.product_id = p.id
WHERE dv.status = 'PENDING'
ORDER BY dv.created_at ASC
```

### RLS for Agents

Allow agents to read all documents regardless of dossier ownership:

```sql
-- RLS Policy: Agents/Admins can read all documents
CREATE POLICY "Agents can read all documents" ON documents
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM auth.users
      WHERE id = auth.uid()
      AND raw_user_meta_data->>'role' IN ('AGENT', 'ADMIN')
    )
  );
```

### Filtering & Sorting

- **Filter by Document Type:** Use `document_type_id IN (selected_types)`
- **Filter by Date Range:** Use `dv.created_at BETWEEN start_date AND end_date`
- **Filter by Dossier Product:** Use `product_id IN (selected_products)`
- **Search by Client Name:** Use `u.full_name ILIKE '%search_term%'`
- **Search by Dossier ID:** Use `doss.id::text LIKE '%search_term%'`
- **Sort by Uploaded Date:** `ORDER BY dv.created_at ASC/DESC`

### Component Architecture

- **ReviewQueuePage:** Server Component with role-based access control
- **ReviewTable Component:** Client Component displaying pending documents
- **FilterBar Component:** Filters and search input
- **PaginationControls Component:** Page navigation
- **PendingBadge Component:** Shows total pending count
- **EmptyState Component:** Shown when no pending reviews
- **LoadingSkeleton Component:** Shown while loading

### Auto-Refresh Implementation

Use `setInterval` to refresh data every 60 seconds:
```typescript
useEffect(() => {
  const interval = setInterval(() => {
    // Refetch pending documents
    refetchReviews();
  }, 60000); // 60 seconds

  return () => clearInterval(interval);
}, []);
```

Or use Server Component with Supabase Realtime subscriptions for real-time updates.

### Pagination

- Default page size: 25 items
- Calculate total pages: `Math.ceil(totalCount / 25)`
- Offset for database query: `(currentPage - 1) * 25`

### Testing

- Test agent can access `/admin/reviews` (non-agents cannot)
- Test pending documents display in table
- Test sorting by Uploaded Date
- Test filtering by Document Type, Date Range, Product
- Test search by client name and dossier ID
- Test pagination (25 items per page)
- Test Review button opens modal
- Test auto-refresh updates table
- Test empty state when no pending reviews

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
