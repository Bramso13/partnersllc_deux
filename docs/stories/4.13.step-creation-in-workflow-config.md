# Story 4.13: Step Creation in Workflow Configuration

## Status

Ready for Review

## Story

**As an** admin,
**I want** to create new workflow steps directly from the workflow configuration page,
**so that** I can build custom workflows without being limited to existing predefined steps.

## Acceptance Criteria

1. Workflow configuration page at `/admin/products/[id]/workflow` includes "Create New Step" option in addition to selecting existing steps
2. "Add Step" modal (or button) offers two options:
   - "Select Existing Step" - current behavior (choose from predefined steps)
   - "Create New Step" - new option to create a custom step
3. Create New Step modal/form includes fields:
   - Code (required, text, unique identifier in UPPER_SNAKE_CASE, e.g., 'CUSTOM_QUALIFICATION')
   - Label (required, text, display name, e.g., 'Custom Qualification')
   - Description (optional, textarea)
   - Position (optional, integer, auto-calculated if not provided)
4. Code field validation:
   - Required, min 3 characters, max 50 characters
   - Format: UPPER_SNAKE_CASE (e.g., 'MY_CUSTOM_STEP')
   - Must be unique across all steps
   - Real-time validation feedback
5. Label field validation:
   - Required, min 2 characters, max 100 characters
   - Human-readable display name
6. Description field:
   - Optional, max 500 characters
   - Character counter display
7. Position field:
   - Optional integer
   - If not provided, auto-calculated as max(position) + 1
   - Must be unique globally (across all steps)
8. Step creation API route:
   - `POST /api/admin/steps` - Create new step
   - Returns created step with generated ID
   - Validates code uniqueness
   - Handles position calculation
9. After step creation:
   - New step is automatically selected and added to workflow
   - User can immediately configure custom fields and documents for the new step
   - Step appears in "Available Steps" list for future use
10. UI/UX improvements:
    - Clear separation between "Select Existing" and "Create New" options
    - Intuitive form layout with clear labels
    - Real-time validation feedback
    - Success message after step creation
    - Error handling with clear messages
11. Code generation helper (optional enhancement):
    - Auto-generate code from label (e.g., "Custom Qualification" → "CUSTOM_QUALIFICATION")
    - Allow manual override
    - Validate format and uniqueness
12. Step can be edited after creation (in separate story if needed):
    - Code cannot be changed (immutable)
    - Label and description can be updated
    - Position can be updated (requires reordering)

## Tasks / Subtasks

- [x] Update AddStepModal component (AC: 1, 2)
  - [x] Add tab or toggle for "Select Existing" vs "Create New"
  - [x] Keep existing "Select Existing Step" functionality
  - [x] Add "Create New Step" form/modal
  - [x] Add clear visual separation between options
- [x] Create New Step form (AC: 3)
  - [x] Create form component with all required fields
  - [x] Add Code input field (text)
  - [x] Add Label input field (text)
  - [x] Add Description textarea (optional)
  - [x] Add Position input field (optional, number)
  - [x] Add form validation
  - [x] Add character counters where applicable
- [x] Code field validation (AC: 4)
  - [x] Implement required validation
  - [x] Implement min/max length validation
  - [x] Implement UPPER_SNAKE_CASE format validation (regex)
  - [x] Implement uniqueness check (API call)
  - [x] Add real-time validation feedback
  - [x] Show validation error messages
- [x] Label field validation (AC: 5)
  - [x] Implement required validation
  - [x] Implement min/max length validation
  - [x] Show validation error messages
- [x] Description field (AC: 6)
  - [x] Add character counter (max 500)
  - [x] Show remaining characters
  - [x] Prevent exceeding max length
- [x] Position field handling (AC: 7)
  - [x] Add optional position input
  - [x] Implement position uniqueness validation
  - [x] Auto-calculate position if not provided (max + 1)
  - [x] Handle position conflicts
- [x] Create step API route (AC: 8)
  - [x] Create `POST /api/admin/steps` route
  - [x] Add authentication (requireAdminAuth)
  - [x] Validate required fields (code, label)
  - [x] Validate code format (UPPER_SNAKE_CASE)
  - [x] Check code uniqueness in database
  - [x] Check position uniqueness if provided
  - [x] Auto-calculate position if not provided
  - [x] Insert into `steps` table
  - [x] Return created step
  - [x] Handle errors gracefully
- [x] Integrate step creation with workflow (AC: 9)
  - [x] After step creation, automatically select new step
  - [x] Add new step to workflow steps list
  - [x] Allow immediate configuration (custom fields, documents)
  - [x] Update "Available Steps" list to include new step
  - [x] Refresh workflow configuration
- [x] UI/UX improvements (AC: 10)
  - [x] Clear visual separation between options
  - [x] Intuitive form layout
  - [x] Real-time validation feedback
  - [x] Success notification after creation
  - [x] Error handling with clear messages
  - [x] Loading states during API calls
  - [x] Disable form during submission
- [x] Code generation helper (AC: 11, optional)
  - [x] Auto-generate code from label
  - [x] Convert to UPPER_SNAKE_CASE format
  - [x] Allow manual override
  - [x] Validate generated code
  - [x] Show preview of generated code

## Dev Notes

### Database Schema Reference

**steps table (from database-v2.sql):**
```sql
CREATE TABLE steps (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code text UNIQUE NOT NULL,  -- e.g., 'QUALIFICATION', 'DOCUMENT_COLLECTION'
  label text NOT NULL,
  description text,
  position int NOT NULL,
  created_at timestamptz DEFAULT now() NOT NULL
);
```

**Constraints:**
- `code` must be unique
- `position` should be unique globally (though not enforced by DB constraint, handled in application)
- `code` format: typically UPPER_SNAKE_CASE
- `position` used for global ordering

### Code Format Validation

**UPPER_SNAKE_CASE Regex:**
```javascript
const UPPER_SNAKE_CASE_REGEX = /^[A-Z][A-Z0-9_]*$/;
// Examples: 'MY_STEP', 'CUSTOM_QUALIFICATION', 'STEP_1'
// Invalid: 'my_step', 'MyStep', 'my-step', '123_STEP'
```

**Validation Rules:**
- Must start with uppercase letter
- Can contain uppercase letters, numbers, and underscores
- No spaces, hyphens, or special characters
- Min 3 characters (e.g., 'ABC')
- Max 50 characters

### Position Handling

**Auto-calculation logic:**
```sql
SELECT COALESCE(MAX(position), -1) + 1 as next_position
FROM steps;
```

**If position provided:**
- Must be unique (check before insert)
- If conflict, suggest next available position or return error

### API Route Specification

**POST /api/admin/steps**
```typescript
// Request Body:
{
  code: string;           // Required, UPPER_SNAKE_CASE, unique
  label: string;          // Required, 2-100 chars
  description?: string;   // Optional, max 500 chars
  position?: number;      // Optional, auto-calculated if not provided
}

// Response (success):
{
  step: {
    id: string;
    code: string;
    label: string;
    description: string | null;
    position: number;
    created_at: string;
  }
}

// Response (error):
{
  error: string;
  details?: {
    field?: string;
    message: string;
  }
}
```

**Validation Errors:**
- `code` required
- `code` invalid format (not UPPER_SNAKE_CASE)
- `code` already exists
- `code` too short (< 3 chars) or too long (> 50 chars)
- `label` required
- `label` too short (< 2 chars) or too long (> 100 chars)
- `description` too long (> 500 chars)
- `position` already taken (if provided)

### Component Structure

**Option 1: Tabs in AddStepModal**
```
AddStepModal
├── Tabs: [Select Existing] [Create New]
├── SelectExistingTab (current implementation)
└── CreateNewStepTab
    ├── CodeInput (with validation)
    ├── LabelInput (with validation)
    ├── DescriptionTextarea (with counter)
    ├── PositionInput (optional)
    └── SubmitButton
```

**Option 2: Separate Modal/Button**
```
AddStepModal (for existing steps)
CreateStepModal (new, for creating steps)
└── Form with all fields
```

### Code Generation Helper

**Label to Code Conversion:**
```javascript
function labelToCode(label: string): string {
  return label
    .trim()
    .toUpperCase()
    .replace(/[^A-Z0-9\s]/g, '') // Remove special chars
    .replace(/\s+/g, '_')         // Spaces to underscores
    .replace(/^_+|_+$/g, '');     // Trim underscores
}

// Examples:
// "Custom Qualification" → "CUSTOM_QUALIFICATION"
// "My Step 1" → "MY_STEP_1"
// "Step - With Dashes!" → "STEP_WITH_DASHES"
```

### Integration with Workflow Configuration

**Flow:**
1. User clicks "Add Step" button
2. Modal opens with "Select Existing" and "Create New" options
3. User selects "Create New"
4. User fills form (code, label, description, position)
5. User submits form
6. API creates step in `steps` table
7. New step is returned
8. Step is automatically added to workflow steps list
9. User can immediately configure custom fields and documents
10. Step appears in available steps for future use

### UI/UX Design

**Create New Step Form Layout:**
```
┌─────────────────────────────────────┐
│ Create New Step                     │
├─────────────────────────────────────┤
│ Code *                              │
│ [MY_CUSTOM_STEP________]           │
│ Format: UPPER_SNAKE_CASE            │
│                                     │
│ Label *                             │
│ [My Custom Step________________]   │
│                                     │
│ Description (optional)              │
│ [___________________________]      │
│ [___________________________]      │
│ 0/500 characters                    │
│                                     │
│ Position (optional)                 │
│ [____] Auto-calculated if empty    │
│                                     │
│        [Cancel] [Create Step]       │
└─────────────────────────────────────┘
```

**Validation Feedback:**
- Real-time validation as user types
- Error messages below fields
- Success indicators for valid fields
- Disable submit button if form invalid
- Show loading state during submission

### Error Handling

**Code Uniqueness Check:**
- Query database before submission
- Show error immediately if code exists
- Suggest alternatives if available

**Position Conflicts:**
- If position provided and exists, suggest next available
- Or return error and let user choose new position

**Network Errors:**
- Show user-friendly error message
- Allow retry
- Preserve form data

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/workflow-config/`
**Coverage Requirements:**
- Code format validation
- Code uniqueness validation
- Label validation
- Description character limit
- Position auto-calculation
- Position conflict handling
- Step creation API route
- Integration with workflow configuration
- Error handling
- UI state management
- Form submission flow

## Change Log

| Date       | Version | Description                        | Author          |
| ---------- | ------- | ---------------------------------- | --------------- |
| 2026-01-XX | 1.0     | Initial story creation             | Bob (SM Agent)  |
| 2026-01-11 | 1.1     | Story implementation completed     | James (Dev Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

_To be filled by dev agent_

### Completion Notes

- Successfully implemented tabbed interface in AddStepModal with "Select Existing" and "Create New" tabs
- Created comprehensive step creation form with all required fields (code, label, description, position)
- Implemented real-time validation for all fields including UPPER_SNAKE_CASE format validation for code field
- Added code uniqueness check via new API endpoint `/api/admin/steps/check-code`
- Implemented auto-generation of code from label with manual override capability
- Added character counter for description field (500 max)
- Implemented position auto-calculation when not provided
- Created POST endpoint for step creation with full validation and error handling
- Integrated step creation with workflow - new steps are automatically added to workflow after creation
- Added onRefreshSteps callback to ensure available steps list is updated
- All UI/UX improvements implemented including loading states, error handling, and real-time feedback
- Note: Test infrastructure (Vitest/React Testing Library) not yet set up in project - testing deferred
- No linting or TypeScript errors introduced by the implementation

### File List

**Modified:**
- `partnersllc-app/components/admin/products/workflow/AddStepModal.tsx` - Added tabbed interface with Create New Step form
- `partnersllc-app/components/admin/products/workflow/WorkflowConfigContent.tsx` - Added onRefreshSteps prop to modal
- `partnersllc-app/app/api/admin/steps/route.ts` - Added POST endpoint for step creation

**Created:**
- `partnersllc-app/app/api/admin/steps/check-code/route.ts` - Code uniqueness validation endpoint

## QA Results

_Results from QA Agent review will be documented here._
