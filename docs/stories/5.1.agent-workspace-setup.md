# Story 5.1: Agent Workspace Setup & Navigation

## Status

Draft

## Story

**As an** agent,
**I want** a dedicated workspace at `/agent` with its own navigation,
**so that** I can access my assigned work without confusion with admin tools.

## Acceptance Criteria

1. Agent workspace root at `/agent` displays agent's personal dashboard
2. Workspace accessible only to users with `profiles.role = 'AGENT'` or `'ADMIN'`
3. Clients (`profiles.role = 'CLIENT'`) redirected to `/unauthorized` with 403 error
4. Agent navigation config (`agentNavConfig`) created with menu items:
   - Tableau de bord (href: `/agent`, icon: `fa-gauge-high`)
   - Mes étapes (href: `/agent/steps`, icon: `fa-list-check`)
   - Documents à reviewer (href: `/agent/reviews`, icon: `fa-file-circle-check`)
5. Agent layout uses same dark theme as admin/client but with distinct header text "Espace Agent"
6. User profile dropdown shows role badge ("Agent" in cyan, "Admin" in purple)
7. Navigation sidebar responsive: collapsible on mobile, persistent on desktop
8. Quick stats on dashboard: Assigned steps count, Pending reviews count
9. Agent with ADMIN role can see link to switch to admin view (via profile dropdown)
10. Middleware protects all `/agent/*` routes from unauthorized access

## Tasks / Subtasks

- [ ] Create agent workspace layout (AC: 1, 4, 5, 6, 7)
  - [ ] Create `app/(protected)/agent/layout.tsx`
  - [ ] Use existing `SidebarProvider` and `Sidebar` components
  - [ ] Create `agentNavConfig` in `lib/navigation-config.ts`
  - [ ] Add "Espace Agent" header/branding to distinguish from admin
  - [ ] Implement role badge in profile dropdown

- [ ] Set up authentication and middleware (AC: 2, 3, 10)
  - [ ] Create `requireAgentRoleAuth()` in `lib/auth.ts` (checks for AGENT or ADMIN role)
  - [ ] Update `middleware.ts` to handle `/agent/*` routes
  - [ ] Return 403 for CLIENT role trying to access agent workspace
  - [ ] Test access control for all three roles

- [ ] Create agent dashboard page (AC: 1, 8)
  - [ ] Create `app/(protected)/agent/page.tsx`
  - [ ] Add quick stats cards (assigned steps, pending reviews)
  - [ ] Placeholder content for full dashboard (Story 5.5)

- [ ] Add admin switch feature (AC: 9)
  - [ ] Check if user has ADMIN role
  - [ ] Show "Espace Admin" link in profile dropdown for admins
  - [ ] Navigate to `/admin` when clicked

- [ ] Testing
  - [ ] Test CLIENT cannot access `/agent`
  - [ ] Test AGENT can access `/agent`
  - [ ] Test ADMIN can access `/agent`
  - [ ] Test navigation renders correctly
  - [ ] Test responsive sidebar on mobile

## Dev Notes

### Prerequisites

**Story 4.9 (User Role Migration)** must be completed first to have `profiles.role` field.

### Navigation Config

Add to `lib/navigation-config.ts`:

```typescript
export const agentNavConfig: NavConfig = {
  sections: [
    {
      label: "Espace Agent",
      items: [
        {
          href: "/agent",
          icon: "fa-gauge-high",
          label: "Tableau de bord",
        },
        {
          href: "/agent/steps",
          icon: "fa-list-check",
          label: "Mes étapes",
        },
        {
          href: "/agent/reviews",
          icon: "fa-file-circle-check",
          label: "Documents à reviewer",
        },
      ],
    },
  ],
};
```

### Layout Structure

```tsx
// app/(protected)/agent/layout.tsx
import { requireAgentRoleAuth } from "@/lib/auth";
import { SidebarProvider } from "@/components/sidebar/SidebarProvider";
import { Sidebar } from "@/components/sidebar/Sidebar";
import { agentNavConfig } from "@/lib/navigation-config";

export default async function AgentLayout({ children }: { children: React.ReactNode }) {
  const agent = await requireAgentRoleAuth();
  
  return (
    <SidebarProvider>
      <div className="flex min-h-screen bg-brand-dark-bg">
        <Sidebar 
          navConfig={agentNavConfig} 
          user={agent}
          workspaceTitle="Espace Agent"
        />
        <main className="flex-1 overflow-auto">
          {children}
        </main>
      </div>
    </SidebarProvider>
  );
}
```

### Auth Function

```typescript
// lib/auth.ts
export async function requireAgentRoleAuth(): Promise<User> {
  const user = await getCurrentUser();
  if (!user) {
    redirect('/login');
  }
  if (!['AGENT', 'ADMIN'].includes(user.role)) {
    redirect('/unauthorized');
  }
  return user;
}
```

### Project Structure

```
partnersllc-app/
├── app/(protected)/agent/
│   ├── layout.tsx           # Agent workspace layout (NEW)
│   └── page.tsx             # Agent dashboard placeholder (NEW)
├── lib/
│   ├── navigation-config.ts # Add agentNavConfig (MODIFIED)
│   └── auth.ts              # Add requireAgentRoleAuth (MODIFIED)
└── middleware.ts            # Add /agent/* route protection (MODIFIED)
```

### Role Badge Colors

- CLIENT: Gray (`#6B7280`)
- AGENT: Cyan (`#00F0FF`)
- ADMIN: Purple (`#A78BFA`)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*To be filled during implementation*

## QA Results

*To be filled after QA review*
