# Story 5.1: Agent Workspace Setup & Navigation

## Status

Ready for Review

## Story

**As an** agent,
**I want** a dedicated workspace at `/agent` with its own navigation,
**so that** I can access my assigned work without confusion with admin tools.

## Acceptance Criteria

1. Agent workspace root at `/agent` displays agent's personal dashboard
2. Workspace accessible only to users with `profiles.role = 'AGENT'` or `'ADMIN'`
3. Clients (`profiles.role = 'CLIENT'`) redirected to `/unauthorized` with 403 error
4. Agent navigation config (`agentNavConfig`) created with menu items:
   - Tableau de bord (href: `/agent`, icon: `fa-gauge-high`)
   - Mes étapes (href: `/agent/steps`, icon: `fa-list-check`)
5. Agent layout uses same dark theme as admin/client but with distinct header text "Espace Agent"
6. User profile dropdown shows role badge ("Agent" in cyan, "Admin" in purple)
7. Navigation sidebar responsive: collapsible on mobile, persistent on desktop
8. Quick stats on dashboard: Assigned steps count, Pending reviews count
9. Agent with ADMIN role can see link to switch to admin view (via profile dropdown)
10. Middleware protects all `/agent/*` routes from unauthorized access

## Tasks / Subtasks

- [x] Create agent workspace layout (AC: 1, 4, 5, 6, 7)
  - [x] Create `app/(protected)/agent/layout.tsx` - Note: Uses parent layout at `app/(protected)/layout.tsx` which handles role-based nav config
  - [x] Use existing `SidebarProvider` and `Sidebar` components
  - [x] Create `agentNavConfig` in `lib/navigation-config.ts`
  - [x] Add "Espace Agent" header/branding to distinguish from admin
  - [x] Implement role badge in profile dropdown

- [x] Set up authentication and middleware (AC: 2, 3, 10)
  - [x] Create `requireAgentRoleAuth()` in `lib/auth.ts` (checks for AGENT or ADMIN role) - Named `requireAgentAuth()`
  - [x] Update `middleware.ts` to handle `/agent/*` routes
  - [x] Return 403 for CLIENT role trying to access agent workspace
  - [x] Test access control for all three roles

- [x] Create agent dashboard page (AC: 1, 8)
  - [x] Create `app/(protected)/agent/page.tsx`
  - [x] Add quick stats cards (assigned steps, pending reviews)
  - [x] Placeholder content for full dashboard (Story 5.5)

- [x] Add admin switch feature (AC: 9)
  - [x] Check if user has ADMIN role
  - [x] Show "Espace Admin" link in profile dropdown for admins
  - [x] Navigate to `/admin` when clicked

- [x] Testing
  - [x] Test CLIENT cannot access `/agent`
  - [x] Test AGENT can access `/agent`
  - [x] Test ADMIN can access `/agent`
  - [x] Test navigation renders correctly
  - [x] Test responsive sidebar on mobile

## Dev Notes

### Prerequisites

**Story 4.9 (User Role Migration)** must be completed first to have `profiles.role` field.

### Navigation Config

Add to `lib/navigation-config.ts`:

```typescript
export const agentNavConfig: NavConfig = {
  sections: [
    {
      label: "Espace Agent",
      items: [
        {
          href: "/agent",
          icon: "fa-gauge-high",
          label: "Tableau de bord",
        },
        {
          href: "/agent/steps",
          icon: "fa-list-check",
          label: "Mes étapes",
        },
      ],
    },
  ],
};
```

### Layout Structure

```tsx
// app/(protected)/agent/layout.tsx
import { requireAgentRoleAuth } from "@/lib/auth";
import { SidebarProvider } from "@/components/sidebar/SidebarProvider";
import { Sidebar } from "@/components/sidebar/Sidebar";
import { agentNavConfig } from "@/lib/navigation-config";

export default async function AgentLayout({ children }: { children: React.ReactNode }) {
  const agent = await requireAgentRoleAuth();
  
  return (
    <SidebarProvider>
      <div className="flex min-h-screen bg-brand-dark-bg">
        <Sidebar 
          navConfig={agentNavConfig} 
          user={agent}
          workspaceTitle="Espace Agent"
        />
        <main className="flex-1 overflow-auto">
          {children}
        </main>
      </div>
    </SidebarProvider>
  );
}
```

### Auth Function

```typescript
// lib/auth.ts
export async function requireAgentRoleAuth(): Promise<User> {
  const user = await getCurrentUser();
  if (!user) {
    redirect('/login');
  }
  if (!['AGENT', 'ADMIN'].includes(user.role)) {
    redirect('/unauthorized');
  }
  return user;
}
```

### Project Structure

```
partnersllc-app/
├── app/(protected)/agent/
│   ├── layout.tsx           # Agent workspace layout (NEW)
│   └── page.tsx             # Agent dashboard placeholder (NEW)
├── lib/
│   ├── navigation-config.ts # Add agentNavConfig (MODIFIED)
│   └── auth.ts              # Add requireAgentRoleAuth (MODIFIED)
└── middleware.ts            # Add /agent/* route protection (MODIFIED)
```

### Role Badge Colors

- CLIENT: Gray (`#6B7280`)
- AGENT: Cyan (`#00F0FF`)
- ADMIN: Purple (`#A78BFA`)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File | Action | Description |
|------|--------|-------------|
| `app/(protected)/agent/page.tsx` | NEW | Agent dashboard page with quick stats |
| `lib/navigation-config.ts` | MODIFIED | Updated `agentNavConfig` to match AC#4 requirements |
| `components/ui/RoleBadge.tsx` | MODIFIED | Updated colors for dark theme (AC#6) |
| `components/DashboardHeader.tsx` | MODIFIED | Added role badge display and workspace switch dropdown (AC#6, AC#9) |

### Implementation Notes

1. **Architecture Decision**: The agent workspace does not require its own `layout.tsx` because the parent layout at `app/(protected)/layout.tsx` already handles role-based navigation config via `getNavConfigForRole()`. This approach:
   - Reduces code duplication
   - Ensures consistent sidebar/header behavior across workspaces
   - Automatically uses correct `agentNavConfig` when AGENT role detected

2. **Pre-existing Infrastructure**: Several components were already implemented:
   - `requireAgentAuth()` in `lib/auth.ts` (equivalent to story's `requireAgentRoleAuth()`)
   - Middleware protection for `/agent/*` routes in `middleware.ts`
   - `SidebarHeader` with "Espace Agent" branding for AGENT role

3. **Role Badge Colors**: Updated to dark theme compatible colors:
   - CLIENT: Gray (`bg-gray-500/20 text-gray-400`)
   - AGENT: Cyan (`bg-cyan-500/20 text-cyan-400`)
   - ADMIN: Purple (`bg-purple-500/20 text-purple-400`)

4. **Workspace Switch**: DashboardHeader now includes dropdown with:
   - "Espace Admin" link when ADMIN is in agent workspace
   - "Espace Agent" link when ADMIN is in admin workspace
   - Profile settings link (context-aware path)

### Debug Log References
None - implementation proceeded without blockers.

### Completion Notes
- All acceptance criteria met
- Build passes successfully (`npm run build`)
- TypeScript compilation clean
- Pre-existing lint warnings unrelated to this story

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |
| 2026-01-17 | 1.1 | Implementation complete | James (Dev) |

## QA Results

*To be filled after QA review*
