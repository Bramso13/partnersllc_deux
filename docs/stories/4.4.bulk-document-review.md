# Story 4.4: Bulk Document Review Operations

## Status

Draft

## Story

**As an** agent,
**I want** to approve or reject multiple documents at once,
**so that** I can process reviews more efficiently when handling batches of similar documents.

## Acceptance Criteria

1. Review queue table includes checkbox column for selecting multiple documents
2. "Select All" checkbox in header selects all documents on current page
3. Bulk action bar appears when one or more documents selected
4. Bulk action bar shows: "X documents selected", "Approve All" button, "Reject All" button, "Clear Selection" link
5. "Approve All" button processes all selected documents, creating APPROVED reviews for each
6. "Reject All" button requires rejection reason (single reason applied to all selected documents)
7. Bulk operations process asynchronously (background job) for large selections (>10 documents)
8. Progress indicator shows "Processing X of Y documents..." during bulk operation
9. Success notification shows summary: "15 documents approved, 3 failed (errors listed)"
10. Failed documents remain selected, allowing agent to retry or handle individually
11. Bulk operation creates individual `document_reviews` records for each document (not a single batch record)
12. Events and notifications created for each document individually (not batched notification)
13. Bulk approve disabled if selected documents are from different document types (safety check - agent should review similar docs together)
14. Action history logs bulk operations with count and affected document IDs

## Tasks / Subtasks

- [ ] Add checkbox column to review queue table (AC: 1)
  - [ ] Add checkbox input to table header row
  - [ ] Add checkbox input to each document row
  - [ ] Style checkboxes consistently
- [ ] Implement "Select All" functionality (AC: 2)
  - [ ] Create checkbox toggle in header
  - [ ] Select all visible documents on page
  - [ ] Update header checkbox when all are selected/deselected
  - [ ] Maintain selection state through pagination
- [ ] Build bulk action bar (AC: 3, 4)
  - [ ] Create sticky/floating action bar that appears when items selected
  - [ ] Display count of selected documents
  - [ ] Add "Approve All" button
  - [ ] Add "Reject All" button
  - [ ] Add "Clear Selection" link
  - [ ] Style with clear visual hierarchy
- [ ] Implement "Approve All" logic (AC: 5, 11, 12)
  - [ ] Collect selected document IDs
  - [ ] Create API endpoint for bulk approve
  - [ ] Insert individual document_reviews records
  - [ ] Create individual DOCUMENT_REVIEWED events
  - [ ] Send individual notifications
  - [ ] Handle async processing for >10 documents
- [ ] Implement "Reject All" logic (AC: 6, 11, 12)
  - [ ] Show modal requiring rejection reason
  - [ ] Collect reason from agent
  - [ ] Create API endpoint for bulk reject
  - [ ] Insert individual document_reviews records with reason
  - [ ] Create individual DOCUMENT_REVIEWED events
  - [ ] Send individual notifications with reason
  - [ ] Handle async processing for >10 documents
- [ ] Implement async processing and progress (AC: 7, 8)
  - [ ] Use background job queue for >10 documents
  - [ ] Implement progress polling or Supabase Realtime updates
  - [ ] Display progress indicator with count updates
  - [ ] Show real-time feedback to agent
- [ ] Build result/completion notification (AC: 9)
  - [ ] Display success summary with counts
  - [ ] List any failed documents with error reasons
  - [ ] Allow retry for failed documents
  - [ ] Keep bulk action context for retries
- [ ] Implement document type safety check (AC: 13)
  - [ ] Check selected documents for different document types
  - [ ] Disable "Approve All" button if types differ
  - [ ] Show helpful warning message
  - [ ] Allow agent to filter to same type
- [ ] Add action history logging (AC: 14)
  - [ ] Log bulk approve operations
  - [ ] Log bulk reject operations
  - [ ] Record count and affected document IDs
  - [ ] Store in audit trail with agent name and timestamp

## Dev Notes

### Bulk Operation API Endpoints

**POST /api/documents/bulk-approve**
```json
{
  "document_ids": ["uuid1", "uuid2", "uuid3"],
  "async": true  // true if >10 documents
}

Response:
{
  "job_id": "uuid",  // if async
  "success": 15,
  "failed": 0,
  "message": "15 documents approved"
}
```

**POST /api/documents/bulk-reject**
```json
{
  "document_ids": ["uuid1", "uuid2", "uuid3"],
  "reason": "Missing signature",
  "async": true  // true if >10 documents
}

Response:
{
  "job_id": "uuid",  // if async
  "success": 15,
  "failed": 3,
  "failed_documents": [
    {"id": "uuid4", "error": "Already reviewed"},
    ...
  ],
  "message": "15 documents rejected, 3 failed"
}
```

### Background Job Processing

**Job Queue Library:** Bull or pg-boss (recommended for Supabase)

**Job Structure:**
```
Queue: document-reviews
Job Type: bulk-approve | bulk-reject
Data:
{
  agent_id: uuid,
  document_ids: uuid[],
  reason?: string,
  created_at: timestamp
}
```

**Progress Tracking:**
- Store job progress in `bulk_operations` table
- Update `processed_count` and `total_count` as documents processed
- Use Supabase Realtime to push updates to client

### Table Checkbox State Management

```tsx
const [selectedIds, setSelectedIds] = useState<string[]>([]);
const [selectAllChecked, setSelectAllChecked] = useState(false);

const toggleSelectAll = () => {
  if (selectAllChecked) {
    setSelectedIds([]);
  } else {
    setSelectedIds(visibleDocuments.map(d => d.id));
  }
  setSelectAllChecked(!selectAllChecked);
};

const toggleSelectDocument = (id: string) => {
  const newSelected = selectedIds.includes(id)
    ? selectedIds.filter(sid => sid !== id)
    : [...selectedIds, id];
  setSelectedIds(newSelected);
  setSelectAllChecked(newSelected.length === visibleDocuments.length);
};
```

### Document Type Check

```tsx
const getDocumentTypes = (ids: string[]) => {
  const types = new Set(
    documents
      .filter(d => ids.includes(d.id))
      .map(d => d.document_type_id)
  );
  return types;
};

const canBulkApprove = () => {
  return getDocumentTypes(selectedIds).size === 1;
};
```

### Bulk Action Bar Styling

Position: Fixed at bottom during selection
Style: Dark background with action buttons
Show: Conditional on `selectedIds.length > 0`
Animation: Slide up from bottom on appearance

### Rejection Modal

```
Title: "Reject Selected Documents?"
Count: "X documents will be rejected"
Field: Rejection Reason (textarea, required)
Buttons: [Cancel] [Reject]
Options: Apply same reason to all
```

### Progress Indicator Component

```tsx
if (jobId) {
  return (
    <ProgressBar
      current={processedCount}
      total={totalCount}
      label={`Processing ${processedCount} of ${totalCount}...`}
    />
  );
}
```

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/bulk-review/`
**Coverage Requirements:**
- Checkbox selection and deselection
- "Select All" and deselect all functionality
- Bulk action bar appearance/disappearance
- Approval of multiple documents
- Rejection with reason
- Async processing for large batches
- Progress indicator updates
- Document type safety check
- Failed document retry
- Audit trail logging

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
