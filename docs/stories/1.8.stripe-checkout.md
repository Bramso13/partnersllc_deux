# Story 1.8: Stripe Checkout Session Integration

## Status
Draft

## Story

**As a** user,
**I want** a seamless Stripe payment experience that feels integrated with the platform,
**so that** I trust the payment process and complete my purchase confidently.

## Acceptance Criteria

1. Stripe Checkout Session displays product name, price, and description from metadata
2. Checkout Session pre-fills customer email from registration
3. Checkout Session accepts test card numbers (4242 4242 4242 4242) in Stripe test mode
4. Payment method options enabled: Card only (no Apple Pay/Google Pay in MVP)
5. Successful payment redirects to success URL: `/dashboard?payment=success`
6. Cancelled payment redirects to cancel URL: `/register/{token}?payment=cancelled` with message "Payment was cancelled. Please try again."
7. Checkout Session expires after 24 hours if not completed
8. Checkout Session metadata includes all required fields for webhook processing: `order_id`, `user_id`, `product_id`
9. Stripe customer created automatically on successful payment with email and name
10. Receipt email sent automatically by Stripe upon successful payment

## Tasks / Subtasks

- [ ] Configure Checkout Session creation (AC: 1, 2, 8)
  - [ ] Create Checkout Session with product/price from Stripe
  - [ ] Include product name, price, description in line items
  - [ ] Pre-fill customer email from registration
  - [ ] Add metadata: `order_id`, `user_id`, `product_id`
- [ ] Configure payment methods (AC: 4)
  - [ ] Set payment method types to card only
  - [ ] Disable Apple Pay and Google Pay
- [ ] Configure success and cancel URLs (AC: 5, 6)
  - [ ] Set success URL: `/dashboard?payment=success`
  - [ ] Set cancel URL: `/register/{token}?payment=cancelled`
  - [ ] Ensure cancel page shows retry message
- [ ] Set session expiration (AC: 7)
  - [ ] Configure expires_at to 24 hours from creation
- [ ] Test with Stripe test cards (AC: 3)
  - [ ] Document test card number: 4242 4242 4242 4242
  - [ ] Test successful payment flow
  - [ ] Test cancelled payment flow
- [ ] Verify customer and receipt email (AC: 9, 10)
  - [ ] Confirm Stripe customer created with email and name
  - [ ] Verify receipt email sent by Stripe

## Dev Notes

### Stripe Checkout Session Configuration

From Story 1.5, use the Stripe SDK initialized in `lib/stripe.ts`:

```typescript
const session = await stripe.checkout.sessions.create({
  payment_method_types: ['card'],
  line_items: [
    {
      price: priceId,
      quantity: 1,
    },
  ],
  mode: 'payment',
  customer_email: email,
  success_url: `${baseUrl}/dashboard?payment=success`,
  cancel_url: `${baseUrl}/register/${token}?payment=cancelled`,
  metadata: {
    order_id: orderId,
    user_id: userId,
    product_id: productId,
  },
  expires_at: Math.floor(Date.now() / 1000) + 24 * 60 * 60,
});
```

### Stripe Test Cards

**Successful Payment:**
- Card Number: 4242 4242 4242 4242
- Expiry: Any future date (e.g., 12/25)
- CVC: Any 3 digits

**Test Mode Setup:**
Stripe automatically runs in test mode when using test API keys. No additional configuration needed.

### Stripe Products and Prices

From Story 1.5, maintain reference to price IDs:
- `STRIPE_PRICE_ID_LLC` - LLC Formation ($999)
- `STRIPE_PRICE_ID_DUBAI` - Dubai Company Setup ($1,499)

### Success and Cancel Handling

**Success URL** (`/dashboard?payment=success`):
- User lands on dashboard
- Show success message
- Await webhook to update account status (Story 1.9)
- Display "processing" message until ACTIVE

**Cancel URL** (`/register/{token}?payment=cancelled`):
- Return to registration page
- Show "Payment was cancelled. Please try again."
- Allow retry without re-entering registration data

### Design System (from architecture.md)

**Color Palette:**
- Main Background: `#191A1D`
- Surface: `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

**UI Framework:** Tailwind CSS
**Language:** French UI

### Integration Notes

- Stripe Checkout Session is hosted by Stripe (no custom checkout UI needed in MVP)
- User leaves application to complete payment on Stripe-hosted page
- After payment, user redirected back to success/cancel URLs
- Webhook (Story 1.9) handles actual account activation

### Testing

Testing standards from Story 1.1:
- Test Checkout Session creation with valid product data
- Test with Stripe test cards
- Test success and cancel redirects
- Test metadata passing to webhook
- Mock Stripe API in unit tests
- E2E test: register → checkout → success/cancel redirect

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
