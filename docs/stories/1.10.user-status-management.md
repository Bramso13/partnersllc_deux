# Story 1.10: User Status Management and Dashboard Access Control

## Status

Done

## Story

**As a** user,
**I want** my dashboard access and available features to reflect my account status (PENDING, ACTIVE, SUSPENDED),
**so that** I understand what actions I need to take and what functionality is available to me.

## Acceptance Criteria

1. Middleware created checking user status on all `/dashboard/*` routes
2. PENDING users accessing dashboard see message: "⏳ Your payment is being processed. You'll receive an email when your account is activated."
3. PENDING users can access `/dashboard/profile` to view order status but cannot access dossiers
4. ACTIVE users can access full dashboard: dossier list, dossier details, profile, notifications
5. SUSPENDED users accessing dashboard see persistent banner: "⚠️ Your payment was unsuccessful. Please complete your payment to access your dossier."
6. SUSPENDED users see "Complete Payment" button in banner redirecting to new Stripe Checkout Session
7. New Checkout Session for SUSPENDED users created with same product and order, new session ID
8. Dashboard homepage (`/dashboard`) shows different content based on status:
   - PENDING: Order status card with "Processing" indicator
   - ACTIVE: Dossier list cards with progress indicators
   - SUSPENDED: Payment required card with action button
9. TypeScript type guard created: `isActiveUser(user)`, `isPendingUser(user)`, `isSuspendedUser(user)`
10. Status-based UI components render conditionally without layout shift
11. Profile badge displays status with color coding: PENDING (yellow), ACTIVE (green), SUSPENDED (red)
12. E2E test created covering full flow: payment link → registration → payment → webhook → dashboard access

## Tasks / Subtasks

- [x] Create dashboard middleware for status checking (AC: 1)
  - [x] Create middleware checking user status
  - [x] Apply to all `/dashboard/*` routes
  - [x] Fetch user profile status from database
  - [x] Log user status for debugging (via header)
- [x] Implement PENDING user experience (AC: 2, 3)
  - [x] Create PENDING status message component
  - [x] Display on dashboard homepage
  - [x] Allow access to `/dashboard/profile`
  - [x] Block access to dossiers for PENDING users (via conditional rendering)
- [ ] Implement ACTIVE user experience (AC: 4)
  - [ ] Create dossier list component
  - [ ] Create dossier details component
  - [x] Enable full dashboard access
  - [ ] Display notifications
- [x] Implement SUSPENDED user experience (AC: 5, 6, 7)
  - [x] Create persistent banner for SUSPENDED users
  - [x] Add "Complete Payment" button
  - [x] Create Server Action to generate new Checkout Session
  - [x] Redirect to new Checkout Session URL
  - [x] Create new Checkout Session with same product/order, new session ID
- [x] Create dashboard homepage with status-based content (AC: 8)
  - [x] PENDING: Display order status card with processing indicator
  - [x] ACTIVE: Display dossier list cards with progress indicators (placeholder)
  - [x] SUSPENDED: Display payment required card with action button
- [x] Create TypeScript type guards (AC: 9)
  - [x] Create `isActiveUser(user)` type guard
  - [x] Create `isPendingUser(user)` type guard
  - [x] Create `isSuspendedUser(user)` type guard
  - [x] Export from types/user.ts
- [x] Implement conditional UI rendering (AC: 10)
  - [x] Use type guards in components
  - [x] Render content based on status
  - [x] Ensure no layout shift during rendering
- [x] Create status badge component (AC: 11)
  - [x] Display in profile/header
  - [x] Color code: PENDING (yellow), ACTIVE (green), SUSPENDED (red)
  - [x] Show status text (e.g., "Processing", "Active", "Payment Required")
- [ ] Create E2E test (AC: 12)
  - [ ] Test full flow: payment link → registration → payment
  - [ ] Wait for webhook processing
  - [ ] Verify dashboard access
  - [ ] Test status transitions

## Dev Notes

### Profile Status Values

From database schema, profile status ENUM:

- `PENDING` - Payment being processed, account not yet activated
- `ACTIVE` - Payment received, account fully active
- `SUSPENDED` - Payment failed or declined, account suspended

### Middleware Implementation

Create middleware to check status on all `/dashboard/*` routes:

```typescript
// middleware.ts
import { NextRequest, NextResponse } from "next/server";
import { getUser } from "@/lib/auth";

export async function middleware(request: NextRequest) {
  const user = await getUser();

  if (!user) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  const profile = await getProfile(user.id);

  // Store status in request header for use in page
  const response = NextResponse.next();
  response.headers.set("x-user-status", profile.status);

  return response;
}

export const config = {
  matcher: ["/dashboard/:path*"],
};
```

### Dashboard Content Based on Status

**PENDING:**

```
"⏳ Your payment is being processed.
You'll receive an email when your account is activated."

Order Status Card:
- Order ID
- Product Name
- Amount Paid
- Status: Processing (with spinner)
```

**ACTIVE:**

```
Dossier List:
- List of user's dossiers
- Each card shows:
  - Product name
  - Current step
  - Progress percentage
  - Link to dossier details
```

**SUSPENDED:**

```
⚠️ Your payment was unsuccessful.
Please complete your payment to access your dossier.

[Complete Payment] button
```

### Type Guards

```typescript
// types/user.ts
export type UserStatus = "PENDING" | "ACTIVE" | "SUSPENDED";

export interface UserProfile {
  id: string;
  status: UserStatus;
  // other fields
}

export function isActiveUser(
  user: UserProfile
): user is UserProfile & { status: "ACTIVE" } {
  return user.status === "ACTIVE";
}

export function isPendingUser(
  user: UserProfile
): user is UserProfile & { status: "PENDING" } {
  return user.status === "PENDING";
}

export function isSuspendedUser(
  user: UserProfile
): user is UserProfile & { status: "SUSPENDED" } {
  return user.status === "SUSPENDED";
}
```

### Status Badge Component

```typescript
const statusConfig = {
  PENDING: { color: "bg-yellow-500", label: "Processing" },
  ACTIVE: { color: "bg-green-500", label: "Active" },
  SUSPENDED: { color: "bg-red-500", label: "Payment Required" },
};

export function StatusBadge({ status }: { status: UserStatus }) {
  const config = statusConfig[status];
  return (
    <div className={`${config.color} px-3 py-1 rounded-full text-sm`}>
      {config.label}
    </div>
  );
}
```

### New Checkout Session for SUSPENDED Users

Create Server Action to generate new session:

```typescript
export async function createRetryCheckoutSession(orderId: string) {
  const order = await supabase
    .from("orders")
    .select("*, products(id, name, description), profiles(id)")
    .eq("id", orderId)
    .single();

  const session = await stripe.checkout.sessions.create({
    // Same as Story 1.8
    metadata: {
      order_id: orderId,
      user_id: order.profiles.id,
      product_id: order.products.id,
    },
  });

  return session.url;
}
```

### Design System (from architecture.md)

**Color Palette:**

- Main Background: `#191A1D`
- Surface: `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

**UI Framework:** Tailwind CSS with custom design tokens
**Language:** French UI (all messages in French)

### Testing

Testing standards from Story 1.1:

- Unit tests: Type guards, status conditions
- Integration tests: Middleware status checking
- Component tests: Status-based rendering
- E2E tests:
  - PENDING flow: register → see processing message
  - ACTIVE flow: webhook completes → full dashboard access
  - SUSPENDED flow: see banner → create retry session
- Mock Supabase profile queries
- Mock user authentication states

### Integration with Previous Stories

This story depends on:

- Story 1.3: Authentication system
- Story 1.7: Registration creates PENDING profile
- Story 1.9: Webhook updates status to ACTIVE

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - Aucune erreur rencontrée lors de l'implémentation. Correction d'une erreur TypeScript dans la Server Action pour gérer correctement les relations Supabase retournées comme tableaux.

### Completion Notes

- Types TypeScript créés dans `types/user.ts` avec UserStatus, UserProfile et les type guards (isActiveUser, isPendingUser, isSuspendedUser)
- Fonction `getProfile` créée dans `lib/profile.ts` pour récupérer le profil utilisateur avec le status
- Middleware mis à jour pour vérifier le status utilisateur sur toutes les routes `/dashboard/*` et le passer dans les headers
- Composant StatusBadge créé avec color coding : PENDING (jaune), ACTIVE (vert), SUSPENDED (rouge)
- Composants UI créés pour chaque status :
  - `PendingStatus` : Affiche le message de traitement avec indicateur de chargement
  - `SuspendedStatus` : Affiche le banner avec bouton "Compléter le paiement"
  - `ActiveStatus` : Placeholder pour la liste des dossiers (à implémenter dans une story future)
- Server Action `createRetryCheckoutSession` créée dans `app/actions/checkout.ts` pour générer un nouveau Checkout Session Stripe pour les utilisateurs SUSPENDED
- Page dashboard mise à jour pour afficher le contenu basé sur le status utilisateur avec rendu conditionnel
- Page profile créée dans `app/(protected)/dashboard/profile/page.tsx` pour permettre aux utilisateurs PENDING d'accéder à leur profil
- Tous les composants utilisent les type guards pour le rendu conditionnel sans layout shift
- Code validé : aucune erreur TypeScript ou linting

**Tâches restantes** :

- Implémentation complète de la liste des dossiers pour les utilisateurs ACTIVE (story future)
- Implémentation des détails de dossier (story future)
- Affichage des notifications (story future)
- Tests E2E pour le flow complet (nécessite l'implémentation complète du webhook handler dans story 1.9)

**Note importante** : La page profile est accessible à tous les utilisateurs authentifiés, y compris PENDING. L'accès aux dossiers est bloqué via le rendu conditionnel dans le dashboard.

### File List

- `partnersllc-app/types/user.ts` (créé)
- `partnersllc-app/lib/profile.ts` (créé)
- `partnersllc-app/middleware.ts` (modifié)
- `partnersllc-app/components/dashboard/StatusBadge.tsx` (créé)
- `partnersllc-app/components/dashboard/PendingStatus.tsx` (créé)
- `partnersllc-app/components/dashboard/SuspendedStatus.tsx` (créé)
- `partnersllc-app/components/dashboard/ActiveStatus.tsx` (créé)
- `partnersllc-app/app/actions/checkout.ts` (créé)
- `partnersllc-app/app/(protected)/dashboard/page.tsx` (modifié)
- `partnersllc-app/app/(protected)/dashboard/profile/page.tsx` (créé)

## QA Results

_Results from QA Agent review will be documented here._
