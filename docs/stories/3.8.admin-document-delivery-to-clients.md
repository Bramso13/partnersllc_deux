# Story 3.8: Admin Document Delivery to Clients

## Status

Ready for development

## Story

**As an** admin,
**I want** to configure admin steps in product workflows (e.g., "Dépot de l'EIN" for LLC products) and send documents to clients to complete these steps,
**so that** clients can track admin actions in their dossier workflow and receive important documents (contracts, certificates, EIN documents, etc.) as part of structured workflow steps.

## Acceptance Criteria

### Database Schema Updates

1. Add `step_type` column to `steps` table:
   - Type: `step_type` enum with values: 'CLIENT' (default), 'ADMIN'
   - Default value: 'CLIENT' for backward compatibility
   - Migration updates existing steps to 'CLIENT' type
   - Admin steps are steps where `step_type = 'ADMIN'` (e.g., "Dépot de l'EIN", "Filing confirmation")

### Workflow Configuration

2. In product workflow configuration UI (`/admin/products/[id]/workflow`):
   - Admins can create new steps with `step_type = 'ADMIN'`
   - Admin steps displayed with distinct visual indicator (badge/icon)
   - Admin steps can be added to workflow like regular steps
   - Admin steps appear in workflow sequence (e.g., Step 3: "Dépot de l'EIN")
   - Admin steps can have associated document types (optional)

### Admin Dossier View

3. In admin dossier detail page (`/admin/dossiers/[id]`):

   - Admin steps displayed in workflow section with special styling
   - For each incomplete admin step, show "Envoyer des documents" button
   - Button opens modal/pop-up for document selection and upload
   - Modal allows admin to:
     - Select from predefined document types (from `document_types` table for the product/step)
     - Upload new files on-the-fly (PDF, JPG, PNG, max 10MB)
     - Add multiple documents in one action
     - Optionally add a message/comment to accompany the documents
   - When admin submits documents for an admin step:
     - Documents uploaded to Supabase Storage: `{dossier_id}/admin-steps/{step_instance_id}/{timestamp}_{filename}`
     - Documents created with `step_instance_id` pointing to the admin step instance
     - Step instance marked as completed: `step_instances.completed_at = now()`
     - If all required documents uploaded, step automatically completes

4. Admin can also send documents manually (not tied to a step):
   - "Envoyer des documents" button available in actions section (separate from step-specific buttons)
   - These documents have `step_instance_id = NULL` (general admin delivery)
   - Stored in path: `{dossier_id}/admin-delivered/{timestamp}_{filename}`

### Client Dossier View

5. Client-side display of admin steps:

   - Admin steps appear in client's workflow view (same sequence as configured)
   - Admin steps displayed with distinct visual indicator (icon/badge showing "Action admin")
   - Status shown: "En attente" (pending), "En cours" (in progress), "Terminé" (completed)
   - When admin step is completed, client sees:
     - Step marked as completed with checkmark
     - Documents received from admin displayed in step section
     - Documents listed with name, upload date
     - "Voir" button to view document
     - "Télécharger" button to download document

6. Client-side display of manually sent documents (not tied to step):

   - Documents appear in separate section "Documents reçus" (or similar)
   - Displayed with document name/type, upload date
   - "Voir" and "Télécharger" buttons available

7. Document viewing/downloading uses secure route: `/api/dossiers/[id]/documents/[document_id]/download` (NOT publicUrl)

8. Secure download route:
   - Verifies user owns the dossier (RLS check)
   - Downloads file from Supabase Storage using admin client
   - Returns file with proper Content-Type and Content-Disposition headers
   - Implements same security pattern as `/api/admin/dossiers/[id]/documents/[document_id]/view`

### Events and Notifications

9. When documents sent for admin step:

   - Event created: `STEP_COMPLETED` event type (if step completed) with:
     - `entity_type`: 'STEP_INSTANCE'
     - `entity_id`: step_instance_id
     - `actor_type`: 'AGENT'
     - `actor_id`: admin's agent ID
     - `payload`: { step_name: "...", document_ids: [...], document_count: N }
   - Event created: `DOCUMENT_DELIVERED` event type with:
     - `entity_type`: 'DOSSIER'
     - `entity_id`: dossier_id
     - `actor_type`: 'AGENT'
     - `actor_id`: admin's agent ID
     - `payload`: { step_instance_id: "...", step_name: "...", document_ids: [...], document_count: N, message: "..." }

10. When documents sent manually (not tied to step):

    - Event created: `DOCUMENT_DELIVERED` event type with:
      - `entity_type`: 'DOSSIER'
      - `entity_id`: dossier_id
      - `actor_type`: 'AGENT'
      - `actor_id`: admin's agent ID
      - `payload`: { document_ids: [...], document_count: N, message: "..." }

11. Notification created for client:

    - `user_id`: dossier owner
    - `dossier_id`: target dossier
    - `title`: "Nouveaux documents disponibles" (or "Étape '{step_name}' terminée" if admin step)
    - `message`: "Votre conseiller vous a envoyé {N} document(s). Consultez-les dans votre dossier." (or step-specific message)
    - `template_code`: 'ADMIN_DOCUMENT_DELIVERED' or 'ADMIN_STEP_COMPLETED'
    - `action_url`: `/dashboard/dossier/{dossier_id}`
    - Channels: EMAIL, IN_APP (and optionally WhatsApp/SMS if user preferences allow)

12. Client sees notification in:

    - Notification bell with unread badge
    - Email inbox (if email notifications enabled)
    - In-app notification center

13. Client can click notification to navigate directly to dossier detail page

### Admin Features

14. Admin can see delivery history:
    - List of all documents sent to this dossier (both step-related and manual)
    - Sent date and time
    - Document names
    - Associated step (if applicable)
    - Whether client has viewed/downloaded (future enhancement - not in this story)

### Security

15. RLS policies ensure:
    - Clients can only view/download documents from their own dossiers
    - Admins can send documents to any dossier
    - Document download route verifies ownership before serving file
    - Admin steps visible to clients but clients cannot modify them

## Tasks / Subtasks

- [x] Add step_type column to steps table (AC: 1)
  - [x] Create migration: `021_add_step_type_to_steps.sql`
  - [x] Create enum type `step_type` with values: 'CLIENT', 'ADMIN'
  - [x] Add column `step_type` to `steps` table with default 'CLIENT'
  - [x] Update existing steps to 'CLIENT' type
  - [x] Update TypeScript types for Step interface
  - [x] Add constraint: `step_type IN ('CLIENT', 'ADMIN')`
- [x] Update workflow configuration UI for admin steps (AC: 2)
  - [x] Modify `components/admin/products/workflow/AddStepModal.tsx` or create new component
  - [x] Add "Step Type" selector: CLIENT or ADMIN
  - [x] When creating new step, allow setting step_type
  - [x] Display admin steps with distinct visual indicator (badge/icon) in workflow config
  - [x] Update `WorkflowStepCard` to show step type badge
  - [x] Update API endpoint `/api/admin/products/[id]/workflow` to handle step_type
- [x] Create admin document delivery modal component (AC: 3)
  - [x] Create `components/admin/dossier/SendDocumentsModal.tsx`
  - [x] Modal UI with:
    - Document type selector (dropdown from `document_types` for product/step)
    - File upload area (drag & drop or file picker)
    - Support multiple file selection
    - Optional message/comment textarea
    - "Envoyer" and "Annuler" buttons
  - [x] Validate file types (PDF, JPG, PNG) and size (max 10MB)
  - [x] Show upload progress for multiple files
  - [x] Display selected files list before submission
  - [x] Support both step-specific delivery (step_instance_id provided) and manual delivery (no step)
- [x] Update admin dossier detail page to show admin steps (AC: 3)
  - [x] Modify `components/admin/dossier/AdminDossierDetailContent.tsx` or similar
  - [x] Display admin steps in workflow section with distinct styling
  - [x] For each incomplete admin step, show "Envoyer des documents" button
  - [x] Button opens SendDocumentsModal with step_instance_id context
  - [x] When step completed, show checkmark and completed date
  - [x] Also add general "Envoyer des documents" button in actions section (for manual delivery)
- [x] Create API endpoint for document delivery (AC: 3, 4)
  - [x] Create `app/api/admin/dossiers/[id]/send-documents/route.ts`
  - [x] Endpoint accepts: `{ step_instance_id?: string, document_type_ids?: string[], files: File[], message?: string }`
  - [x] Verify admin authentication
  - [x] If `step_instance_id` provided:
    - Verify step_instance belongs to dossier
    - Verify step is admin step (step.step_type = 'ADMIN')
    - Upload files to: `{dossier_id}/admin-steps/{step_instance_id}/{timestamp}_{filename}`
    - Create documents with `step_instance_id` set
    - After documents created, check if step should be completed
    - If all required documents uploaded, mark step as completed: `step_instances.completed_at = now()`
  - [x] If `step_instance_id` is NULL (manual delivery):
    - Upload files to: `{dossier_id}/admin-delivered/{timestamp}_{filename}`
    - Create documents with `step_instance_id = NULL`
  - [x] Create `documents` records with status APPROVED
  - [x] Create `document_versions` records
  - [x] Handle both predefined types and ad-hoc uploads
  - [x] Return success with created document IDs and step completion status
- [x] Create secure document download route for clients (AC: 7, 8)
  - [x] Create `app/api/dossiers/[id]/documents/[document_id]/download/route.ts`
  - [x] Verify user authentication and dossier ownership (RLS check)
  - [x] Query document and verify it belongs to dossier
  - [x] Get file from Supabase Storage using admin client
  - [x] Return file with proper headers (Content-Type, Content-Disposition)
  - [x] Follow same pattern as `/api/admin/dossiers/[id]/documents/[document_id]/view`
- [x] Update client workflow view to display admin steps (AC: 5)
  - [x] Modify `components/workflow/WorkflowStepper.tsx` or similar
  - [x] Query step_instances and identify admin steps (via step.step_type = 'ADMIN')
  - [x] Display admin steps in workflow sequence with distinct visual indicator
  - [x] Show status: "En attente", "En cours", "Terminé"
  - [x] When admin step completed, display documents received in step section
  - [x] Documents displayed with name, upload date, view/download buttons
  - [x] Admin steps are read-only for clients (no action buttons)
- [x] Create client-side manual documents display section (AC: 6)
  - [x] Add "Documents reçus" section to `components/dashboard/DossierDetailContent.tsx` or similar
  - [x] Query documents where `step_instance_id IS NULL` and `uploaded_by_type = 'AGENT'`
  - [x] Display documents with:
    - Document name/type
    - Upload date (formatted)
    - "Voir" button (opens preview modal)
    - "Télécharger" button (calls download route)
  - [x] Visual distinction from workflow documents (different icon, badge, or section)
  - [x] Group admin-delivered documents separately
- [x] Implement document preview for clients (AC: 6)
  - [x] Reuse or extend existing `DocumentPreviewModal` component
  - [x] Preview uses secure download route (not publicUrl)
  - [x] Support PDF viewing (inline) and image viewing
  - [x] Show document metadata (name, size, upload date)
  - [x] Added "Récupérer mes documents" button for admin steps
  - [x] Documents displayed with view and download buttons
- [x] Create events for document delivery (AC: 9, 10)
  - [x] After documents created for admin step:
    - Create `DOCUMENT_DELIVERED` event with step_instance_id in payload
    - If step completed, create `STEP_COMPLETED` event
  - [x] After manual document delivery:
    - Create `DOCUMENT_DELIVERED` event (no step_instance_id)
  - [x] Event type: `DOCUMENT_DELIVERED` (add to enum if needed)
  - [x] Include document_ids array and count in payload
  - [x] Include optional message in payload
  - [x] Include step_instance_id and step_name if applicable
  - [x] Set actor_type: 'AGENT', actor_id: admin's agent ID
- [x] Create client notification (AC: 11, 12, 13)
  - [x] After documents created, create notification in `notifications` table
  - [x] If admin step completed: use template 'ADMIN_STEP_COMPLETED' with step name
  - [x] If manual delivery: use template 'ADMIN_DOCUMENT_DELIVERED'
  - [x] Use notification processor to create deliveries (EMAIL, IN_APP)
  - [x] Notification includes link to dossier detail page
  - [x] Notification appears in client's notification bell
  - [x] Email sent if user has email notifications enabled
  - [x] Clicking notification navigates to dossier detail page
- [x] Add delivery history to admin view (AC: 14)
  - [x] Query all admin-delivered documents for dossier (both step-related and manual)
  - [x] Display in admin dossier detail page (new section or existing section)
  - [x] Show: document name, sent date/time, sender (admin name), associated step (if applicable)
  - [x] Group by delivery date or show as list
  - [x] Distinguish between step-related documents and manual documents
- [x] Update RLS policies (AC: 15)
  - [x] Verify clients can SELECT documents from their own dossiers
  - [x] Verify admins can INSERT documents to any dossier
  - [x] Verify download route checks dossier ownership
  - [x] Test RLS policies with different user roles
- [x] Add DOCUMENT_DELIVERED to event types enum (AC: 9)
  - [x] Update database enum `event_type` to include 'DOCUMENT_DELIVERED'
  - [x] Update TypeScript types for events
  - [x] Update event timeline component to display this event type
- [x] Create notification templates (AC: 11)
  - [x] Add template code 'ADMIN_DOCUMENT_DELIVERED' for manual document delivery
  - [x] Add template code 'ADMIN_STEP_COMPLETED' for admin step completion
  - [x] Create email templates (if using template system)
  - [x] Templates include: document count, step name (if applicable), link to dossier, optional message
- [x] Update client dossier detail page (AC: 5, 6)
  - [x] Modify `app/(protected)/dashboard/dossier/[id]/DossierDetailContent.tsx`
  - [x] Update workflow display to show admin steps with distinct styling
  - [x] Add query for manually delivered documents (step_instance_id IS NULL)
  - [x] Render "Documents reçus" section with visual distinction
  - [x] Ensure admin steps and manual documents are clearly separated
  - [x] Ensure sections are visible and accessible

## Dev Notes

### Previous Story Insights

From Story 3.1 (Event-Driven Architecture):

- Events table structure: `entity_type`, `entity_id`, `event_type`, `actor_type`, `actor_id`, `payload`, `created_at`
- Event types enum includes various types; need to add `DOCUMENT_DELIVERED`
- Events are immutable (INSERT only, no UPDATE/DELETE)
- STEP_COMPLETED event already exists for workflow step completion

From Story 3.2 (Email Notification Delivery):

- Notification creation: `notifications` table with `user_id`, `dossier_id`, `title`, `message`, `template_code`, `payload`
- Notification processor automatically creates `notification_deliveries` for EMAIL channel
- Email templates use template codes (e.g., 'DOCUMENT_APPROVED', 'DOCUMENT_REJECTED')
- Need to add 'ADMIN_DOCUMENT_DELIVERED' and 'ADMIN_STEP_COMPLETED' template codes

From Story 3.5 (In-App Notification System):

- Notifications appear in notification bell component
- Client can click notification to navigate to related resource
- Notification includes `action_url` for navigation

From Story 3.6 (Automated Workflow Step Completion):

- Step instances have `completed_at` field that marks step completion
- Steps can be auto-completed or manually completed
- When step completed, `STEP_COMPLETED` event is created
- Next step can be automatically started after completion

From Story 4.5 (Admin Product Management):

- Workflow configuration UI allows admins to configure steps for products
- Steps are added via `product_steps` table linking `products` to `steps`
- Steps can have associated document types and custom fields
- Workflow configuration is saved via `/api/admin/products/[id]/workflow` endpoint

### Data Models

**Steps Table (updated):**

```typescript
interface Step {
  id: string;
  code: string; // Unique code
  label: string;
  description: string | null;
  position: number;
  step_type: "CLIENT" | "ADMIN"; // NEW: distinguishes client vs admin steps
  created_at: string;
}
```

**Documents Table (from database-v2.sql):**

```typescript
interface Document {
  id: string;
  dossier_id: string;
  document_type_id: string;
  step_instance_id: string | null; // NULL for manual admin delivery, set for admin step delivery
  status: "PENDING" | "APPROVED" | "REJECTED";
  current_version_id: string | null;
  created_at: string;
  updated_at: string;
}
```

**Step Instances Table:**

```typescript
interface StepInstance {
  id: string;
  dossier_id: string;
  step_id: string;
  started_at: string | null;
  completed_at: string | null; // Set when admin completes admin step
  validation_status: string | null;
  // ... other fields
}
```

**Document Versions Table:**

```typescript
interface DocumentVersion {
  id: string;
  document_id: string;
  file_url: string; // Path in Supabase Storage
  file_name: string;
  file_size_bytes: number;
  mime_type: string;
  uploaded_by_type: "USER" | "AGENT" | "SYSTEM";
  uploaded_by_id: string;
  version_number: number;
  uploaded_at: string;
}
```

**Notifications Table:**

```typescript
interface Notification {
  id: string;
  user_id: string;
  dossier_id: string | null;
  event_id: string | null;
  title: string;
  message: string;
  template_code: string | null; // 'ADMIN_DOCUMENT_DELIVERED'
  payload: Record<string, any>;
  action_url: string | null; // Link to dossier detail
  read_at: string | null;
  created_at: string;
}
```

[Source: database-v2.sql#steps, database-v2.sql#documents, database-v2.sql#document_versions, database-v2.sql#notifications, database-v2.sql#step_instances]

### Database Migration

**Migration: 021_add_step_type_to_steps.sql**

```sql
-- Create step_type enum
CREATE TYPE step_type AS ENUM ('CLIENT', 'ADMIN');

-- Add step_type column to steps table
ALTER TABLE steps
  ADD COLUMN step_type step_type NOT NULL DEFAULT 'CLIENT';

-- Update existing steps to CLIENT (already default, but explicit)
UPDATE steps SET step_type = 'CLIENT' WHERE step_type IS NULL;

-- Add constraint
ALTER TABLE steps
  ADD CONSTRAINT step_type_check CHECK (step_type IN ('CLIENT', 'ADMIN'));

-- Add index for filtering admin steps
CREATE INDEX idx_steps_step_type ON steps(step_type);
```

**Migration Notes:**

- Default value ensures backward compatibility
- Existing steps automatically set to 'CLIENT'
- New admin steps can be created with `step_type = 'ADMIN'`
- Index improves query performance when filtering by step type

[Source: database-v2.sql#steps - schema reference]

### API Specifications

**Admin Send Documents Endpoint:**

- Route: `POST /api/admin/dossiers/[id]/send-documents`
- Auth: Admin only (via `requireAdminAuth()`)
- Request Body:
  ```typescript
  {
    step_instance_id?: string; // Optional: if sending for admin step
    document_type_ids?: string[]; // Optional: predefined types
    files: File[]; // Files to upload
    message?: string; // Optional message to client
  }
  ```
- Response:
  ```typescript
  {
    success: boolean;
    document_ids: string[];
    step_completed?: boolean; // True if admin step was completed
    message?: string;
  }
  ```

**Client Document Download Endpoint:**

- Route: `GET /api/dossiers/[id]/documents/[document_id]/download`
- Auth: Client must own dossier (RLS check)
- Response: File stream with headers:
  - `Content-Type`: from `document_versions.mime_type`
  - `Content-Disposition`: `attachment; filename="{file_name}"`
  - `Cache-Control`: `private, max-age=3600`

[Source: app/api/admin/dossiers/[id]/documents/[document_id]/view/route.ts - similar pattern for secure file serving]

### Component Specifications

**SendDocumentsModal Component:**

- Location: `components/admin/dossier/SendDocumentsModal.tsx`
- Props:
  ```typescript
  {
    dossierId: string;
    productId: string; // To fetch document types
    stepInstanceId?: string; // Optional: if sending for admin step
    stepName?: string; // Optional: admin step name for display
    onClose: () => void;
    onSuccess: () => void;
  }
  ```
- Features:
  - If stepInstanceId provided: Show step name and context
  - Document type selector (dropdown from step or product)
  - File upload (drag & drop or file picker)
  - Multiple file selection
  - Optional message textarea
  - Upload progress indicator
  - Validation (file type, size)

**Client Documents Section:**

- Location: `components/dashboard/DossierDocumentsSection.tsx` (new) or extend existing
- Query: Documents where `step_instance_id IS NULL` AND `uploaded_by_type = 'AGENT'`
- Display: List with view/download buttons
- Visual distinction: Different icon/badge from workflow documents

[Source: components/documents/DocumentsTable.tsx - similar document display pattern]

### File Locations

**New Files to Create:**

- `partnersllc-app/supabase/migrations/021_add_step_type_to_steps.sql` - Migration for step_type column
- `app/api/admin/dossiers/[id]/send-documents/route.ts` - Admin document delivery endpoint
- `app/api/dossiers/[id]/documents/[document_id]/download/route.ts` - Client document download endpoint
- `components/admin/dossier/SendDocumentsModal.tsx` - Admin modal for sending documents
- `components/dashboard/AdminDeliveredDocumentsSection.tsx` - Client view of manually delivered documents

**Files to Modify:**

- `partnersllc-app/database-v2.sql` - Add step_type column to steps table (or via migration)
- `partnersllc-app/types/products.ts` - Update Step interface to include step_type
- `components/admin/products/workflow/AddStepModal.tsx` - Add step type selector
- `components/admin/products/workflow/WorkflowStepCard.tsx` - Display step type badge
- `components/admin/products/workflow/WorkflowConfigContent.tsx` - Handle step_type in workflow config
- `app/api/admin/products/[id]/workflow/route.ts` - Handle step_type in API
- `components/admin/dossier/AdminDossierDetailContent.tsx` - Display admin steps with send buttons
- `components/workflow/WorkflowStepper.tsx` - Display admin steps in client view
- `app/(protected)/dashboard/dossier/[id]/DossierDetailContent.tsx` - Add admin-delivered documents section
- `partnersllc-app/database-v2.sql` or migration - Add `DOCUMENT_DELIVERED` to event_type enum
- `lib/notifications/types.ts` - Add 'ADMIN_DOCUMENT_DELIVERED' and 'ADMIN_STEP_COMPLETED' template codes

[Source: docs/architecture.md#unified-project-structure - file organization patterns]

### Testing Requirements

**Unit Tests:**

- Document upload validation (file type, size)
- Document creation with correct fields
- Event creation with correct payload
- Notification creation with correct data

**Integration Tests:**

- Admin can send documents to dossier
- Documents appear in client view
- Secure download route verifies ownership
- Notification sent to client
- RLS policies prevent unauthorized access

**E2E Tests:**

- Admin sends documents → Client receives notification → Client views documents → Client downloads document
- Verify notification appears in bell and email
- Verify documents appear in correct section
- Verify download works with proper authentication

[Source: docs/architecture.md#testing-strategy - testing patterns]

### Technical Constraints

**Storage:**

- Supabase Storage bucket: `dossier-documents`
- Path patterns:
  - Admin step documents: `{dossier_id}/admin-steps/{step_instance_id}/{timestamp}_{filename}`
  - Manual admin delivery: `{dossier_id}/admin-delivered/{timestamp}_{filename}`
- File size limit: 10MB per file
- Allowed types: PDF, JPG, PNG

**Security:**

- Download route MUST verify dossier ownership (RLS)
- Never use publicUrl for client document access
- Use admin client for file retrieval, then serve to authenticated client
- Follow same pattern as `/api/admin/dossiers/[id]/documents/[document_id]/view`

**Notifications:**

- Use existing notification processor (Story 3.2)
- Create notification with template_code: 'ADMIN_DOCUMENT_DELIVERED'
- Notification processor handles EMAIL and IN_APP delivery automatically
- Include `action_url` for navigation to dossier

[Source: app/api/admin/dossiers/[id]/documents/[document_id]/view/route.ts - secure file serving pattern]

### Project Structure Notes

- Follow existing patterns from Story 2.3 (Document Upload) for file handling
- Follow existing patterns from Story 3.2 (Email Notifications) for notification creation
- Follow existing patterns from Story 4.5 (Admin Product Management) for workflow configuration
- Follow existing patterns from Story 3.6 (Automated Step Completion) for step completion logic
- Reuse existing document preview modal components where possible
- Admin actions should be in `app/api/admin/` routes
- Client actions should be in `app/api/` or `app/(protected)/` routes
- Workflow configuration UI follows existing patterns in `components/admin/products/workflow/`

**Admin Step Examples:**

- "Dépot de l'EIN" (LLC Formation)
- "Filing Confirmation" (Company Registration)
- "Certificate Delivery" (Various products)
- "Bank Account Opening" (Banking services)

[Source: docs/architecture/unified-project-structure.md - project organization]

## Testing

### Testing Standards

**Test File Location:**

- Unit tests: `__tests__/unit/` (co-located with components)
- Integration tests: `__tests__/integration/`
- E2E tests: `__tests__/e2e/`

**Testing Framework:**

- Unit: Vitest
- Integration: Vitest + Supabase test client
- E2E: Playwright

**Test Patterns:**

- Mock Supabase client for unit tests
- Use test database for integration tests
- Test RLS policies with different user roles
- Verify file upload/download flows
- Test notification delivery

**Specific Test Cases:**

1. Admin can create admin steps in workflow configuration
2. Admin steps appear in workflow with distinct visual indicator
3. Admin can send documents for admin step (step_instance_id set)
4. Admin step completes when documents sent
5. Admin can send documents manually (step_instance_id NULL)
6. Multiple files can be uploaded in one action
7. Files are stored in correct storage path (admin-steps vs admin-delivered)
8. Documents created with correct status (APPROVED)
9. Events created with correct payload (STEP_COMPLETED if step completed, DOCUMENT_DELIVERED)
10. Notification created and delivered to client (step-specific or general)
11. Client can view admin steps in workflow (read-only)
12. Client can view documents received for admin steps
13. Client can view manually delivered documents
14. Client can download documents via secure route
15. Download route verifies dossier ownership
16. RLS prevents unauthorized access
17. Notification appears in bell and email
18. Clicking notification navigates to dossier
19. Admin can see delivery history (both step-related and manual)

[Source: docs/architecture.md#testing-strategy]

## Change Log

| Date       | Version | Description                                     | Author             |
| ---------- | ------- | ----------------------------------------------- | ------------------ |
| 2026-01-XX | 1.0     | Initial story creation with admin steps support | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

- Migration créée pour ajouter step_type à la table steps
- Migration créée pour ajouter DOCUMENT_DELIVERED à l'enum event_type
- Migration créée pour RLS policies (agents peuvent insérer documents)
- Types TypeScript mis à jour pour Step et EventType
- EventTimeline mis à jour pour afficher DOCUMENT_DELIVERED
- API /api/admin/steps mise à jour pour accepter step_type
- AddStepModal mis à jour avec sélecteur step_type
- WorkflowStepCard mis à jour pour afficher badge Admin
- SendDocumentsModal créé avec upload multiple, validation, sélection types
- API /api/admin/dossiers/[id]/send-documents créé avec gestion complète
- AdminStepsSection créé pour afficher les admin steps avec boutons d'envoi
- AdminActionsSidebar mis à jour avec bouton livraison manuelle
- Route de téléchargement sécurisée créée pour clients
- WorkflowStepper mis à jour pour afficher les admin steps avec style distinct
- WorkflowStepper: Ajout bouton "Récupérer mes documents" pour admin steps complétés
- WorkflowStepper: Filtrage des documents pour ne montrer que ceux uploadés par agents
- ProgressCard mis à jour pour afficher badge Admin et bouton "Récupérer mes documents"
- AdminDeliveredDocumentsSection créé pour documents manuellement livrés
- AdminDeliveryHistorySection créé pour historique admin
- Templates de notifications créés (ADMIN_DOCUMENT_DELIVERED, ADMIN_STEP_COMPLETED)
- Events et notifications automatiquement créés lors de la livraison
- API /api/workflow/dossier-documents mise à jour pour retourner uploaded_by_type

### File List

**Nouveaux fichiers créés:**

- `partnersllc-app/supabase/migrations/021_add_step_type_to_steps.sql` - Migration pour step_type
- `partnersllc-app/supabase/migrations/022_add_document_delivered_event_type.sql` - Migration pour DOCUMENT_DELIVERED
- `partnersllc-app/components/admin/dossier/SendDocumentsModal.tsx` - Modal pour envoyer des documents
- `partnersllc-app/app/api/admin/dossiers/[id]/send-documents/route.ts` - Endpoint API pour livraison de documents
- `partnersllc-app/components/admin/dossier/AdminStepsSection.tsx` - Section pour afficher les admin steps
- `partnersllc-app/app/api/admin/dossiers/[id]/admin-steps/route.ts` - API pour récupérer les admin steps
- `partnersllc-app/app/api/dossiers/[id]/documents/[document_id]/download/route.ts` - Route de téléchargement sécurisée pour clients
- `partnersllc-app/components/dashboard/AdminDeliveredDocumentsSection.tsx` - Section pour documents manuellement livrés
- `partnersllc-app/app/api/dossiers/[id]/admin-delivered-documents/route.ts` - API pour récupérer les documents manuellement livrés
- `partnersllc-app/components/admin/dossier/AdminDeliveryHistorySection.tsx` - Section historique de livraison admin
- `partnersllc-app/app/api/admin/dossiers/[id]/delivery-history/route.ts` - API pour historique de livraison
- `partnersllc-app/supabase/migrations/023_admin_document_delivery_rls.sql` - Migration RLS pour livraison de documents admin

**Fichiers modifiés:**

- `partnersllc-app/types/products.ts` - Ajout de step_type à l'interface Step
- `partnersllc-app/lib/events.ts` - Ajout de DOCUMENT_DELIVERED et DocumentDeliveredPayload
- `partnersllc-app/components/EventTimeline.tsx` - Ajout du cas DOCUMENT_DELIVERED
- `partnersllc-app/app/api/admin/steps/route.ts` - Support de step_type dans POST
- `partnersllc-app/components/admin/products/workflow/AddStepModal.tsx` - Ajout sélecteur step_type
- `partnersllc-app/components/admin/products/workflow/WorkflowStepCard.tsx` - Badge Admin pour admin steps
- `partnersllc-app/components/admin/dossier/AdminActionsSidebar.tsx` - Ajout bouton "Envoyer des documents" pour livraison manuelle
- `partnersllc-app/app/(protected)/admin/dossiers/[id]/AdminDossierDetailContent.tsx` - Ajout AdminStepsSection
- `partnersllc-app/lib/workflow.ts` - Ajout step_type à l'interface Step
- `partnersllc-app/components/workflow/WorkflowStepper.tsx` - Support des admin steps avec affichage distinct
- `partnersllc-app/app/(protected)/dashboard/dossier/[id]/DossierDetailContent.tsx` - Ajout AdminDeliveredDocumentsSection
- `partnersllc-app/lib/notifications/email-templates.ts` - Ajout templates ADMIN_DOCUMENT_DELIVERED et ADMIN_STEP_COMPLETED
- `partnersllc-app/lib/notifications/processor.ts` - Support des nouveaux templates dans le processeur
- `partnersllc-app/lib/notifications/in-app.ts` - Ajout icônes et couleurs pour les nouveaux templates
- `partnersllc-app/lib/workflow.ts` - Ajout step_type à l'interface Step
- `partnersllc-app/components/dashboard/ProgressCard.tsx` - Support admin steps avec badge et bouton "Récupérer mes documents"
- `partnersllc-app/app/api/workflow/dossier-documents/route.ts` - Ajout uploaded_by_type dans la réponse

## QA Results

_To be filled by QA Agent_
