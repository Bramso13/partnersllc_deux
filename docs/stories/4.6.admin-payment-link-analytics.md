# Story 4.6: Admin Payment Link Analytics

## Status

Done

## Story

**As an** admin,
**I want** to track payment link performance with conversion metrics and usage analytics,
**so that** I understand which prospects are converting and optimize outreach strategies.

## Acceptance Criteria

1. Payment links page at `/admin/payment-links` displays enhanced table with analytics
2. Table columns: Token (truncated, copyable), Prospect Email, Product, Created Date, Expires Date, Status (ACTIVE, USED, EXPIRED), Used Date, Converted (Yes/No)
3. Status badges color-coded: ACTIVE (green), USED (blue), EXPIRED (gray)
4. Converted column shows checkmark if payment completed, X if user registered but didn't pay
5. Filters: Status (multi-select), Product (multi-select), Date Range (created date)
6. Search bar filters by prospect email
7. Sort by: Created Date, Expiration Date, Used Date
8. Analytics summary cards above table:
   - Total Links Created (with date range filter)
   - Active Links (not yet used, not expired)
   - Conversion Rate (USED links with successful payment / Total USED links)
   - Average Time to Conversion (time from link creation to payment completion)
9. Clicking link row expands details: Full token URL (copyable), User who used it (if used), Order status, Payment amount, Timeline of events
10. "Generate Link" button prominently placed, opens creation form (from Epic 1)
11. Bulk actions: Expire selected links (mark as EXPIRED, disable further use)
12. Export functionality: CSV export of all links with full details for external analysis
13. Conversion funnel visualization (optional): Link Created → Link Clicked → Registration → Payment
14. Email reminders for admins: Daily digest of unused links expiring soon

## Tasks / Subtasks

- [x] Build payment links listing page (AC: 1, 2, 3)
  - [x] Create page at `/admin/payment-links`
  - [x] Query all payment links from database
  - [x] Build table with all required columns
  - [x] Implement status badge color-coding
  - [x] Format token as truncated, copyable value
  - [x] Add conversion indicator (checkmark/X)
- [x] Implement table filters (AC: 5, 6, 7)
  - [x] Add Status multi-select filter (ACTIVE, USED, EXPIRED)
  - [x] Add Product multi-select filter
  - [x] Add Date Range filter for created date
  - [x] Add email search bar
  - [x] Implement sort by Created Date, Expiration Date, Used Date
  - [x] Apply all filters to table query
- [x] Build analytics summary cards (AC: 8)
  - [x] Create card component for metrics display
  - [x] Calculate Total Links Created count
  - [x] Calculate Active Links count
  - [x] Calculate Conversion Rate percentage
  - [x] Calculate Average Time to Conversion (in days/hours)
  - [x] Apply date range filter to all calculations
  - [x] Display with icons and formatted numbers
- [x] Implement row expansion for details (AC: 9)
  - [x] Add expand/collapse icon to each row
  - [x] Build details panel showing:
    - Full payment link token/URL (with copy button)
    - User who used the link (if used)
    - Order status and amount
    - Timeline of events (Created, Used, Paid, etc.)
  - [x] Format timeline with timestamps
- [x] Build "Generate Link" button (AC: 10)
  - [x] Add prominent button at top of page
  - [x] Open payment link creation modal (from Epic 1 Story)
  - [x] Create new link on form submission
  - [x] Refresh table after creation
- [x] Implement bulk expiration (AC: 11)
  - [x] Add checkboxes for selecting multiple links
  - [x] Show bulk action bar when links selected
  - [x] Add "Expire Selected" button
  - [x] Mark selected links as EXPIRED in database
  - [x] Disable further use of expired links
  - [x] Show success notification
- [x] Build CSV export functionality (AC: 12)
  - [x] Add "Export" button to page
  - [x] Generate CSV with all link data
  - [x] Include all columns plus additional details
  - [x] Trigger download with filename including date
  - [x] Format data appropriately for Excel
- [x] Implement conversion funnel visualization (AC: 13)
  - [x] Create funnel chart component
  - [x] Query conversion data: Created → Clicked → Registered → Paid
  - [x] Build funnel chart using charting library
  - [x] Show counts and percentages at each stage
  - [x] Make interactive/drill-downable (optional)
- [ ] Set up expiration reminder emails (AC: 14)
  - [ ] Create daily cron job to check expiring links
  - [ ] Query links expiring in next 24 hours
  - [ ] Build email template with link details
  - [ ] Send email to admin users
  - [ ] Include links summary and action items

## Dev Notes

### Database Schema Context

**payment_links table:**

```
- id: uuid (PK)
- token: text (unique, 32-char secure token)
- prospect_email: text
- product_id: uuid (FK)
- created_at: timestamp
- expires_at: timestamp
- used_at: timestamp (nullable)
- status: enum (ACTIVE, USED, EXPIRED)
- created_by: uuid (admin user)
```

**orders/payments linked to payment_links:**

- `order.payment_link_id` → payment_links.id
- Track payment completion to measure conversion

### Payment Link Status Logic

- **ACTIVE**: Created, not yet used, not expired
- **USED**: Token clicked and user registered
- **EXPIRED**: expires_at timestamp passed or manually expired

### Conversion Rate Calculation

```sql
SELECT
  COUNT(*) FILTER (WHERE payments.status = 'PAID') as converted_count,
  COUNT(*) as total_used_links,
  ROUND(
    COUNT(*) FILTER (WHERE payments.status = 'PAID')::numeric
    / COUNT(*) * 100,
    2
  ) as conversion_rate
FROM payment_links pl
LEFT JOIN orders o ON pl.id = o.payment_link_id
LEFT JOIN payments p ON o.id = p.order_id
WHERE pl.status = 'USED'
  AND pl.created_at >= $1  -- date range start
  AND pl.created_at <= $2  -- date range end
```

### Average Time to Conversion

```sql
SELECT
  AVG(EXTRACT(EPOCH FROM (p.created_at - pl.created_at))/3600) as avg_hours,
  AVG(EXTRACT(EPOCH FROM (p.created_at - pl.created_at))/86400) as avg_days
FROM payment_links pl
JOIN orders o ON pl.id = o.payment_link_id
JOIN payments p ON o.id = p.order_id
WHERE p.status = 'PAID'
  AND pl.created_at >= $1
  AND pl.created_at <= $2
```

### Funnel Data Query

```sql
SELECT
  COUNT(DISTINCT pl.id) as created_count,
  COUNT(DISTINCT CASE WHEN pl.used_at IS NOT NULL THEN pl.id END) as clicked_count,
  COUNT(DISTINCT CASE WHEN EXISTS (
    SELECT 1 FROM orders o WHERE o.payment_link_id = pl.id
  ) THEN pl.id END) as registered_count,
  COUNT(DISTINCT CASE WHEN EXISTS (
    SELECT 1 FROM payments p
    JOIN orders o ON p.order_id = o.id
    WHERE o.payment_link_id = pl.id
    AND p.status = 'PAID'
  ) THEN pl.id END) as paid_count
FROM payment_links pl
WHERE pl.created_at >= $1 AND pl.created_at <= $2
```

### Analytics Cards Layout

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│ Total Links  │ Active Links │ Conversion   │ Avg Time to  │
│   1,234      │     234      │  45.6%       │ 3.2 days     │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

### Token Display and Copy

- Truncate token in table: "abc123def456...xyz789"
- Show full token in expanded details
- Add copy button next to full token
- Copy to clipboard on button click

### CSV Export Format

```
Token,Email,Product,Created Date,Expires Date,Status,Used Date,Converted,Order ID,Payment Amount
abc123def456...xyz789,john@example.com,LLC Formation,2026-01-01,2026-02-01,USED,2026-01-05,Yes,ORD-123,999.99
...
```

### Expiration Reminder Email Template

Subject: "Payment Links Expiring Soon (Daily Digest)"

Body:

```
Dear Admin,

The following payment links expire in the next 24 hours:

[Table with: Email, Product, Expires At, Status]
- john@example.com | LLC Formation | 2026-01-07 14:30 | ACTIVE
- jane@example.com | Dubai Company | 2026-01-08 09:15 | ACTIVE

Total expiring: 5 links
Active (not yet used): 3 links
Expired: 2 links

Action Items:
- Follow up with prospects on unused links
- Consider extending expiration if needed

Best regards,
Partners VRAI Platform
```

### Funnel Visualization (Recharts)

```tsx
<BarChart data={funnelData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="stage" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Bar dataKey="count" fill="#00F0FF" />
  <Bar dataKey="percentage" fill="#4ADE80" />
</BarChart>
```

### Daily Cron Job Implementation

Use `pg_cron` extension in PostgreSQL:

```sql
SELECT cron.schedule('email-expiring-links', '0 9 * * *', 'SELECT send_expiring_links_email()');
```

Or use external job queue (Bull, pg-boss).

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/admin/payment-link-analytics/`
**Coverage Requirements:**

- Payment link table display and formatting
- Filter functionality (status, product, date range, search)
- Analytics calculation (conversion rate, avg time, etc.)
- Row expansion and details display
- Bulk expiration operations
- CSV export generation and download
- Funnel chart rendering and data
- Email reminder schedule and content

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be documented here._
