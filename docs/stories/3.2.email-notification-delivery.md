# Story 3.2: Email Notification Delivery System

## Status

Ready for Review

## Story

**As a** user,
**I want** to receive email notifications for important updates (document reviewed, step completed, payment received),
**so that** I stay informed about my dossier progress even when not logged into the platform.

## Acceptance Criteria

1. Email provider configured (nodemailer) with config in environment variables
2. Email service module created (`lib/notifications/email.ts`) with `sendEmail(to, subject, html, text)` function
3. Email templates created for each notification type using template engine (Handlebars or React Email):
   - Welcome email (after payment)
   - Document upload confirmation
   - Document approved notification
   - Document rejected notification (with reason)
   - Step completed notification
   - Payment reminder (for SUSPENDED users)
4. Edge Function or background job processes new `notifications` records filtering `channel: EMAIL`
5. For each email notification, `notification_deliveries` record created with `status: PENDING`
6. Email sent via provider API with error handling (retry up to 3 times with exponential backoff)
7. Successful send updates delivery record: `status: SENT`, `sent_at: now()`, `provider_message_id`
8. Failed send updates delivery record: `status: FAILED`, `error_message`, increments `retry_count`
9. Provider webhook (if supported) updates delivery status for opens/clicks (optional enhancement)
10. Emails include unsubscribe link (future: notification preferences page)
11. Test mode uses email capture service (MailHog, Ethereal) for development
12. E2E test verifies email sent when document is approved

## Tasks / Subtasks

- [x] Configure email provider (AC: 1)
  - [x] Install nodemailer package
  - [x] Configure SMTP settings (host, port, auth) in environment variables
  - [x] Add nodemailer configuration for production and test modes
  - [x] Verify SMTP connectivity
- [x] Create email service module (AC: 2)
  - [x] Create `lib/notifications/email.ts`
  - [x] Implement `sendEmail(to, subject, html, text)` function
  - [x] Add error handling and logging
  - [x] Create type definitions for email service
- [x] Create email templates (AC: 3)
  - [x] Welcome email template (after payment)
  - [x] Document upload confirmation template
  - [x] Document approved notification template
  - [x] Document rejected notification template (with reason)
  - [x] Step completed notification template
  - [x] Payment reminder template for SUSPENDED users
  - [x] Test template rendering
- [x] Create notification processor (AC: 4, 5)
  - [x] Create Edge Function or background job to process notifications
  - [x] Filter notifications by `channel: EMAIL`
  - [x] Create `notification_deliveries` record with status PENDING (AC: 5)
  - [x] Pass to email service for sending
- [x] Implement retry logic (AC: 6, 8)
  - [x] Implement retry mechanism with exponential backoff (up to 3 retries)
  - [x] Update delivery record on retry: increment `retry_count`
  - [x] Update delivery record on failure: `status: FAILED`, `error_message`
  - [x] Log failed attempts for debugging
- [x] Update delivery records on success (AC: 7)
  - [x] Update `notification_deliveries` record: `status: SENT`
  - [x] Set `sent_at: now()`
  - [x] Capture `provider_message_id` from API response
- [ ] Add webhook integration (AC: 9)
  - [ ] Configure provider webhook endpoint (if supported)
  - [ ] Implement webhook handler for open/click events
  - [ ] Update delivery status based on webhook events
- [x] Add unsubscribe functionality (AC: 10)
  - [x] Add unsubscribe link to all email templates
  - [x] Create unsubscribe handler endpoint
  - [x] Document future notification preferences page
- [x] Configure test mode (AC: 11)
  - [x] Configure Ethereal or MailHog for development
  - [x] Create test email provider configuration
  - [x] Document local testing setup
- [x] Create E2E test (AC: 12)
  - [x] Create test that uploads all documents
  - [x] Agent approves a document
  - [x] Verify email notification sent to user
  - [x] Check email content contains document approval message

## Dev Notes

### Email Provider Configuration

**Nodemailer:**

- Package: `nodemailer` (Node.js email library)
- Supports: SMTP, SendGrid SMTP, Gmail, Ethereal (test), MailHog (test), and more
- Configuration via environment variables:
  - `SMTP_HOST`: SMTP server hostname
  - `SMTP_PORT`: SMTP port (usually 587 for TLS, 465 for SSL)
  - `SMTP_SECURE`: Use SSL/TLS (true/false)
  - `SMTP_USER`: SMTP username/email
  - `SMTP_PASS`: SMTP password
  - `SMTP_FROM`: Default from email address
- Features: Flexible, supports multiple providers, easy testing with Ethereal
- Setup: Configure SMTP credentials based on your email provider (SendGrid SMTP, Gmail, etc.)

### Email Templates

All templates should follow these conventions:

- Include branding/logo
- Use HTML5 email-safe styling (inline CSS)
- Include company name and contact info in footer
- French language for all text (users are French-speaking)
- Professional styling matching design system

**Template Variables:**

- User name
- Dossier identifier
- Document details (type, status)
- Action links (View dossier, Pay now)
- Relative timestamps

### Email Service Implementation

```typescript
// lib/notifications/email.ts
import nodemailer from "nodemailer";

export async function sendEmail(
  to: string,
  subject: string,
  html: string,
  text: string,
  from?: string
) {
  // Create nodemailer transporter
  // Validate email format
  // Add retry logic with exponential backoff
  // Log send attempt
  // Return message ID from nodemailer response or throw error
}
```

### Notification Processing Flow

1. Event occurs (document approved, payment received, etc.)
2. Notification record created with `channel: EMAIL`
3. Edge Function triggers on notification INSERT (Story 3.2)
4. Email service sends via provider API
5. Delivery record updated with status
6. Webhook (optional) tracks open/click events

### Test Environment Setup

For development, use Ethereal Email (free service):

- Create test account at ethereal.email
- Use test SMTP credentials in development environment
- All emails captured in Ethereal dashboard
- No risk of sending to real users

### Testing Standards

- **Test location:** `__tests__/integration/email-notifications.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Mock email provider, verify calls, check database updates
- **Specific requirements:**
  - Verify email service sends on notification processor trigger
  - Verify PENDING delivery record created before send
  - Verify SENT status updated after successful send
  - Verify retry logic on provider errors
  - Verify template rendering with variables
  - E2E test: Document approval → Email sent → Email content verified

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

N/A - No critical debugging issues encountered during implementation

### Completion Notes

1. **Email Provider**: Implemented using nodemailer instead of SendGrid/Resend as per updated requirements. Supports both production SMTP and test mode (Ethereal/MailHog).

2. **Email Service Module**: Created `lib/notifications/email.ts` with:
   - `sendEmail()` function with retry logic (up to 3 retries with exponential backoff)
   - Automatic test mode detection (Ethereal when `EMAIL_TEST_MODE=true`)
   - Email validation and error handling
   - Connection verification utility

3. **Email Templates**: Created `lib/notifications/email-templates.ts` with all 6 required templates:
   - Welcome email
   - Document upload confirmation
   - Document approved
   - Document rejected (with reason)
   - Step completed
   - Payment reminder
   - All templates in French with unsubscribe links

4. **Notification Processor**: Created `lib/notifications/processor.ts` with:
   - `processEmailNotification()` - processes single notification
   - `processPendingEmailNotifications()` - batch processing
   - Automatic delivery record creation/updates
   - Integration with email templates based on `template_code`

5. **Database Migration**: Created `020_email_notification_delivery.sql`:
   - Trigger to auto-create EMAIL delivery records when notifications are created
   - Function to get user email from auth.users
   - Index for optimized pending deliveries query

6. **API Routes**:
   - `/api/notifications/process-email` - Process single or batch notifications
   - `/api/notifications/unsubscribe` - Unsubscribe handler (basic implementation)

7. **Testing**:
   - Created E2E test suite in `__tests__/integration/email-notifications.test.ts`
   - Documentation for test setup in `docs/email-testing-setup.md`

8. **Webhook Integration**: Not implemented (marked as optional enhancement in AC: 9)

### File List

**Created Files:**
- `partnersllc-app/lib/notifications/email.ts` - Email service module
- `partnersllc-app/lib/notifications/email-templates.ts` - Email templates
- `partnersllc-app/lib/notifications/processor.ts` - Notification processor
- `partnersllc-app/app/api/notifications/process-email/route.ts` - API route for processing
- `partnersllc-app/app/api/notifications/unsubscribe/route.ts` - Unsubscribe endpoint
- `partnersllc-app/supabase/migrations/020_email_notification_delivery.sql` - Database migration
- `partnersllc-app/__tests__/integration/email-notifications.test.ts` - E2E tests
- `partnersllc-app/docs/email-testing-setup.md` - Testing documentation

**Modified Files:**
- `partnersllc-app/package.json` - Added nodemailer and @types/nodemailer dependencies
- `docs/stories/3.2.email-notification-delivery.md` - Updated Dev Notes and task checkboxes

## QA Results

_Results from QA Agent review will be documented here._
