# Story 3.2: Email Notification Delivery System

## Status

Draft

## Story

**As a** user,
**I want** to receive email notifications for important updates (document reviewed, step completed, payment received),
**so that** I stay informed about my dossier progress even when not logged into the platform.

## Acceptance Criteria

1. Email provider configured (SendGrid or Resend) with API key in environment variables
2. Email service module created (`lib/notifications/email.ts`) with `sendEmail(to, subject, html, text)` function
3. Email templates created for each notification type using template engine (Handlebars or React Email):
   - Welcome email (after payment)
   - Document upload confirmation
   - Document approved notification
   - Document rejected notification (with reason)
   - Step completed notification
   - Payment reminder (for SUSPENDED users)
4. Edge Function or background job processes new `notifications` records filtering `channel: EMAIL`
5. For each email notification, `notification_deliveries` record created with `status: PENDING`
6. Email sent via provider API with error handling (retry up to 3 times with exponential backoff)
7. Successful send updates delivery record: `status: SENT`, `sent_at: now()`, `provider_message_id`
8. Failed send updates delivery record: `status: FAILED`, `error_message`, increments `retry_count`
9. Provider webhook (if supported) updates delivery status for opens/clicks (optional enhancement)
10. Emails include unsubscribe link (future: notification preferences page)
11. Test mode uses email capture service (MailHog, Ethereal) for development
12. E2E test verifies email sent when document is approved

## Tasks / Subtasks

- [ ] Configure email provider (AC: 1)
  - [ ] Choose provider: SendGrid or Resend
  - [ ] Create account/API key
  - [ ] Add API key to environment variables
  - [ ] Verify API connectivity
- [ ] Create email service module (AC: 2)
  - [ ] Create `lib/notifications/email.ts`
  - [ ] Implement `sendEmail(to, subject, html, text)` function
  - [ ] Add error handling and logging
  - [ ] Create type definitions for email service
- [ ] Create email templates (AC: 3)
  - [ ] Welcome email template (after payment)
  - [ ] Document upload confirmation template
  - [ ] Document approved notification template
  - [ ] Document rejected notification template (with reason)
  - [ ] Step completed notification template
  - [ ] Payment reminder template for SUSPENDED users
  - [ ] Test template rendering
- [ ] Create notification processor (AC: 4, 5)
  - [ ] Create Edge Function or background job to process notifications
  - [ ] Filter notifications by `channel: EMAIL`
  - [ ] Create `notification_deliveries` record with status PENDING (AC: 5)
  - [ ] Pass to email service for sending
- [ ] Implement retry logic (AC: 6, 8)
  - [ ] Implement retry mechanism with exponential backoff (up to 3 retries)
  - [ ] Update delivery record on retry: increment `retry_count`
  - [ ] Update delivery record on failure: `status: FAILED`, `error_message`
  - [ ] Log failed attempts for debugging
- [ ] Update delivery records on success (AC: 7)
  - [ ] Update `notification_deliveries` record: `status: SENT`
  - [ ] Set `sent_at: now()`
  - [ ] Capture `provider_message_id` from API response
- [ ] Add webhook integration (AC: 9)
  - [ ] Configure provider webhook endpoint (if supported)
  - [ ] Implement webhook handler for open/click events
  - [ ] Update delivery status based on webhook events
- [ ] Add unsubscribe functionality (AC: 10)
  - [ ] Add unsubscribe link to all email templates
  - [ ] Create unsubscribe handler endpoint
  - [ ] Document future notification preferences page
- [ ] Configure test mode (AC: 11)
  - [ ] Configure Ethereal or MailHog for development
  - [ ] Create test email provider configuration
  - [ ] Document local testing setup
- [ ] Create E2E test (AC: 12)
  - [ ] Create test that uploads all documents
  - [ ] Agent approves a document
  - [ ] Verify email notification sent to user
  - [ ] Check email content contains document approval message

## Dev Notes

### Email Provider Configuration

**SendGrid:**
- API endpoint: `https://api.sendgrid.com/v3/mail/send`
- Requires: API key in environment as `SENDGRID_API_KEY`
- Features: Good deliverability, webhook support, testing tools
- Setup: Create Free/Paid account at sendgrid.com

**Resend:**
- API endpoint: `https://api.resend.com/emails`
- Requires: API key in environment as `RESEND_API_KEY`
- Features: Modern API, developer-friendly, webhook support
- Setup: Create account at resend.com

### Email Templates

All templates should follow these conventions:
- Include branding/logo
- Use HTML5 email-safe styling (inline CSS)
- Include company name and contact info in footer
- French language for all text (users are French-speaking)
- Professional styling matching design system

**Template Variables:**
- User name
- Dossier identifier
- Document details (type, status)
- Action links (View dossier, Pay now)
- Relative timestamps

### Email Service Implementation

```typescript
// lib/notifications/email.ts
import { sendgrid } from '@sendgrid/mail';

export async function sendEmail(
  to: string,
  subject: string,
  html: string,
  text: string,
  from?: string
) {
  // Validate email format
  // Add retry logic with exponential backoff
  // Log send attempt
  // Return provider message ID or throw error
}
```

### Notification Processing Flow

1. Event occurs (document approved, payment received, etc.)
2. Notification record created with `channel: EMAIL`
3. Edge Function triggers on notification INSERT (Story 3.2)
4. Email service sends via provider API
5. Delivery record updated with status
6. Webhook (optional) tracks open/click events

### Test Environment Setup

For development, use Ethereal Email (free service):
- Create test account at ethereal.email
- Use test SMTP credentials in development environment
- All emails captured in Ethereal dashboard
- No risk of sending to real users

### Testing Standards

- **Test location:** `__tests__/integration/email-notifications.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Mock email provider, verify calls, check database updates
- **Specific requirements:**
  - Verify email service sends on notification processor trigger
  - Verify PENDING delivery record created before send
  - Verify SENT status updated after successful send
  - Verify retry logic on provider errors
  - Verify template rendering with variables
  - E2E test: Document approval → Email sent → Email content verified

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
