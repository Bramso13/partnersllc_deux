# Story 1.3: Authentication System with Supabase Auth

## Status

Ready for Review

## Story

**As a** user,
**I want** to create an account and log in securely using email and password,
**so that** I can access my personalized dashboard and dossiers.

## Acceptance Criteria

1. Supabase Auth configured in Next.js app with environment variables (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`)
2. Server-side Supabase client created (`lib/supabase/server.ts`) using cookies for session management
3. Client-side Supabase client created (`lib/supabase/client.ts`) for browser interactions
4. Auth helper utilities created: `getUser()`, `getSession()`, `signOut()`
5. Login page created (`/login`) with email/password form using React Hook Form + Zod validation
6. Login form validates email format and password length (min 8 characters)
7. Successful login redirects to `/dashboard` with session cookie set
8. Failed login shows clear error message ("Invalid credentials")
9. Logout functionality implemented clearing session and redirecting to `/login`
10. Protected route middleware created redirecting unauthenticated users from `/dashboard/*` to `/login`
11. Auth state persists across page refreshes using Supabase session management
12. TypeScript types created for User and Session objects

## Tasks / Subtasks

- [x] Configure Supabase Auth environment variables (AC: 1)
  - [x] Add `NEXT_PUBLIC_SUPABASE_URL` to .env.local (déjà documenté dans .env.example)
  - [x] Add `NEXT_PUBLIC_SUPABASE_ANON_KEY` to .env.local (déjà documenté dans .env.example)
  - [x] Document in .env.example (fait dans story 1.1)
- [x] Create server-side Supabase client (AC: 2)
  - [x] Create `lib/supabase/server.ts` (fait dans story 1.2)
  - [x] Implement cookie-based session management (implémenté avec createServerClient)
  - [x] Test server-side authentication (utilisé dans requireAuth et getUser)
- [x] Create client-side Supabase client (AC: 3)
  - [x] Create `lib/supabase/client.ts` (fait dans story 1.2)
  - [x] Configure for browser usage (implémenté avec createBrowserClient)
- [x] Create auth helper utilities (AC: 4)
  - [x] Implement `getUser()` function
  - [x] Implement `getSession()` function
  - [x] Implement `signOut()` function
  - [x] Implement `requireAuth()` helper (bonus)
- [x] Build login page (AC: 5, 6)
  - [x] Create `/app/(public)/login/page.tsx` (style exact correspondant à UX Pilot HTML)
  - [x] Set up React Hook Form with Zod schema
  - [x] Add email and password fields
  - [x] Implement validation logic (email format, password min 8 chars)
  - [x] Style exact avec background gradient, formes flottantes, logo PARTNERS, boutons sociaux
- [x] Implement login functionality (AC: 7, 8)
  - [x] Handle form submission
  - [x] Call Supabase signInWithPassword
  - [x] Redirect on success to /dashboard
  - [x] Show error message on failure ("Identifiants invalides")
- [x] Implement logout functionality (AC: 9)
  - [x] Create logout action/handler (LogoutButton component)
  - [x] Clear session (via supabase.auth.signOut())
  - [x] Redirect to /login
- [x] Create protected route middleware (AC: 10)
  - [x] Create middleware.ts
  - [x] Check authentication for /dashboard/\* routes
  - [x] Redirect unauthenticated users to /login
  - [x] Redirect authenticated users away from /login (bonus)
- [x] Ensure auth persistence (AC: 11)
  - [x] Verify session persists across page refreshes (géré par Supabase via cookies)
  - [x] Test session recovery (middleware refresh session automatiquement)
- [x] Create TypeScript types (AC: 12)
  - [x] Define User type
  - [x] Define Session type
  - [x] Export from types/auth.ts

## Dev Notes

### Supabase Auth Setup

Supabase Auth uses JWT-based authentication with HTTP-only cookies for session storage in server-side Next.js components.

**Key Configuration:**

- Use `createServerClient` for Server Components and API Routes
- Use `createBrowserClient` for Client Components
- Session is automatically managed by Supabase

### Authentication Flow

1. User submits email/password via login form
2. Client calls `supabase.auth.signInWithPassword()`
3. On success, Supabase sets session cookie
4. Middleware checks session for protected routes
5. Protected pages can access user via `getUser()`

### Form Validation Schema (Zod)

```typescript
const loginSchema = z.object({
  email: z.string().email("Email invalide"),
  password: z
    .string()
    .min(8, "Le mot de passe doit contenir au moins 8 caractères"),
});
```

### Middleware Pattern

Create `middleware.ts` in project root to protect routes:

```typescript
export function middleware(request: NextRequest) {
  // Check auth for /dashboard routes
  // Redirect to /login if not authenticated
}

export const config = {
  matcher: ["/dashboard/:path*"],
};
```

### Testing

Manual testing for this story:

- Test successful login flow
- Test failed login with invalid credentials
- Test logout flow
- Test protected route access (authenticated and unauthenticated)
- Test session persistence after page refresh

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

Aucune erreur rencontrée. Type-check et lint passent. Build réussi.

### Completion Notes

- Variables d'environnement Supabase déjà configurées dans `.env.example` (story 1.1)
- Clients Supabase déjà créés (story 1.2) : `lib/supabase/server.ts` et `lib/supabase/client.ts`
- Helpers d'authentification créés dans `lib/auth.ts` :

  - `getUser()` : récupère l'utilisateur actuel (server-side)
  - `getSession()` : récupère la session actuelle (server-side)
  - `signOut()` : déconnexion avec redirection (server-side)
  - `requireAuth()` : helper pour protéger les pages serveur

- Types TypeScript créés dans `types/auth.ts` :

  - `User` : type utilisateur basé sur Supabase User
  - `Session` : type session avec tokens et user
  - `AuthError` : type pour les erreurs d'authentification

- Page de login créée avec style EXACT correspondant à UX Pilot HTML :

  - `/app/(public)/login/page.tsx` : page de login avec layout identique au design
  - Background avec gradient (linear-gradient 135deg)
  - Formes flottantes animées (animation float 20s)
  - Logo PARTNERS avec icône shield-halved (Font Awesome)
  - Carte centrale bg-[#363636] avec rounded-[18px]
  - `components/auth/LoginForm.tsx` : formulaire avec React Hook Form + Zod
  - Validation : email format, password min 8 caractères
  - Messages d'erreur en français : "Identifiants invalides"
  - Checkbox personnalisée "Se souvenir de moi"
  - Lien "Mot de passe oublié ?"
  - Boutons sociaux (Google, Facebook, Discord) avec icônes SVG
  - Lien vers inscription
  - Redirection automatique vers `/dashboard` après succès

- Page d'inscription créée avec style EXACT correspondant à UX Pilot HTML :

  - `/app/(public)/register/page.tsx` : même style visuel que login
  - `components/auth/RegisterForm.tsx` : formulaire avec tous les champs
  - Champs : Prénom, Nom, Email, Téléphone, Mot de passe, Confirmation mot de passe
  - Checkbox pour accepter les conditions d'utilisation
  - Validation Zod avec vérification de correspondance des mots de passe
  - Boutons sociaux identiques
  - Lien vers connexion
  - Intégration Supabase signUp avec metadata (full_name, phone)

- Page dashboard créée :

  - `/app/(protected)/dashboard/page.tsx` : page protégée utilisant `requireAuth()`
  - Affiche l'email de l'utilisateur
  - Bouton de déconnexion

- Middleware créé :

  - `middleware.ts` : protège les routes `/dashboard/*`
  - Redirige vers `/login` si non authentifié
  - Redirige vers `/dashboard` si déjà authentifié et sur `/login` (bonus)
  - Refresh automatique de la session via Supabase

- Logout implémenté :

  - `components/auth/LogoutButton.tsx` : composant client pour déconnexion
  - Utilise `supabase.auth.signOut()` côté client
  - Redirection vers `/login` après déconnexion

- Page d'accueil mise à jour :

  - Redirige automatiquement vers `/login` si non authentifié
  - Redirige vers `/dashboard` si authentifié

- Styles CSS ajoutés dans `globals.css` :

  - Animation @keyframes float pour les formes flottantes
  - Styles pour input-field avec focus glow
  - Styles pour social-btn avec hover effect
  - Styles pour checkbox-custom avec état checked

- Font Awesome installé et importé dans layout pour les icônes

- Session persistence : gérée automatiquement par Supabase via cookies HTTP-only
- Middleware refresh la session automatiquement sur chaque requête

### File List

**Fichiers créés:**

- `partnersllc-app/types/auth.ts` - Types TypeScript pour User, Session, AuthError
- `partnersllc-app/lib/auth.ts` - Helpers d'authentification (getUser, getSession, signOut, requireAuth)
- `partnersllc-app/app/(public)/login/page.tsx` - Page de login avec style exact UX Pilot
- `partnersllc-app/app/(public)/register/page.tsx` - Page d'inscription avec style exact UX Pilot
- `partnersllc-app/components/auth/LoginForm.tsx` - Formulaire de login avec React Hook Form + Zod
- `partnersllc-app/components/auth/RegisterForm.tsx` - Formulaire d'inscription avec validation complète
- `partnersllc-app/app/(protected)/dashboard/page.tsx` - Page dashboard protégée
- `partnersllc-app/components/auth/LogoutButton.tsx` - Bouton de déconnexion
- `partnersllc-app/middleware.ts` - Middleware pour protection des routes

**Fichiers modifiés:**

- `partnersllc-app/app/page.tsx` - Redirection automatique selon état d'authentification
- `partnersllc-app/app/layout.tsx` - Ajout import Font Awesome
- `partnersllc-app/app/globals.css` - Ajout styles pour animations, checkboxes, inputs, boutons sociaux

**Dépendances ajoutées:**

- `react-hook-form` - Gestion de formulaires
- `@hookform/resolvers` - Résolveurs pour React Hook Form
- `zod` - Validation de schémas
- `@fortawesome/fontawesome-free` - Icônes Font Awesome

## QA Results

_Results from QA Agent review will be documented here._
