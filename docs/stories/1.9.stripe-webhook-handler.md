# Story 1.9: Stripe Webhook Handler for Payment Completion

## Status

Ready for Review

## Story

**As the** system,
**I want** to automatically activate user accounts and create dossiers when Stripe payments succeed,
**so that** users can immediately access their dashboard without manual intervention.

## Acceptance Criteria

1. API route created at `/api/webhooks/stripe` handling POST requests
2. Webhook signature verified using `STRIPE_WEBHOOK_SECRET` before processing
3. Invalid signatures return 400 error immediately
4. `checkout.session.completed` event handler extracts metadata: `order_id`, `user_id`, `product_id`
5. Order record updated: `status: PAID`, `stripe_session_id`, `paid_at: now()`, `amount_paid`
6. Profile record updated: `status: ACTIVE`
7. Dossier record created with: `user_id`, `product_id`, `status: QUALIFICATION`, `created_by: SYSTEM`
8. Step instances created for all product steps (query `product_steps` joined with `steps`)
9. First step instance marked as started: `started_at: now()`
10. Dossier `current_step_instance_id` set to first step instance ID
11. Event created: `DOSSIER_CREATED` with actor: SYSTEM, payload including dossier ID
12. Event created: `PAYMENT_RECEIVED` with payment details
13. Webhook responds with 200 OK and `{ received: true }` within 5 seconds (Stripe timeout)
14. Idempotency handled: If webhook received twice (retry), check if order already PAID and skip processing
15. Error handling: Database errors logged to Sentry, webhook returns 500 causing Stripe retry
16. Webhook processing tested with Stripe CLI (`stripe trigger checkout.session.completed`)

## Tasks / Subtasks

- [x] Create webhook route handler (AC: 1)
  - [x] Create `/api/webhooks/stripe` route
  - [x] Accept POST requests
  - [x] Parse Stripe event from request body
- [x] Implement signature verification (AC: 2, 3)
  - [x] Use `STRIPE_WEBHOOK_SECRET` to verify signature
  - [x] Return 400 on invalid signature
  - [x] Use Stripe SDK's verification method
- [x] Handle checkout.session.completed event (AC: 4)
  - [x] Extract metadata from event: `order_id`, `user_id`, `product_id`
  - [x] Implement idempotency check (AC: 14)
- [x] Update order record (AC: 5)
  - [x] Set `status: PAID`
  - [x] Set `stripe_session_id`
  - [x] Set `paid_at: now()`
  - [x] Set `amount_paid` from Stripe session
- [x] Activate user profile (AC: 6)
  - [x] Update profile `status: ACTIVE`
- [x] Create dossier (AC: 7)
  - [x] Create dossier record with user_id, product_id
  - [x] Set `status: QUALIFICATION`
  - [x] Set `created_by: SYSTEM` (via metadata)
- [x] Create step instances (AC: 8, 9, 10)
  - [x] Query product steps for product_id
  - [x] Create step_instances for each step
  - [x] Mark first step as started: `started_at: now()`
  - [x] Set dossier `current_step_instance_id` to first step
- [x] Create system events (AC: 11, 12)
  - [x] Create DOSSIER_CREATED event with actor: SYSTEM
  - [x] Create PAYMENT_RECEIVED event with payment details
- [x] Implement webhook response (AC: 13)
  - [x] Respond with 200 OK and `{ received: true }` within 5 seconds
- [x] Add error handling and logging (AC: 15)
  - [x] Log errors to console (Sentry not installed yet, comment added for future)
  - [x] Return 500 on errors to trigger Stripe retry
- [ ] Test webhook with Stripe CLI (AC: 16)
  - [ ] Test with `stripe trigger checkout.session.completed`
  - [ ] Verify webhook processing completes successfully

## Dev Notes

### Stripe Webhook Verification

Use Stripe SDK to verify webhook signature:

```typescript
import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export async function POST(req: Request) {
  const sig = req.headers.get("stripe-signature");
  const body = await req.text();

  try {
    const event = stripe.webhooks.constructEvent(
      body,
      sig!,
      process.env.STRIPE_WEBHOOK_SECRET!
    );

    if (event.type === "checkout.session.completed") {
      // Handle event
    }
  } catch (error) {
    return new Response("Invalid signature", { status: 400 });
  }
}
```

### Event Metadata

From Story 1.7, Checkout Session metadata:

```typescript
{
  order_id: string,
  user_id: string,
  product_id: string
}
```

### Database Operations

**Order Update:**

```typescript
const order = await supabase
  .from("orders")
  .update({
    status: "PAID",
    stripe_session_id: session.id,
    paid_at: new Date().toISOString(),
    amount_paid: session.amount_total,
  })
  .eq("id", order_id)
  .select()
  .single();
```

**Profile Update:**

```typescript
const profile = await supabase
  .from("profiles")
  .update({ status: "ACTIVE" })
  .eq("id", user_id)
  .select()
  .single();
```

**Dossier Creation:**

```typescript
const dossier = await supabase
  .from("dossiers")
  .insert({
    user_id,
    product_id,
    status: "QUALIFICATION",
    created_by: "SYSTEM",
  })
  .select()
  .single();
```

### Step Instances

Query product steps:

```typescript
const productSteps = await supabase
  .from("product_steps")
  .select(
    `
    id,
    step_id,
    order,
    steps (
      id,
      name,
      description
    )
  `
  )
  .eq("product_id", product_id)
  .order("order", { ascending: true });
```

Create step instances for each step and mark first as started.

### Event Creation

From database schema, create events:

```typescript
// DOSSIER_CREATED
await supabase.from("events").insert({
  event_type: "DOSSIER_CREATED",
  actor: "SYSTEM",
  payload: { dossier_id: dossier.id, user_id },
});

// PAYMENT_RECEIVED
await supabase.from("events").insert({
  event_type: "PAYMENT_RECEIVED",
  actor: "SYSTEM",
  payload: { order_id, amount_paid: session.amount_total },
});
```

### Idempotency

Check if order is already PAID before processing:

```typescript
if (order.status === "PAID") {
  return new Response(JSON.stringify({ received: true }), { status: 200 });
}
```

### Error Handling

Log to Sentry on errors:

```typescript
import * as Sentry from "@sentry/nextjs";

try {
  // webhook processing
} catch (error) {
  Sentry.captureException(error);
  return new Response("Internal server error", { status: 500 });
}
```

### Stripe CLI Testing

```bash
# Start webhook listener
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Trigger test event
stripe trigger checkout.session.completed
```

### Design System Notes

Payment processing is automatic; no UI changes needed for this story beyond what's in Story 1.7 (success message).

### Testing

Testing standards from Story 1.1:

- Test webhook signature verification
- Test with invalid signature
- Test with valid signature and event
- Test idempotency (process same event twice)
- Test order, profile, dossier updates
- Test step instance creation
- Test event creation
- Test error handling and Sentry logging
- Mock Stripe and Supabase in tests
- E2E test: full flow from checkout to account activation

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - Aucune erreur rencontrée lors de l'implémentation. Le code compile sans erreur TypeScript.

### Completion Notes

- Handler webhook complet implémenté dans `app/api/webhooks/stripe/route.ts`
- Vérification de signature Stripe déjà présente (story 1.5)
- Extraction des métadonnées depuis `session.metadata` : `order_id`, `user_id`, `product_id`
- Vérification d'idempotence : si l'order est déjà PAID, retour immédiat sans traitement
- Mise à jour de l'order : status PAID, stripe_checkout_session_id, stripe_payment_intent_id, stripe_customer_id, paid_at
- Activation du profil utilisateur : status ACTIVE, stripe_customer_id
- Récupération du produit pour obtenir `dossier_type` et `initial_status`
- Création du dossier avec metadata incluant order_id et created_via
- Création des step instances pour tous les product_steps (triés par position)
- Première step instance marquée comme started (started_at)
- Dossier.current_step_instance_id lié à la première step instance
- Ordre lié au dossier (dossier_id dans orders)
- Événements créés : DOSSIER_CREATED et PAYMENT_RECEIVED avec actor_type SYSTEM
- Gestion d'erreurs complète : try/catch avec logging console et retour 500 pour retry Stripe
- Note : Sentry n'est pas installé, commentaire ajouté pour intégration future
- Réponse webhook : 200 OK avec `{ received: true }` dans les 5 secondes requis

**Note importante** : Le test avec Stripe CLI nécessite une action manuelle. Le webhook doit être testé avec `stripe listen --forward-to localhost:3000/api/webhooks/stripe` puis `stripe trigger checkout.session.completed`.

### File List

- `partnersllc-app/app/api/webhooks/stripe/route.ts` (modifié - implémentation complète du handler)

## QA Results

_Results from QA Agent review will be documented here._
