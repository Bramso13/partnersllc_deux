# Story 1.9: Stripe Webhook Handler for Payment Completion

## Status
Draft

## Story

**As the** system,
**I want** to automatically activate user accounts and create dossiers when Stripe payments succeed,
**so that** users can immediately access their dashboard without manual intervention.

## Acceptance Criteria

1. API route created at `/api/webhooks/stripe` handling POST requests
2. Webhook signature verified using `STRIPE_WEBHOOK_SECRET` before processing
3. Invalid signatures return 400 error immediately
4. `checkout.session.completed` event handler extracts metadata: `order_id`, `user_id`, `product_id`
5. Order record updated: `status: PAID`, `stripe_session_id`, `paid_at: now()`, `amount_paid`
6. Profile record updated: `status: ACTIVE`
7. Dossier record created with: `user_id`, `product_id`, `status: QUALIFICATION`, `created_by: SYSTEM`
8. Step instances created for all product steps (query `product_steps` joined with `steps`)
9. First step instance marked as started: `started_at: now()`
10. Dossier `current_step_instance_id` set to first step instance ID
11. Event created: `DOSSIER_CREATED` with actor: SYSTEM, payload including dossier ID
12. Event created: `PAYMENT_RECEIVED` with payment details
13. Webhook responds with 200 OK and `{ received: true }` within 5 seconds (Stripe timeout)
14. Idempotency handled: If webhook received twice (retry), check if order already PAID and skip processing
15. Error handling: Database errors logged to Sentry, webhook returns 500 causing Stripe retry
16. Webhook processing tested with Stripe CLI (`stripe trigger checkout.session.completed`)

## Tasks / Subtasks

- [ ] Create webhook route handler (AC: 1)
  - [ ] Create `/api/webhooks/stripe` route
  - [ ] Accept POST requests
  - [ ] Parse Stripe event from request body
- [ ] Implement signature verification (AC: 2, 3)
  - [ ] Use `STRIPE_WEBHOOK_SECRET` to verify signature
  - [ ] Return 400 on invalid signature
  - [ ] Use Stripe SDK's verification method
- [ ] Handle checkout.session.completed event (AC: 4)
  - [ ] Extract metadata from event: `order_id`, `user_id`, `product_id`
  - [ ] Implement idempotency check (AC: 14)
- [ ] Update order record (AC: 5)
  - [ ] Set `status: PAID`
  - [ ] Set `stripe_session_id`
  - [ ] Set `paid_at: now()`
  - [ ] Set `amount_paid` from Stripe session
- [ ] Activate user profile (AC: 6)
  - [ ] Update profile `status: ACTIVE`
- [ ] Create dossier (AC: 7)
  - [ ] Create dossier record with user_id, product_id
  - [ ] Set `status: QUALIFICATION`
  - [ ] Set `created_by: SYSTEM`
- [ ] Create step instances (AC: 8, 9, 10)
  - [ ] Query product steps for product_id
  - [ ] Create step_instances for each step
  - [ ] Mark first step as started: `started_at: now()`
  - [ ] Set dossier `current_step_instance_id` to first step
- [ ] Create system events (AC: 11, 12)
  - [ ] Create DOSSIER_CREATED event with actor: SYSTEM
  - [ ] Create PAYMENT_RECEIVED event with payment details
- [ ] Implement webhook response (AC: 13)
  - [ ] Respond with 200 OK and `{ received: true }` within 5 seconds
- [ ] Add error handling and logging (AC: 15)
  - [ ] Log errors to Sentry on database failures
  - [ ] Return 500 on errors to trigger Stripe retry
- [ ] Test webhook with Stripe CLI (AC: 16)
  - [ ] Test with `stripe trigger checkout.session.completed`
  - [ ] Verify webhook processing completes successfully

## Dev Notes

### Stripe Webhook Verification

Use Stripe SDK to verify webhook signature:

```typescript
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export async function POST(req: Request) {
  const sig = req.headers.get('stripe-signature');
  const body = await req.text();

  try {
    const event = stripe.webhooks.constructEvent(
      body,
      sig!,
      process.env.STRIPE_WEBHOOK_SECRET!
    );

    if (event.type === 'checkout.session.completed') {
      // Handle event
    }
  } catch (error) {
    return new Response('Invalid signature', { status: 400 });
  }
}
```

### Event Metadata

From Story 1.7, Checkout Session metadata:
```typescript
{
  order_id: string,
  user_id: string,
  product_id: string
}
```

### Database Operations

**Order Update:**
```typescript
const order = await supabase
  .from('orders')
  .update({
    status: 'PAID',
    stripe_session_id: session.id,
    paid_at: new Date().toISOString(),
    amount_paid: session.amount_total,
  })
  .eq('id', order_id)
  .select()
  .single();
```

**Profile Update:**
```typescript
const profile = await supabase
  .from('profiles')
  .update({ status: 'ACTIVE' })
  .eq('id', user_id)
  .select()
  .single();
```

**Dossier Creation:**
```typescript
const dossier = await supabase
  .from('dossiers')
  .insert({
    user_id,
    product_id,
    status: 'QUALIFICATION',
    created_by: 'SYSTEM',
  })
  .select()
  .single();
```

### Step Instances

Query product steps:
```typescript
const productSteps = await supabase
  .from('product_steps')
  .select(`
    id,
    step_id,
    order,
    steps (
      id,
      name,
      description
    )
  `)
  .eq('product_id', product_id)
  .order('order', { ascending: true });
```

Create step instances for each step and mark first as started.

### Event Creation

From database schema, create events:
```typescript
// DOSSIER_CREATED
await supabase.from('events').insert({
  event_type: 'DOSSIER_CREATED',
  actor: 'SYSTEM',
  payload: { dossier_id: dossier.id, user_id },
});

// PAYMENT_RECEIVED
await supabase.from('events').insert({
  event_type: 'PAYMENT_RECEIVED',
  actor: 'SYSTEM',
  payload: { order_id, amount_paid: session.amount_total },
});
```

### Idempotency

Check if order is already PAID before processing:
```typescript
if (order.status === 'PAID') {
  return new Response(JSON.stringify({ received: true }), { status: 200 });
}
```

### Error Handling

Log to Sentry on errors:
```typescript
import * as Sentry from '@sentry/nextjs';

try {
  // webhook processing
} catch (error) {
  Sentry.captureException(error);
  return new Response('Internal server error', { status: 500 });
}
```

### Stripe CLI Testing

```bash
# Start webhook listener
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Trigger test event
stripe trigger checkout.session.completed
```

### Design System Notes

Payment processing is automatic; no UI changes needed for this story beyond what's in Story 1.7 (success message).

### Testing

Testing standards from Story 1.1:
- Test webhook signature verification
- Test with invalid signature
- Test with valid signature and event
- Test idempotency (process same event twice)
- Test order, profile, dossier updates
- Test step instance creation
- Test event creation
- Test error handling and Sentry logging
- Mock Stripe and Supabase in tests
- E2E test: full flow from checkout to account activation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
