# Story 5.3: Agent Step Processing View

## Status

Draft

## Story

**As an** agent,
**I want** a detailed view of an assigned step with all actions needed to process it,
**so that** I can review documents, view submitted information, and complete the step.

## Acceptance Criteria

### Access Control
1. Step processing page at `/agent/steps/[step_instance_id]`
2. Page only accessible if step is assigned to current agent (403 if not assigned)
3. Admin role can access any step (for debugging/support)

### Header & Context
4. Header shows: Step name, Step description, Position in workflow (e.g., "Ã‰tape 2 sur 5")
5. Dossier context bar shows: Product name, Client name/email, Dossier ID, Dossier status
6. Back button returns to `/agent/steps` queue

### Documents Section
7. List of required documents for this step (from `document_types` where `required_step_id = step_id`)
8. For each required document type:
   - Show uploaded document name and upload date if exists
   - Show "Non soumis" placeholder if not uploaded
   - Status badge: PENDING (yellow), APPROVED (green), REJECTED (red), Not submitted (gray)
9. "Voir" button opens document preview modal (PDF viewer for PDFs, image viewer for images)
10. For PENDING documents: "Approuver" and "Rejeter" action buttons
11. "Approuver" creates `document_reviews` record with `status: APPROVED`
12. "Rejeter" opens modal requiring reason (min 10 chars), creates review with `status: REJECTED`
13. After approval/rejection, document status badge updates immediately (optimistic UI)

### Form Fields Section
14. Display custom fields defined in `step_fields` for this step
15. Show current values from `step_field_values` (read-only view for agent)
16. Fields displayed in order by `step_fields.position`
17. Empty fields show "Non renseignÃ©" placeholder
18. Agent cannot edit client-submitted data (view only)

### Step Completion
19. "Marquer comme complÃ©tÃ©" button at bottom of page
20. Button disabled until all required documents are APPROVED
21. Button shows tooltip explaining why disabled if requirements not met
22. Manual override checkbox: "ComplÃ©ter malgrÃ© documents manquants" (for exceptional cases)
23. Clicking override checkbox enables completion button regardless of document status
24. Completion updates `step_instances.completed_at = now()`
25. Completion calls `get_next_step_for_dossier()` to advance workflow
26. Completion creates `STEP_COMPLETED` event with `manual: true/false` in payload
27. After completion, redirect to `/agent/steps` with success toast

### Internal Notes
28. View internal notes for this dossier (from `dossier_notes`)
29. Add new note button opens textarea modal
30. Notes visible to all agents, never to clients
31. Notes show agent name and timestamp

### Client Communication
32. "Envoyer un message" button opens message composer
33. Message sent to client via `messages` table
34. Recent messages (last 5) displayed in sidebar or collapsible section

## Tasks / Subtasks

- [ ] Create step data fetching function (AC: 4, 5, 7, 14)
  - [ ] Create `getStepInstanceById()` in `lib/agent-steps.ts`
  - [ ] Fetch step instance with step, dossier, product, client details
  - [ ] Fetch required document types for this step
  - [ ] Fetch uploaded documents with current version status
  - [ ] Fetch step fields and field values
  - [ ] Return typed `StepInstanceWithDetails`

- [ ] Build step processing page (AC: 1, 4, 5, 6)
  - [ ] Create `app/(protected)/agent/steps/[id]/page.tsx`
  - [ ] Add access control check (assigned to current agent or admin)
  - [ ] Create `StepProcessingContent` client component
  - [ ] Build header with step info and progress indicator
  - [ ] Build dossier context bar
  - [ ] Add back button navigation

- [ ] Build documents section (AC: 7, 8, 9, 10, 11, 12, 13)
  - [ ] Create `StepDocumentsSection` component
  - [ ] Display required documents with status badges
  - [ ] Create document preview modal (PDF and image viewer)
  - [ ] Add approve/reject buttons for pending documents
  - [ ] Create rejection reason modal
  - [ ] Create API route `POST /api/agent/documents/[id]/review`
  - [ ] Implement optimistic UI update on approval/rejection

- [ ] Build form fields section (AC: 14, 15, 16, 17, 18)
  - [ ] Create `StepFieldsSection` component
  - [ ] Query and display step fields with values
  - [ ] Handle different field types (text, number, select, etc.)
  - [ ] Display as read-only (no editing)

- [ ] Build step completion feature (AC: 19, 20, 21, 22, 23, 24, 25, 26, 27)
  - [ ] Create `CompleteStepSection` component
  - [ ] Check if all required documents approved
  - [ ] Show disabled state with tooltip when requirements not met
  - [ ] Add manual override checkbox
  - [ ] Create API route `POST /api/agent/steps/[id]/complete`
  - [ ] Update step_instances.completed_at
  - [ ] Advance dossier workflow
  - [ ] Create STEP_COMPLETED event
  - [ ] Redirect with success toast

- [ ] Build internal notes feature (AC: 28, 29, 30, 31)
  - [ ] Create `StepNotesSection` component
  - [ ] Fetch and display dossier notes
  - [ ] Add note creation modal
  - [ ] Reuse existing notes API from admin dossier view

- [ ] Build client communication feature (AC: 32, 33, 34)
  - [ ] Create `MessageComposer` component
  - [ ] Create API route `POST /api/agent/dossiers/[id]/messages`
  - [ ] Display recent messages

- [ ] Testing
  - [ ] Test access control (only assigned agent can view)
  - [ ] Test document approval flow
  - [ ] Test document rejection flow
  - [ ] Test step completion with all docs approved
  - [ ] Test manual override completion
  - [ ] Test notes feature
  - [ ] Test messaging feature
  - [ ] Test responsive layout

## Dev Notes

### Data Model

```typescript
interface StepInstanceWithDetails {
  id: string;
  step_id: string;
  dossier_id: string;
  assigned_to: string;
  started_at: string | null;
  completed_at: string | null;
  
  step: {
    id: string;
    code: string;
    label: string;
    description: string | null;
    position: number;
  };
  
  dossier: {
    id: string;
    status: string;
    product: {
      name: string;
    };
    client: {
      id: string;
      full_name: string;
      email: string;
    };
    total_steps: number;
  };
  
  required_documents: Array<{
    document_type: {
      id: string;
      code: string;
      label: string;
    };
    document?: {
      id: string;
      status: 'PENDING' | 'APPROVED' | 'REJECTED';
      current_version: {
        id: string;
        file_url: string;
        file_name: string;
        uploaded_at: string;
        version_number: number;
      };
    };
  }>;
  
  fields: Array<{
    field: {
      id: string;
      field_key: string;
      label: string;
      field_type: string;
      position: number;
    };
    value?: {
      value: string | null;
      value_jsonb: any;
    };
  }>;
}
```

### Document Review API

```typescript
// POST /api/agent/documents/[id]/review
export async function POST(request: NextRequest, { params }: { params: { id: string } }) {
  const agent = await requireAgentRoleAuth();
  const { status, reason } = await request.json();
  
  // Verify document belongs to step assigned to this agent
  // ...
  
  // Create review
  const { data: review, error } = await supabase
    .from('document_reviews')
    .insert({
      document_version_id: documentVersionId,
      reviewer_id: agentId, // From agents table
      status,
      reason
    })
    .select()
    .single();
    
  // Update document status
  await supabase
    .from('documents')
    .update({ status })
    .eq('id', params.id);
    
  // Create event
  await supabase.from('events').insert({
    entity_type: 'document',
    entity_id: params.id,
    event_type: 'DOCUMENT_REVIEWED',
    actor_type: 'AGENT',
    actor_id: agentId,
    payload: { status, reason, reviewer_name: agent.full_name }
  });
  
  return NextResponse.json({ success: true, review });
}
```

### Step Completion API

```typescript
// POST /api/agent/steps/[id]/complete
export async function POST(request: NextRequest, { params }: { params: { id: string } }) {
  const agent = await requireAgentRoleAuth();
  const { manual_override } = await request.json();
  
  // Verify step assigned to this agent (or admin)
  // ...
  
  // Check documents complete (unless manual override)
  if (!manual_override) {
    const docsComplete = await areStepDocumentsComplete(params.id);
    if (!docsComplete) {
      return NextResponse.json({ error: 'Documents not complete' }, { status: 400 });
    }
  }
  
  // Complete step
  await supabase
    .from('step_instances')
    .update({ completed_at: new Date().toISOString() })
    .eq('id', params.id);
    
  // Advance workflow
  const nextStepId = await getNextStepForDossier(dossierId);
  if (nextStepId) {
    await supabase
      .from('dossiers')
      .update({ current_step_instance_id: nextStepInstanceId })
      .eq('id', dossierId);
  } else {
    // No more steps - dossier complete
    await supabase
      .from('dossiers')
      .update({ status: 'COMPLETED', completed_at: new Date().toISOString() })
      .eq('id', dossierId);
  }
  
  // Create event
  await supabase.from('events').insert({
    entity_type: 'step_instance',
    entity_id: params.id,
    event_type: 'STEP_COMPLETED',
    actor_type: 'AGENT',
    actor_id: agentId,
    payload: { manual: manual_override, step_label: stepLabel }
  });
  
  return NextResponse.json({ success: true });
}
```

### Page Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Retour   Qualification                     Ã‰tape 1 sur 5    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLC Formation | Jean Dupont | abc-123... | Status: EN COURS   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ DOCUMENTS REQUIS                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“„ Passeport           passport.pdf    [PENDING]        â”‚   â”‚
â”‚ â”‚                        [Voir] [Approuver] [Rejeter]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“„ Justificatif domicile   Non soumis  [NOT SUBMITTED]  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚ INFORMATIONS CLIENT                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Nom de la sociÃ©tÃ©: My LLC Inc.                          â”‚   â”‚
â”‚ â”‚ Ã‰tat: Delaware                                          â”‚   â”‚
â”‚ â”‚ Adresse: 123 Main St...                                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚ NOTES INTERNES                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ John (il y a 2h): Client a appelÃ© pour extension        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ [+ Ajouter une note]                                          â”‚
â”‚                                                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ â˜ ComplÃ©ter malgrÃ© documents manquants                        â”‚
â”‚ [Marquer comme complÃ©tÃ©] (dÃ©sactivÃ©)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Structure

```
partnersllc-app/
â”œâ”€â”€ app/(protected)/agent/steps/
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ components/agent/step-processing/
â”‚   â”œâ”€â”€ StepProcessingContent.tsx
â”‚   â”œâ”€â”€ StepDocumentsSection.tsx
â”‚   â”œâ”€â”€ DocumentPreviewModal.tsx
â”‚   â”œâ”€â”€ RejectDocumentModal.tsx
â”‚   â”œâ”€â”€ StepFieldsSection.tsx
â”‚   â”œâ”€â”€ CompleteStepSection.tsx
â”‚   â””â”€â”€ StepNotesSection.tsx
â””â”€â”€ app/api/agent/
    â”œâ”€â”€ documents/[id]/review/route.ts
    â””â”€â”€ steps/[id]/complete/route.ts
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*To be filled during implementation*

## QA Results

*To be filled after QA review*
