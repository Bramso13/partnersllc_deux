# Story 4.2: Agent Dashboard with Key Metrics

## Status

Ready for Review

## Story

**As an** agent,
**I want** a dashboard showing my workload, pending tasks, and performance metrics,
**so that** I can prioritize my work and track my productivity.

## Acceptance Criteria

1. Agent dashboard at `/admin/dashboard` displays personalized metrics for logged-in agent
2. Stats cards at top showing:
   - Pending Reviews: Count of documents with `status: PENDING` (clickable, links to review queue)
   - Assigned Dossiers: Count of active dossiers assigned to agent
   - Completed Today: Count of documents reviewed today
   - Avg Review Time: Average time between upload and review completion
3. Recent activity feed showing last 20 events across all agent's assigned dossiers
4. Activity feed displays: Event type icon, Description ("John Doe uploaded Passport for LLC-123"), Timestamp (relative)
5. "My Dossiers" section listing dossiers assigned to agent with quick actions
6. Dossier quick view cards show: Client name, Product, Current step, Pending documents count, Last activity
7. Unread messages indicator on dossiers with new client messages
8. Quick action buttons: "Review Docs", "View Dossier", "Send Message"
9. Performance charts (optional enhancement): Line chart showing reviews completed per day over last 30 days
10. Dashboard refreshes every 60 seconds to show updated counts
11. Empty states with helpful messages when no pending tasks
12. Dashboard responsive: Stacked cards on mobile, grid layout on desktop

## Tasks / Subtasks

- [x] Create agent dashboard layout (AC: 1, 12)
  - [x] Build dashboard page at `/admin/dashboard`
  - [x] Implement responsive grid layout (mobile/desktop)
  - [x] Add placeholder sections for stats, activity, and dossiers
- [x] Build stats cards component (AC: 2)
  - [x] Query pending documents count for agent
  - [x] Query assigned dossiers count
  - [x] Calculate completed documents for today
  - [x] Calculate average review time
  - [x] Create clickable card components with icons
- [x] Implement activity feed (AC: 3, 4)
  - [x] Query last 20 events for agent's dossiers from `events` table
  - [x] Parse event data and generate descriptions
  - [x] Format timestamps as relative time (e.g., "il y a 2 heures")
  - [x] Add event type icons
  - [x] Display events in chronological order
- [x] Build "My Dossiers" section (AC: 5, 6, 7, 8)
  - [x] Query dossiers assigned to agent
  - [x] Display dossier quick view cards
  - [x] Show current step and pending documents count
  - [x] Show last activity timestamp
  - [x] Add unread message indicator badge
  - [x] Implement quick action buttons
- [x] Set up auto-refresh mechanism (AC: 10)
  - [x] Implement 60-second interval refresh for stats
  - [ ] Use Supabase Realtime to update stats in real-time (optimization - future enhancement)
  - [x] Prevent unnecessary re-renders
- [x] Add performance charts (AC: 9)
  - [x] Query document_reviews grouped by date for last 30 days
  - [x] Build bar chart component (custom implementation)
  - [x] Display reviews completed per day trend
  - [x] Make chart responsive
- [x] Implement empty states (AC: 11)
  - [x] Show helpful message when no pending reviews
  - [x] Show message when no assigned dossiers
  - [x] Add helpful messages in empty states

## Dev Notes

### Dashboard Data Queries

**Pending Reviews Count:**
```sql
SELECT COUNT(*)
FROM documents
WHERE status = 'PENDING'
  AND dossier_id IN (SELECT id FROM dossiers WHERE assigned_agent_id = current_user_id)
```

**Assigned Dossiers Count:**
```sql
SELECT COUNT(*)
FROM dossiers
WHERE assigned_agent_id = current_user_id
  AND status IN ('QUALIFICATION', 'IN_PROGRESS', 'PENDING_REVIEW')
```

**Completed Today:**
```sql
SELECT COUNT(*)
FROM document_reviews
WHERE agent_id = current_user_id
  AND created_at::date = CURRENT_DATE
```

**Average Review Time:**
```sql
SELECT AVG(EXTRACT(EPOCH FROM (review_created_at - upload_created_at))/3600) as avg_hours
FROM (
  SELECT dr.created_at as review_created_at, d.created_at as upload_created_at
  FROM document_reviews dr
  JOIN documents d ON dr.document_id = d.id
  WHERE dr.agent_id = current_user_id
)
```

### Activity Feed Event Types

- `DOCUMENT_UPLOADED` - "X uploaded Y document for dossier Z"
- `DOCUMENT_REVIEWED` - "Document review completed: X (APPROVED/REJECTED)"
- `DOSSIER_CREATED` - "New dossier created: X"
- `STEP_COMPLETED` - "Workflow step completed: X → Y"
- `MESSAGE_SENT` - "New message from client X"
- `DOSSIER_STATUS_CHANGED` - "Dossier status changed: X → Y"
- `ASSIGNMENT_CHANGED` - "Dossier assigned to agent X"

### Charting Library Configuration

Using Recharts for line chart:
```tsx
<LineChart data={reviewData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="date" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Line type="monotone" dataKey="count" stroke="#00F0FF" />
</LineChart>
```

### Responsive Design

**Mobile:** Single column, stacked cards
**Tablet:** 2-column grid
**Desktop:** 3-4 column grid with flexible layout

### Auto-Refresh Implementation

```tsx
useEffect(() => {
  const interval = setInterval(() => {
    refetchStats(); // Re-query stats
  }, 60000); // 60 seconds

  return () => clearInterval(interval);
}, []);
```

Or use Supabase Realtime subscriptions for real-time updates instead of polling.

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/dashboard/`
**Coverage Requirements:**
- Stats card calculations and display
- Activity feed rendering and formatting
- Dossier quick view cards
- Quick action button functionality
- Responsive layout on different screen sizes
- Auto-refresh mechanism
- Empty state messages

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (DEV Agent)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes

- Implementé le dashboard agent complet avec toutes les fonctionnalités requises
- Utilisé la table `events` avec `entity_type = 'dossier'` au lieu de `dossier_events` (structure actuelle de la base de données)
- Les dossiers assignés sont déterminés via `step_instances.assigned_to` car il n'y a pas de champ `assigned_agent_id` direct sur `dossiers`
- Implémenté un auto-refresh toutes les 60 secondes côté client
- Les graphiques de performance utilisent une implémentation custom avec barres (pas de dépendance externe)
- Tous les états vides sont implémentés avec messages utiles
- Le layout est responsive avec grid qui s'adapte mobile/tablet/desktop
- Les classes CSS utilisées correspondent au système de design existant (`brand-*`)

### File List

**Nouveaux fichiers créés:**
- `partnersllc-app/lib/agent-metrics.ts` - Fonctions pour récupérer les métriques agent
- `partnersllc-app/app/(protected)/admin/dashboard/page.tsx` - Page principale du dashboard agent
- `partnersllc-app/app/api/admin/dashboard/route.ts` - API route pour les données du dashboard
- `partnersllc-app/app/api/admin/dashboard/chart/route.ts` - API route pour les données du graphique
- `partnersllc-app/components/admin/AgentDashboardContent.tsx` - Composant principal du dashboard
- `partnersllc-app/components/admin/StatsCards.tsx` - Composant des cartes de statistiques
- `partnersllc-app/components/admin/ActivityFeed.tsx` - Composant du feed d'activité
- `partnersllc-app/components/admin/MyDossiersSection.tsx` - Composant de la section "Mes dossiers"
- `partnersllc-app/components/admin/PerformanceChart.tsx` - Composant du graphique de performance

**Fichiers modifiés:**
- `partnersllc-app/middleware.ts` - Ajout de la protection pour les routes `/admin`

## QA Results

*Results from QA Agent review will be documented here.*
