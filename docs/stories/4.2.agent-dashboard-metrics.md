# Story 4.2: Agent Dashboard with Key Metrics

## Status

Draft

## Story

**As an** agent,
**I want** a dashboard showing my workload, pending tasks, and performance metrics,
**so that** I can prioritize my work and track my productivity.

## Acceptance Criteria

1. Agent dashboard at `/admin/dashboard` displays personalized metrics for logged-in agent
2. Stats cards at top showing:
   - Pending Reviews: Count of documents with `status: PENDING` (clickable, links to review queue)
   - Assigned Dossiers: Count of active dossiers assigned to agent
   - Completed Today: Count of documents reviewed today
   - Avg Review Time: Average time between upload and review completion
3. Recent activity feed showing last 20 events across all agent's assigned dossiers
4. Activity feed displays: Event type icon, Description ("John Doe uploaded Passport for LLC-123"), Timestamp (relative)
5. "My Dossiers" section listing dossiers assigned to agent with quick actions
6. Dossier quick view cards show: Client name, Product, Current step, Pending documents count, Last activity
7. Unread messages indicator on dossiers with new client messages
8. Quick action buttons: "Review Docs", "View Dossier", "Send Message"
9. Performance charts (optional enhancement): Line chart showing reviews completed per day over last 30 days
10. Dashboard refreshes every 60 seconds to show updated counts
11. Empty states with helpful messages when no pending tasks
12. Dashboard responsive: Stacked cards on mobile, grid layout on desktop

## Tasks / Subtasks

- [ ] Create agent dashboard layout (AC: 1, 12)
  - [ ] Build dashboard page at `/admin/dashboard`
  - [ ] Implement responsive grid layout (mobile/desktop)
  - [ ] Add placeholder sections for stats, activity, and dossiers
- [ ] Build stats cards component (AC: 2)
  - [ ] Query pending documents count for agent
  - [ ] Query assigned dossiers count
  - [ ] Calculate completed documents for today
  - [ ] Calculate average review time
  - [ ] Create clickable card components with icons
- [ ] Implement activity feed (AC: 3, 4)
  - [ ] Query last 20 events for agent's dossiers from `dossier_events` table
  - [ ] Parse event data and generate descriptions
  - [ ] Format timestamps as relative time (e.g., "2 hours ago")
  - [ ] Add event type icons
  - [ ] Implement infinite scroll or pagination
- [ ] Build "My Dossiers" section (AC: 5, 6, 7, 8)
  - [ ] Query dossiers assigned to agent
  - [ ] Display dossier quick view cards
  - [ ] Show current step and pending documents count
  - [ ] Show last activity timestamp
  - [ ] Add unread message indicator badge
  - [ ] Implement quick action buttons
- [ ] Set up auto-refresh mechanism (AC: 10)
  - [ ] Implement 60-second interval refresh for stats
  - [ ] Use Supabase Realtime to update stats in real-time (optimization)
  - [ ] Prevent unnecessary re-renders
- [ ] Add performance charts (AC: 9)
  - [ ] Query document_reviews grouped by date for last 30 days
  - [ ] Build line chart using charting library (Recharts or Chart.js)
  - [ ] Display reviews completed per day trend
  - [ ] Make chart interactive and responsive
- [ ] Implement empty states (AC: 11)
  - [ ] Show helpful message when no pending reviews
  - [ ] Show message when no assigned dossiers
  - [ ] Add link to available work when empty

## Dev Notes

### Dashboard Data Queries

**Pending Reviews Count:**
```sql
SELECT COUNT(*)
FROM documents
WHERE status = 'PENDING'
  AND dossier_id IN (SELECT id FROM dossiers WHERE assigned_agent_id = current_user_id)
```

**Assigned Dossiers Count:**
```sql
SELECT COUNT(*)
FROM dossiers
WHERE assigned_agent_id = current_user_id
  AND status IN ('QUALIFICATION', 'IN_PROGRESS', 'PENDING_REVIEW')
```

**Completed Today:**
```sql
SELECT COUNT(*)
FROM document_reviews
WHERE agent_id = current_user_id
  AND created_at::date = CURRENT_DATE
```

**Average Review Time:**
```sql
SELECT AVG(EXTRACT(EPOCH FROM (review_created_at - upload_created_at))/3600) as avg_hours
FROM (
  SELECT dr.created_at as review_created_at, d.created_at as upload_created_at
  FROM document_reviews dr
  JOIN documents d ON dr.document_id = d.id
  WHERE dr.agent_id = current_user_id
)
```

### Activity Feed Event Types

- `DOCUMENT_UPLOADED` - "X uploaded Y document for dossier Z"
- `DOCUMENT_REVIEWED` - "Document review completed: X (APPROVED/REJECTED)"
- `DOSSIER_CREATED` - "New dossier created: X"
- `STEP_COMPLETED` - "Workflow step completed: X → Y"
- `MESSAGE_SENT` - "New message from client X"
- `DOSSIER_STATUS_CHANGED` - "Dossier status changed: X → Y"
- `ASSIGNMENT_CHANGED` - "Dossier assigned to agent X"

### Charting Library Configuration

Using Recharts for line chart:
```tsx
<LineChart data={reviewData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="date" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Line type="monotone" dataKey="count" stroke="#00F0FF" />
</LineChart>
```

### Responsive Design

**Mobile:** Single column, stacked cards
**Tablet:** 2-column grid
**Desktop:** 3-4 column grid with flexible layout

### Auto-Refresh Implementation

```tsx
useEffect(() => {
  const interval = setInterval(() => {
    refetchStats(); // Re-query stats
  }, 60000); // 60 seconds

  return () => clearInterval(interval);
}, []);
```

Or use Supabase Realtime subscriptions for real-time updates instead of polling.

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/dashboard/`
**Coverage Requirements:**
- Stats card calculations and display
- Activity feed rendering and formatting
- Dossier quick view cards
- Quick action button functionality
- Responsive layout on different screen sizes
- Auto-refresh mechanism
- Empty state messages

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
