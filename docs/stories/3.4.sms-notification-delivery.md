# Story 3.4: SMS Notification Delivery (Fallback Channel)

## Status

Draft

## Story

**As a** user,
**I want** to receive SMS notifications if WhatsApp delivery fails,
**so that** I'm guaranteed to receive critical updates regardless of my app usage.

## Acceptance Criteria

1. Twilio SMS configured (can use same account as WhatsApp)
2. SMS service module created (`lib/notifications/sms.ts`) with `sendSMS(to, message)` function
3. SMS templates created (shorter versions of email templates due to 160-character limitation)
4. For each SMS notification, `notification_deliveries` record created with `status: PENDING`
5. Message sent via Twilio SMS API
6. Successful send updates delivery: `status: SENT`, `provider_message_id`
7. Failed send updates delivery: `status: FAILED`, `error_message`
8. SMS webhook receives delivery receipts from Twilio
9. Link shortening implemented for SMS (use URL shortener or custom short domain) to save character count
10. SMS notifications sent only when: WhatsApp fails OR user has no WhatsApp number OR user preference is SMS
11. Character limit validation: Messages truncated to 160 chars with "..." if longer
12. Cost tracking: Log SMS costs per message for budget monitoring (Twilio provides pricing via API)
13. Opt-out handling: "Reply STOP to unsubscribe" included in messages (Twilio handles automatically)

## Tasks / Subtasks

- [ ] Configure Twilio SMS (AC: 1)
  - [ ] Use existing Twilio account from Story 3.3
  - [ ] Enable SMS capability if not already enabled
  - [ ] Get SMS-enabled phone number or use same WhatsApp number
  - [ ] Verify SMS credentials in environment variables
- [ ] Create SMS service module (AC: 2)
  - [ ] Create `lib/notifications/sms.ts`
  - [ ] Implement `sendSMS(to, message)` function
  - [ ] Use Twilio client from existing configuration
  - [ ] Add error handling and logging
  - [ ] Create type definitions
- [ ] Create SMS templates (AC: 3)
  - [ ] Document approved notification (max 160 chars)
  - [ ] Document rejected notification (max 160 chars)
  - [ ] Step completed notification (max 160 chars)
  - [ ] Payment reminder notification (max 160 chars)
  - [ ] Payment successful notification (max 160 chars)
  - [ ] Use concise language and abbreviations
- [ ] Create notification processor (AC: 4)
  - [ ] Filter notifications by `channel: SMS`
  - [ ] Check if triggered by WhatsApp failure or user preference
  - [ ] Create `notification_deliveries` record with status PENDING
  - [ ] Pass to SMS service
- [ ] Implement send logic (AC: 5, 6, 7)
  - [ ] Send via Twilio SMS API
  - [ ] Update delivery record on success: `status: SENT`, `provider_message_id`
  - [ ] Update delivery record on failure: `status: FAILED`, `error_message`
  - [ ] Log errors for debugging
- [ ] Configure SMS webhook (AC: 8)
  - [ ] Create webhook endpoint `/api/webhooks/twilio-sms`
  - [ ] Configure webhook URL in Twilio Console
  - [ ] Implement webhook handler for delivery receipts
  - [ ] Update `notification_deliveries` based on webhook events
  - [ ] Handle: delivered, failed events
- [ ] Implement URL shortening (AC: 9)
  - [ ] Choose URL shortener service (TinyURL, custom domain, or custom implementation)
  - [ ] Create function to shorten long URLs
  - [ ] Replace URLs in SMS templates with shortened versions
  - [ ] Test shortened links in SMS
- [ ] Implement fallback logic (AC: 10)
  - [ ] In notification processor, check trigger reason:
    - WhatsApp failed (from Story 3.3 fallback)
    - User has no WhatsApp number
    - User preference set to SMS
  - [ ] Only create SMS notification in these cases
- [ ] Implement character validation (AC: 11)
  - [ ] Validate message length in SMS service
  - [ ] Truncate to 160 chars with "..." if longer
  - [ ] Log truncations for monitoring
  - [ ] Prefer shortening URLs over truncating content
- [ ] Implement cost tracking (AC: 12)
  - [ ] Log SMS send with Twilio API
  - [ ] Query Twilio API for SMS pricing
  - [ ] Store cost in `notification_deliveries.cost`
  - [ ] Create monthly cost report (future dashboard feature)
- [ ] Add opt-out handling (AC: 13)
  - [ ] Include "Reply STOP to unsubscribe" in all SMS messages
  - [ ] Twilio handles STOP replies automatically
  - [ ] Document opt-out process for users
  - [ ] Log opt-outs in system

## Dev Notes

### SMS Integration with Twilio

**Account Configuration:**
- Use same Twilio account as Story 3.3 (WhatsApp)
- Ensure SMS capability enabled
- Use dedicated SMS phone number (can be same as WhatsApp number)
- SMS number should be in format: +[country_code][number]

**Environment Variables:**
- Reuse from Story 3.3:
  - `TWILIO_ACCOUNT_SID`
  - `TWILIO_AUTH_TOKEN`
- Add SMS-specific number if different:
  - `TWILIO_SMS_PHONE` (optional, defaults to WhatsApp number)

### SMS Service Implementation

```typescript
// lib/notifications/sms.ts
import twilio from 'twilio';

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

export async function sendSMS(to: string, message: string) {
  // Validate message length (160 chars max)
  // Truncate or handle if longer
  // Send via Twilio SMS API
  // Return message SID or throw error
  // Log cost information
}
```

### SMS Message Templates

All templates must be <= 160 characters including link:

**Document Approved:**
"Doc approved! Your dossier progressing. View: [short-link]"

**Step Completed:**
"Step X complete! Next step ready. View: [short-link]"

**Payment Reminder:**
"Complete payment for dossier access. Pay now: [stripe-short-link]"

**Payment Successful:**
"Payment received! Dossier ready. View: [short-link]"

**Document Rejected:**
"Doc [type] rejected. Reason: [brief-reason]. View: [link]"

### URL Shortening Strategy

**Option 1: Custom Domain (Recommended)**
- Set up custom short domain (e.g., sms.yourapp.com)
- Register in Twilio
- Redirect to full URLs
- Track clicks via redirect logs

**Option 2: TinyURL API**
- Use TinyURL API for shortening
- Cost: Free tier available
- Example: `GET https://tinyurl.com/api-create.php?url=[long_url]`

**Option 3: Custom Implementation**
- Create short codes in database
- Store mapping of short_code â†’ long_url
- Endpoint `/s/[short_code]` redirects to full URL

### Fallback Flow Coordination

**From Story 3.3 (WhatsApp Failure):**
1. WhatsApp send fails (invalid number, user not on WhatsApp)
2. Catch error in WhatsApp service
3. Create new notification record with `channel: SMS`
4. Story 3.4 SMS processor picks up and sends

**User Preference Option:**
1. User sets notification preference to SMS only
2. Notification processor checks user preference
3. Create SMS notification instead of WhatsApp

### Cost Tracking

**Twilio SMS Pricing:**
- Each SMS message has variable cost (~$0.0075 in US, varies by country)
- Twilio API provides cost via response metadata
- Store cost in `notification_deliveries.cost` field
- Aggregate for monthly reporting

```typescript
// In SMS send handler:
const message = await client.messages.create({...});
const cost = message.price; // May need to query separately
// Store in database
```

### Opt-Out Compliance

**Twilio Automatic Handling:**
- Twilio automatically recognizes "STOP" replies
- User added to do-not-contact list
- Subsequent sends to that number rejected by Twilio
- Set up webhook to catch rejection errors

**User-Side Option:**
- Create notification preferences page (future)
- Users can manually disable SMS notifications
- Respect user preferences in notification processor

### Testing Standards

- **Test location:** `__tests__/integration/sms-notifications.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Mock Twilio API, verify calls, check database updates
- **Specific requirements:**
  - Verify message length validation (160 chars max)
  - Verify character truncation with "..."
  - Verify PENDING delivery record created
  - Verify SENT status on successful send
  - Verify FAILED status on send errors
  - Verify cost captured for budget tracking
  - Verify fallback trigger from WhatsApp failure
  - Verify SMS only sent when conditions met (AC: 10)
  - Verify opt-out message included
  - Verify URL shortening works (links in SMS valid)
  - Verify webhook receives delivery receipts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
