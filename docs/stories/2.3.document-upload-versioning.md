# Story 2.3: Document Upload with Versioning Support

## Status

Draft

## Story

**As a** client,
**I want** to upload required documents for my dossier with drag-and-drop support,
**so that** I can easily submit the materials needed to progress my case.

## Acceptance Criteria

1. Document upload area supports drag-and-drop for files (PDF, JPG, PNG)
2. Click-to-browse alternative for users who prefer file picker
3. File type validation: Only PDF, JPG, PNG accepted (show error for other types)
4. File size validation: Maximum 10MB per file (show error if exceeded)
5. Upload progress bar shown during file transfer to Supabase Storage
6. On successful upload, `documents` record created with: `dossier_id`, `document_type_id`, `step_instance_id`, `uploaded_by: USER`
7. `document_versions` record created with: `document_id`, `version_number: 1`, `file_path`, `file_size`, `mime_type`, `status: PENDING`
8. `documents.current_version_id` set to newly created version
9. File uploaded to Supabase Storage in organized bucket: `documents/{dossier_id}/{document_type_slug}/{version}.{ext}`
10. Upload trigger fires `create_document_upload_event()` creating event in `events` table
11. Document appears in document list immediately with "Under Review" status badge
12. Multiple documents can be uploaded for same type (if re-uploading after rejection)
13. Error handling: Storage errors show user-friendly message with retry option
14. Success toast notification: "Document uploaded successfully. You'll be notified when it's reviewed."
15. Upload disabled for documents already APPROVED (show "Approved" checkmark instead)

## Tasks / Subtasks

- [ ] Create document upload component (AC: 1, 2)
  - [ ] Build drag-and-drop zone
  - [ ] Implement click-to-browse file picker
  - [ ] Support both input methods
- [ ] Implement file validation (AC: 3, 4)
  - [ ] Validate file type (PDF, JPG, PNG only)
  - [ ] Validate file size (max 10MB)
  - [ ] Show validation error messages to user
- [ ] Build upload progress UI (AC: 5)
  - [ ] Create progress bar component
  - [ ] Show percentage during upload
  - [ ] Display file name and size
- [ ] Implement Supabase Storage upload (AC: 9)
  - [ ] Upload file to Supabase Storage
  - [ ] Organize in bucket path: `documents/{dossier_id}/{document_type_slug}/{version}.{ext}`
  - [ ] Handle upload errors with user-friendly messages
- [ ] Create database records (AC: 6, 7, 8)
  - [ ] Create `documents` record with dossier_id, document_type_id, step_instance_id, uploaded_by
  - [ ] Create `document_versions` record with file_path, file_size, mime_type, status: PENDING
  - [ ] Set `documents.current_version_id` to newly created version
- [ ] Implement document upload event trigger (AC: 10)
  - [ ] Trigger `create_document_upload_event()` on successful upload
  - [ ] Create event in `events` table
- [ ] Update document list UI (AC: 11)
  - [ ] Show newly uploaded document immediately
  - [ ] Display "Under Review" status badge
- [ ] Handle multiple uploads for same type (AC: 12)
  - [ ] Allow re-uploading same document type
  - [ ] Create new version record
- [ ] Implement error handling (AC: 13)
  - [ ] Catch and display Storage errors
  - [ ] Show retry button on failure
- [ ] Add success notification (AC: 14)
  - [ ] Show toast: "Document uploaded successfully. You'll be notified when it's reviewed."
- [ ] Disable upload for approved documents (AC: 15)
  - [ ] Check if document status is APPROVED
  - [ ] Hide upload button for approved documents
  - [ ] Show "Approved" checkmark instead

## Dev Notes

### Supabase Storage Configuration

**Bucket Path Structure:**
```
documents/{dossier_id}/{document_type_slug}/{version}.{ext}
```

Example: `documents/550e8400-e29b-41d4-a716-446655440000/identity_card/1.pdf`

**File Size Limit:** 10MB per file
**Allowed Types:** PDF, JPG, PNG (MIME types: application/pdf, image/jpeg, image/png)

### Database Schema

**Documents Table:**
- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `document_type_id`: UUID foreign key
- `step_instance_id`: UUID foreign key
- `uploaded_by`: ENUM (USER, AGENT)
- `current_version_id`: UUID foreign key to document_versions (nullable)
- `created_at`: timestamp

**Document Versions Table:**
- `id`: UUID primary key
- `document_id`: UUID foreign key
- `version_number`: integer (1, 2, 3, ...)
- `file_path`: text (storage path)
- `file_size`: integer (bytes)
- `mime_type`: text
- `status`: ENUM (PENDING, APPROVED, REJECTED, OUTDATED)
- `created_at`: timestamp

**Document Types Table:**
- `id`: UUID primary key
- `product_id`: UUID foreign key
- `name`: text
- `description`: text
- `slug`: text (lowercase, hyphenated)

**Events Table:**
- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `event_type`: ENUM (DOSSIER_CREATED, DOCUMENT_UPLOADED, ...)
- `payload`: JSON
- `created_at`: timestamp

### Upload Flow

1. User selects file via drag-drop or file picker
2. Validate file type and size (client-side)
3. Show progress bar
4. Upload to Supabase Storage
5. On success, create documents and document_versions records
6. Trigger document upload event
7. Show success toast
8. Update UI to show new document with "Under Review" status
9. On error, show error message with retry button

### Server Action Pattern

Create a Server Action for creating database records:
```typescript
// app/dashboard/dossiers/[id]/upload-document.ts
'use server'

export async function uploadDocument(
  dossier_id: string,
  document_type_id: string,
  step_instance_id: string,
  file_path: string,
  file_size: number,
  mime_type: string
) {
  // Create documents record
  // Create document_versions record
  // Update documents.current_version_id
  // Trigger event
  // Return success
}
```

### Client-Side Upload

Use Supabase client to upload to Storage:
```typescript
const { data, error } = await supabase.storage
  .from('documents')
  .upload(storagePath, file);
```

### RLS Policies

Allow users to upload documents only for their own dossiers:
```sql
CREATE POLICY "Users can upload docs to own dossiers" ON documents
  FOR INSERT WITH CHECK (
    dossier_id IN (
      SELECT id FROM dossiers WHERE user_id = auth.uid()
    )
  );
```

### Component Architecture

- **DocumentUpload Component:** Client Component with drag-drop and file picker
- **FileValidation Hook:** Validates file type and size
- **UploadProgress Component:** Shows progress bar
- **DocumentList Component:** Displays uploaded documents with status
- **SuccessToast Component:** Shows success notification

### Testing

- Test drag-and-drop file upload
- Test file picker upload
- Test file type validation (reject non-PDF/JPG/PNG)
- Test file size validation (reject files >10MB)
- Test progress bar display
- Test document appears in list with "Under Review" status
- Test approved documents show checkmark and disable upload
- Test error handling with retry
- Test multiple versions for same document type
- Test event trigger creates database entry

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
