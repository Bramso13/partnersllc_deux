# Story 2.6: Rejected Document Handling and Re-Upload

## Status

Done

## Story

**As a** client,
**I want** clear notification when my document is rejected with the reason, and the ability to upload a corrected version,
**so that** I can fix issues and resubmit without confusion.

## Acceptance Criteria

1. When document rejected, notification created (via event trigger - will be implemented in Epic 3, for now just UI state)
2. Dossier detail page shows rejected document with red "Rejected" badge
3. Rejection reason displayed clearly below document: "This document was rejected: [agent's reason]"
4. "Upload New Version" button appears next to rejected document
5. Clicking "Upload New Version" opens file upload dialog for that specific document type
6. New upload creates new `document_versions` record with incremented version number (v2, v3, etc.)
7. Old version marked as `status: OUTDATED`
8. New version becomes `current_version_id` on parent `documents` record
9. New version starts with `status: PENDING` requiring new agent review
10. Document list shows version history: "Version 2 (Under Review)" with expandable "View previous versions" section
11. Previous versions display with status and review history
12. Agent reviewing new version can see all previous versions and rejection reasons in modal sidebar
13. Approved documents cannot be re-uploaded (upload button hidden for APPROVED documents)
14. Re-upload follows same validation rules (file type, size) as initial upload

## Tasks / Subtasks

- [ ] Update dossier detail page to show rejected documents (AC: 2, 3)
  - [ ] Query rejected document versions
  - [ ] Display "Rejected" badge (red)
  - [ ] Show rejection reason below document
- [ ] Build "Upload New Version" button (AC: 4)
  - [ ] Create button component
  - [ ] Show only for REJECTED documents
  - [ ] Position next to rejected document
- [ ] Implement re-upload dialog (AC: 5)
  - [ ] Open file upload dialog
  - [ ] Filter for specific document type
  - [ ] Reuse upload component from Story 2.3
- [ ] Implement version increment logic (AC: 6)
  - [ ] Query current max version_number
  - [ ] Create new document_versions with version_number + 1
  - [ ] Store in database with new version
- [ ] Mark old versions as OUTDATED (AC: 7)
  - [ ] Update previous `document_versions.status` to OUTDATED
  - [ ] Keep for history/audit trail
- [ ] Update current_version_id (AC: 8)
  - [ ] Set `documents.current_version_id` to new version
  - [ ] Update parent document record
- [ ] Set new version to PENDING (AC: 9)
  - [ ] Create document_versions with `status: PENDING`
  - [ ] Trigger document review event
  - [ ] Queue for agent review
- [ ] Build version history display (AC: 10)
  - [ ] Show current version with status: "Version 2 (Under Review)"
  - [ ] Create expandable "View previous versions" section
  - [ ] Display all previous versions
- [ ] Show version history details (AC: 11)
  - [ ] Display version number and status for each
  - [ ] Show review history (approval/rejection)
  - [ ] Show rejection reason if applicable
- [ ] Implement agent view of version history (AC: 12)
  - [ ] Show all previous versions in review modal sidebar
  - [ ] Display rejection reasons for rejected versions
  - [ ] Allow agent to compare versions
- [ ] Hide upload for approved documents (AC: 13)
  - [ ] Check if current version status is APPROVED
  - [ ] Hide "Upload New Version" button
  - [ ] Show "Approved" checkmark instead
- [ ] Validate re-upload (AC: 14)
  - [ ] Apply same file type validation
  - [ ] Apply same file size validation (max 10MB)
  - [ ] Show error messages if validation fails

## Dev Notes

### Database Context

**Document Versions Table:**

- `id`: UUID primary key
- `document_id`: UUID foreign key
- `version_number`: integer (1, 2, 3, ...)
- `file_path`: text (Supabase Storage path)
- `file_size`: integer (bytes)
- `mime_type`: text
- `status`: ENUM (PENDING, APPROVED, REJECTED, OUTDATED)
- `created_at`: timestamp

**Document Reviews Table:**

- `id`: UUID primary key
- `document_version_id`: UUID foreign key
- `reviewer_id`: UUID foreign key
- `review_status`: ENUM (APPROVED, REJECTED)
- `rejection_reason`: text (nullable)
- `reviewed_at`: timestamp

**Documents Table:**

- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `document_type_id`: UUID foreign key
- `step_instance_id`: UUID foreign key
- `uploaded_by`: ENUM (USER, AGENT)
- `current_version_id`: UUID foreign key to document_versions
- `created_at`: timestamp

### Query for Rejected Document with Review Reason

```typescript
// Get current version and its rejection reason
SELECT
  dv.id,
  dv.version_number,
  dv.status,
  dr.rejection_reason,
  dr.reviewed_at
FROM document_versions dv
LEFT JOIN document_reviews dr ON dv.id = dr.document_version_id
WHERE dv.document_id = $1
  AND dv.id = (
    SELECT current_version_id FROM documents WHERE id = $1
  )
```

### Query for Version History

```typescript
// Get all versions of a document
SELECT
  dv.id,
  dv.version_number,
  dv.status,
  dv.created_at,
  dr.review_status,
  dr.rejection_reason,
  dr.reviewed_at
FROM document_versions dv
LEFT JOIN document_reviews dr ON dv.id = dr.document_version_id
WHERE dv.document_id = $1
ORDER BY dv.version_number DESC
```

### Re-Upload Flow

1. User clicks "Upload New Version" button
2. File picker/drag-drop opens (same component as initial upload)
3. Validate file type and size
4. Upload to Supabase Storage with new path:
   ```
   documents/{dossier_id}/{document_type_slug}/{version}.{ext}
   ```
5. Create new `document_versions` record with version_number + 1
6. Update `documents.current_version_id` to new version
7. Mark old version as OUTDATED
8. Trigger document upload event
9. Show success toast
10. Update UI to show new version with "Under Review" status

### Storage Path Structure

Old: `documents/{dossier_id}/{document_type_slug}/1.pdf`
New: `documents/{dossier_id}/{document_type_slug}/2.pdf`
Next: `documents/{dossier_id}/{document_type_slug}/3.pdf`

Extract version number from path or store separately.

### Server Action for Re-Upload

```typescript
// app/dashboard/dossiers/[id]/re-upload-document.ts
"use server";

export async function reUploadDocument(
  documentId: string,
  dossier_id: string,
  file_path: string,
  file_size: number,
  mime_type: string
) {
  // Query current max version_number
  const maxVersion = await getMaxVersionNumber(documentId);
  const newVersionNumber = maxVersion + 1;

  // Create new document_versions record
  // Update documents.current_version_id
  // Mark old versions as OUTDATED
  // Trigger document upload event
  // Return success
}
```

### Component Architecture

- **DocumentCard Component:** Shows document with rejection status
- **RejectionReasonDisplay Component:** Shows rejection reason below document
- **UploadNewVersionButton Component:** Triggers re-upload flow
- **VersionHistory Component:** Expandable section showing all versions
- **VersionHistoryItem Component:** Individual version with status and review info
- **DocumentUploadDialog Component:** File picker for re-upload (reuses from Story 2.3)

### Rejection Reason Display

Show in clear, readable format:

```
❌ Rejected
This document was rejected: [agent's exact rejection reason]
Rejected on: [date and time]
```

### Version Display Format

```
Version 2 (Under Review)
├─ Version 1 (Rejected)
│  └─ Rejection reason: Document quality too low, please resubmit higher resolution version
└─ Version 0 (Archived)
```

Or:

```
Currently reviewing: Version 2
View previous versions (1)
```

### Testing

- Test rejected documents show "Rejected" badge
- Test rejection reason displays correctly
- Test "Upload New Version" button appears for rejected documents
- Test "Upload New Version" hidden for approved documents
- Test file picker opens on button click
- Test new version has incremented version_number
- Test old version marked as OUTDATED
- Test current_version_id updated to new version
- Test new version status is PENDING
- Test version history displays all versions
- Test expansion/collapse of version history
- Test agent can see all versions in review modal
- Test re-upload validation (file type, size)
- Test success notification on re-upload

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be documented here._
