# Story 1.5: Stripe Integration Setup and Configuration

## Status

Ready for Review

## Story

**As a** developer,
**I want** Stripe configured for test mode with Products, Prices, and webhook endpoints ready,
**so that** the application can create Checkout Sessions and handle payment events.

## Acceptance Criteria

1. Stripe account created (or existing account configured) with test mode enabled
2. Stripe API keys added to environment variables (`STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`)
3. Stripe TypeScript SDK installed (`stripe` package) and initialized in server utility (`lib/stripe.ts`)
4. Two test products created in Stripe Dashboard: "LLC Formation - $999", "Dubai Company Setup - $1,499"
5. Stripe Product IDs and Price IDs documented in `.env.example`
6. Stripe webhook endpoint URL configured (pointing to deployed Vercel URL `/api/webhooks/stripe`)
7. Webhook events subscribed: `checkout.session.completed`, `payment_intent.succeeded`
8. Webhook signing secret added to environment variables (`STRIPE_WEBHOOK_SECRET`)
9. Stripe webhook test event sent successfully to endpoint (returns 200 OK)
10. Stripe CLI installed locally for webhook testing during development

## Tasks / Subtasks

- [ ] Set up Stripe account (AC: 1)
  - [ ] Create/access Stripe account
  - [ ] Enable test mode
  - [ ] Navigate to API keys section
- [ ] Add Stripe API keys to environment (AC: 2, 5)
  - [ ] Copy secret key to .env.local as `STRIPE_SECRET_KEY`
  - [ ] Copy publishable key to .env.local as `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
  - [x] Document keys in .env.example
- [x] Install and initialize Stripe SDK (AC: 3)
  - [x] Run `pnpm add stripe`
  - [x] Create `lib/stripe.ts`
  - [x] Initialize Stripe with secret key
- [ ] Create test products in Stripe Dashboard (AC: 4, 5)
  - [ ] Create "LLC Formation" product with $999 price
  - [ ] Create "Dubai Company Setup" product with $1,499 price
  - [ ] Copy Product IDs and Price IDs
  - [x] Document IDs in .env.example
- [ ] Configure webhook endpoint (AC: 6, 7, 8)
  - [ ] Add webhook endpoint URL in Stripe Dashboard
  - [ ] Subscribe to `checkout.session.completed` event
  - [ ] Subscribe to `payment_intent.succeeded` event
  - [ ] Copy webhook signing secret to .env.local as `STRIPE_WEBHOOK_SECRET`
- [ ] Test webhook endpoint (AC: 9)
  - [x] Create basic webhook handler (will be fully implemented in story 1.9)
  - [ ] Send test event from Stripe Dashboard
  - [ ] Verify endpoint returns 200 OK
- [ ] Install Stripe CLI (AC: 10)
  - [ ] Download and install Stripe CLI
  - [ ] Authenticate CLI with account
  - [ ] Test local webhook forwarding

## Dev Notes

### Stripe SDK Initialization

```typescript
// lib/stripe.ts
import Stripe from "stripe";

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: "2025-12-15.clover",
  typescript: true,
});
```

### Stripe Products

Create two products in Stripe Dashboard for testing:

**Product 1: LLC Formation**

- Name: LLC Formation
- Price: $999 USD (one-time payment)
- Description: Complete LLC formation service

**Product 2: Dubai Company Setup**

- Name: Dubai Company Setup
- Price: $1,499 USD (one-time payment)
- Description: Complete Dubai company formation service

### Webhook Configuration

**Webhook Events:**

- `checkout.session.completed` - Fired when customer completes Checkout Session
- `payment_intent.succeeded` - Fired when payment succeeds

**Webhook Endpoint:** `https://your-vercel-url.vercel.app/api/webhooks/stripe`

### Stripe CLI Usage

For local development webhook testing:

```bash
# Login to Stripe
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Trigger test event
stripe trigger checkout.session.completed
```

### Environment Variables

Required Stripe environment variables:

- `STRIPE_SECRET_KEY` - Secret key for server-side operations
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` - Publishable key for client-side
- `STRIPE_WEBHOOK_SECRET` - Webhook signing secret
- `STRIPE_PRICE_ID_LLC` - Price ID for LLC Formation product
- `STRIPE_PRICE_ID_DUBAI` - Price ID for Dubai Company Setup product

### Testing

Manual testing:

- Verify Stripe SDK initializes correctly
- Test creating products in Stripe Dashboard
- Test webhook endpoint receives events
- Test Stripe CLI local webhook forwarding

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - Aucune erreur rencontrée lors de l'implémentation. Correction de la version de l'API Stripe de "2023-10-16" à "2025-12-15.clover" pour compatibilité avec le SDK installé.

### Completion Notes

- Package Stripe installé avec succès (`stripe@20.1.2`)
- SDK Stripe initialisé dans `lib/stripe.ts` avec gestion d'erreur si la clé secrète n'est pas configurée
- Webhook handler basique créé dans `app/api/webhooks/stripe/route.ts` avec :
  - Vérification de la signature Stripe
  - Gestion des événements `checkout.session.completed` et `payment_intent.succeeded` (logs pour l'instant, implémentation complète dans story 1.9)
  - Retour 200 OK pour les événements valides
- `.env.example` mis à jour avec :
  - Variables Stripe existantes (déjà présentes)
  - Ajout des variables `STRIPE_PRICE_ID_LLC` et `STRIPE_PRICE_ID_DUBAI` pour documenter les Price IDs
- Code validé : aucune erreur TypeScript ou linting

**Tâches restantes (actions manuelles requises)** :

- Configuration du compte Stripe et récupération des clés API (AC: 1, 2)
- Création des produits dans le Stripe Dashboard (AC: 4)
- Configuration du webhook endpoint dans le Stripe Dashboard avec l'URL Vercel déployée (AC: 6, 7, 8)
- Test du webhook avec un événement depuis le Dashboard (AC: 9)
- Installation et configuration de Stripe CLI pour le développement local (AC: 10)

**Note importante** : Le webhook handler est prêt à recevoir des événements mais nécessite que l'endpoint soit déployé sur Vercel et configuré dans le Stripe Dashboard pour les tests complets.

### File List

- `partnersllc-app/lib/stripe.ts` (créé)
- `partnersllc-app/app/api/webhooks/stripe/route.ts` (créé)
- `partnersllc-app/.env.example` (modifié - ajout des Price IDs)
- `partnersllc-app/package.json` (modifié - ajout de la dépendance stripe)

## QA Results

_Results from QA Agent review will be documented here._
