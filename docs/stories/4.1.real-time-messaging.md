# Story 4.1: Real-Time Messaging System (User â†” Agent)

## Status

Draft

## Story

**As a** user,
**I want** to send messages to agents about my dossier and receive responses in real-time,
**so that** I can ask questions, provide clarifications, and communicate without leaving the platform.

## Acceptance Criteria

1. Message thread component embedded in dossier detail page (`/dashboard/dossiers/[id]`)
2. Messages fetched from `messages` table filtered by `dossier_id` with RLS enforcement
3. Messages displayed chronologically (oldest first or newest first, user preference toggle)
4. Each message shows: Sender name/avatar, Message text, Timestamp, Read status
5. User messages aligned right (blue background), agent messages aligned left (gray background), system messages centered (light background)
6. Message input textarea at bottom with "Send" button
7. Textarea supports multi-line input, expands up to 5 lines, includes character counter (max 2000 characters)
8. Send button disabled when textarea empty or exceeds character limit
9. Sending message creates `messages` record: `dossier_id`, `sender_type: USER`, `sender_id`, `message_text`, `created_at`
10. Message appears immediately in thread (optimistic UI update)
11. Supabase Realtime subscription on `messages` table filtered by dossier_id
12. New messages from agent appear in real-time without page refresh with subtle notification sound (optional, user can mute)
13. Sending message creates `MESSAGE_SENT` event triggering notification to assigned agent
14. Unread message count badge shown on dossier card and in notifications bell
15. Messages marked as read when user views dossier (`read_at: now()`)
16. File attachment support: Allow attaching images/PDFs (stored in Supabase Storage, link in `attachments` JSONB field)
17. Agent view (at `/admin/dossiers/[id]`) includes same message thread with agent's ability to respond
18. Typing indicator shows "Agent is typing..." when agent is composing response (via Supabase Realtime presence)

## Tasks / Subtasks

- [ ] Create message thread component (AC: 1)
  - [ ] Build message list display component with chronological ordering
  - [ ] Implement message direction toggle (oldest/newest first)
  - [ ] Add message styling (user/agent/system message variants)
- [ ] Set up database queries with RLS (AC: 2)
  - [ ] Query messages filtered by dossier_id from Supabase
  - [ ] Ensure RLS policies enforce user/agent visibility
  - [ ] Create database helper functions for message queries
- [ ] Implement message display formatting (AC: 3, 4, 5)
  - [ ] Display sender name and avatar
  - [ ] Show formatted timestamp (relative or absolute)
  - [ ] Display read status indicator
  - [ ] Apply CSS styles for message alignment and background colors
- [ ] Build message input UI (AC: 6, 7, 8)
  - [ ] Create textarea component that expands up to 5 lines
  - [ ] Add character counter (max 2000 characters)
  - [ ] Implement send button with disabled state logic
- [ ] Implement message sending logic (AC: 9, 10)
  - [ ] Create message in database
  - [ ] Show optimistic UI update immediately
  - [ ] Handle send button loading state
- [ ] Set up Supabase Realtime subscription (AC: 11, 12, 18)
  - [ ] Subscribe to messages table filtered by dossier_id
  - [ ] Listen for new messages in real-time
  - [ ] Update UI when new messages arrive
  - [ ] Implement typing indicator via Supabase presence
  - [ ] Add optional notification sound (with mute option)
- [ ] Implement event creation and notifications (AC: 13)
  - [ ] Create MESSAGE_SENT event when user sends message
  - [ ] Trigger notification to assigned agent
  - [ ] Handle notification delivery via Supabase notifications table
- [ ] Add unread message tracking (AC: 14, 15)
  - [ ] Add unread count badge on dossier cards
  - [ ] Mark messages as read when dossier is viewed
  - [ ] Update notification bell with unread count
- [ ] Implement file attachment feature (AC: 16)
  - [ ] Add file picker to message input
  - [ ] Upload files to Supabase Storage
  - [ ] Store attachment links in messages.attachments JSONB field
  - [ ] Display attachment previews/downloads in message thread
- [ ] Build agent message view (AC: 17)
  - [ ] Replicate message thread component in agent dossier view
  - [ ] Add agent message sending capability
  - [ ] Ensure RLS allows agents to send messages

## Dev Notes

### Supabase Realtime Configuration

**Realtime Subscriptions:**
- Subscribe to `messages` table with `eq` filter on `dossier_id`
- Presence channel for typing indicators on pattern: `dossier:{dossier_id}:typing`
- Broadcast channel for presence updates: `dossier:{dossier_id}:presence`

**Message Schema:**
```
messages table:
- id: uuid (PK)
- dossier_id: uuid (FK)
- sender_type: enum (USER, AGENT, SYSTEM)
- sender_id: uuid
- message_text: text
- attachments: jsonb (array of {filename, url, type})
- read_at: timestamp (nullable)
- created_at: timestamp
- updated_at: timestamp
```

**Presence Data Structure:**
```
{
  user_id: uuid,
  sender_type: "USER" | "AGENT",
  typing: boolean,
  typing_since: timestamp
}
```

### UI Component Structure

**MessageThread Component:**
- MessageList (scrollable container)
  - MessageItem (individual message)
    - MessageAvatar
    - MessageContent
    - MessageTimestamp
    - ReadStatusIndicator
    - AttachmentList
- MessageInput
  - Textarea with auto-expand
  - CharacterCounter
  - FileAttachmentButton
  - SendButton
- TypingIndicator (conditionally rendered)

### Character Limit & Validation

- Maximum 2000 characters per message
- Textarea disabled when limit exceeded
- Counter shows: "150 / 2000"
- Real-time character counting as user types

### Notification Events

**MESSAGE_SENT event:**
```json
{
  "event_type": "MESSAGE_SENT",
  "dossier_id": "uuid",
  "message_id": "uuid",
  "sender_id": "uuid",
  "sender_type": "USER",
  "created_at": "timestamp"
}
```

### Testing

**Standard Testing Framework:** Vitest with React Testing Library
**Test File Location:** `__tests__/features/messaging/`
**Coverage Requirements:**
- Message subscription and real-time updates
- Message sending and optimistic UI
- Character counter validation
- File upload functionality
- RLS enforcement
- Typing indicators

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
