# Story 3.6: Automated Workflow Step Completion

## Status

Draft

## Story

**As a** system,
**I want** to automatically complete workflow steps when all required documents are approved,
**so that** dossiers progress without requiring manual agent intervention for straightforward cases.

## Acceptance Criteria

1. Database trigger or Edge Function monitors `document_reviews` table for new APPROVED reviews
2. When document approved, check if step completion conditions met: `are_step_documents_complete(step_instance_id)`
3. If TRUE (all required docs approved), automatically mark step as completed: `step_instances.completed_at: now()`
4. Call `get_next_step_for_dossier(dossier_id)` to get next step
5. If next step exists, start it: `step_instances.started_at: now()`
6. Update `dossiers.current_step_instance_id` to next step
7. Create event: `STEP_COMPLETED` with actor: SYSTEM
8. Create event: `STEP_STARTED` for next step
9. Create notification: "Step X completed! You can now proceed to Step Y."
10. If final step completed, update `dossiers.status: COMPLETED`, `completed_at: now()`
11. Create notification: "Congratulations! Your [Product Name] dossier is complete."
12. Automation can be disabled per product via `products.auto_complete_steps` flag (defaults to TRUE)
13. Manual override still available: Agents can manually complete steps from admin interface
14. Audit log shows whether step was auto-completed or manually completed (actor_type: SYSTEM vs AGENT)
15. E2E test: Upload all docs → Agent approves all → Verify step auto-completes within 5 seconds

## Tasks / Subtasks

- [ ] Create step completion helper functions (AC: 2, 4)
  - [ ] Create `are_step_documents_complete(step_instance_id)` function
  - [ ] Query all required documents for step
  - [ ] Check all have APPROVED reviews
  - [ ] Return boolean (AC: 2)
  - [ ] Create `get_next_step_for_dossier(dossier_id)` function
  - [ ] Return next step template or null if at end (AC: 4)
  - [ ] Query workflow template for dossier's product
- [ ] Create database trigger or Edge Function (AC: 1)
  - [ ] Monitor `document_reviews` table for INSERT with status=APPROVED
  - [ ] Trigger immediately on new approved review
  - [ ] Call step completion check function
  - [ ] Call automation logic if conditions met
  - [ ] Option A: Database trigger (PL/pgSQL)
  - [ ] Option B: Edge Function (TypeScript) with webhook from `document_reviews` trigger
- [ ] Implement step completion logic (AC: 3, 6, 10)
  - [ ] When all docs approved, mark step completed: `step_instances.completed_at = now()`
  - [ ] Update dossier's current_step_instance_id to next step (AC: 6)
  - [ ] If final step, mark dossier COMPLETED: `dossiers.status = COMPLETED`, `completed_at = now()` (AC: 10)
- [ ] Implement step start logic (AC: 5)
  - [ ] If next step exists, create new step_instances record
  - [ ] Set `started_at: now()`
  - [ ] Set product_id and step_template_id
  - [ ] Set dossier_id
- [ ] Create events for step progression (AC: 7, 8)
  - [ ] Create STEP_COMPLETED event with actor: SYSTEM
  - [ ] Include step_id, step_name, dossier_id in payload
  - [ ] Create STEP_STARTED event for next step
  - [ ] Include next step_id, step_name, dossier_id in payload
- [ ] Create notifications (AC: 9, 11)
  - [ ] Create notification: "Step X completed! You can now proceed to Step Y."
  - [ ] If final step, create: "Congratulations! Your [Product Name] dossier is complete."
  - [ ] Include relevant links to dossier
  - [ ] Include in all channels (Email, WhatsApp, SMS, In-App) - handled by notification processor
- [ ] Add product automation flag (AC: 12)
  - [ ] Check `products.auto_complete_steps` flag before automation
  - [ ] Default to TRUE for backward compatibility
  - [ ] Allow admins to disable per product
  - [ ] Log flag value in completion event
- [ ] Maintain manual override capability (AC: 13)
  - [ ] Agents can still manually complete steps from admin interface
  - [ ] Manual completion updates same fields as automation
  - [ ] Respects same workflow logic
- [ ] Implement audit logging (AC: 14)
  - [ ] In event payload, include actor_type: SYSTEM or AGENT
  - [ ] Log whether automation triggered or manual action
  - [ ] Maintain in event timeline for audit trail
  - [ ] Make visible in admin dashboard
- [ ] Create E2E test (AC: 15)
  - [ ] Upload all required documents for a step
  - [ ] Agent approves all documents
  - [ ] Wait for automation to trigger (< 5 seconds expected)
  - [ ] Verify step marked as completed
  - [ ] Verify next step started
  - [ ] Verify events created
  - [ ] Verify notifications created
  - [ ] Verify dossier.current_step_instance_id updated

## Dev Notes

### Step Completion Architecture

The automation flow:
1. Agent approves last required document for a step
2. Trigger fires on `document_reviews` INSERT (Story 3.1)
3. Edge Function processes trigger, calls helper functions
4. If all docs approved → complete step & start next
5. Create events (for Story 3.1 timeline)
6. Create notifications (for Stories 3.2-3.5)

### Helper Functions

**are_step_documents_complete(step_instance_id)**
```sql
-- Query step_templates to get required documents
-- Query document_reviews to get approved documents
-- Compare sets and return boolean
```

**get_next_step_for_dossier(dossier_id)**
```sql
-- Get dossier's product
-- Get product's workflow template
-- Get current step number
-- Return next step template or NULL
```

### Trigger Implementation (Option A: Database)

PL/pgSQL trigger that:
1. On INSERT to `document_reviews` with status=APPROVED
2. Get step_instance_id from document
3. Call `are_step_documents_complete()`
4. If true:
   - UPDATE step_instances SET completed_at = now()
   - Call get_next_step_for_dossier()
   - If next step: INSERT into step_instances, UPDATE dossiers.current_step_instance_id
   - INSERT STEP_COMPLETED event
   - INSERT STEP_STARTED event (if exists)
   - INSERT notifications

### Edge Function Implementation (Option B)

TypeScript Edge Function at `/api/workflows/auto-complete-step`:
1. Receives webhook from document_reviews trigger (Story 3.1)
2. Calls Supabase client
3. Implements same logic as trigger
4. Better error handling and logging
5. Easier to test and debug

**Recommendation:** Use Edge Function for better maintainability and error handling

### Product Automation Flag

Add to `products` table:
```sql
ALTER TABLE products ADD COLUMN auto_complete_steps BOOLEAN DEFAULT TRUE;
```

Check in automation:
```typescript
const product = await getProduct(dossier.product_id);
if (!product.auto_complete_steps) {
  // Skip automation, log that flag is disabled
  return;
}
```

### Audit Trail

Event payload for STEP_COMPLETED should include:
```typescript
{
  step_instance_id: uuid,
  step_name: string,
  dossier_id: uuid,
  actor_type: 'SYSTEM' | 'AGENT',
  automation_enabled: boolean,
  completed_by_automation: boolean,
  previous_step_id: uuid,
  next_step_id: uuid | null,
}
```

### Notification Content

**Step Completion Example:**
```
Title: "Step 1 Complete!"
Message: "Your documents have been approved. Step 2 (Identity Verification) is now ready. You can proceed whenever you're ready."
Resource: dossier_id
Type: STEP_COMPLETED
```

**Final Step Completion Example:**
```
Title: "Dossier Complete!"
Message: "Congratulations! Your LLC Formation dossier is complete. You'll receive your final documents shortly."
Resource: dossier_id
Type: DOSSIER_COMPLETED
```

### Testing Edge Cases

1. **Multiple documents in step:**
   - Upload 2/3 documents, agent approves 1
   - Step should NOT complete (wait for 2/3)
   - Approve second document
   - Step still incomplete (wait for 3/3)
   - Approve third document
   - Step completes and next starts

2. **Final step completion:**
   - Complete penultimate step
   - Verify next (final) step starts
   - Complete final step
   - Verify dossier marked COMPLETED
   - Verify completion notification sent

3. **Automation disabled:**
   - Set product.auto_complete_steps = FALSE
   - Upload and approve all documents
   - Step should NOT auto-complete
   - Agents can still manually complete

4. **Manual override:**
   - Automation completes step
   - Verify event shows actor_type: SYSTEM
   - Then test agent manually completing different step
   - Verify event shows actor_type: AGENT

### Testing Standards

- **Test location:** `__tests__/integration/workflow-automation.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Create dossier, upload docs, approve docs, verify automation
- **Specific requirements:**
  - Verify helper functions return correct values
  - Verify step completes when all docs approved
  - Verify next step starts automatically
  - Verify events created with actor_type: SYSTEM
  - Verify notifications created
  - Verify dossier status updated to COMPLETED on final step
  - Verify automation respects auto_complete_steps flag
  - Verify audit trail shows SYSTEM actor for automation
  - E2E test: Multi-doc step approval → Auto-completion within 5 seconds

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
