# Story 1.7: Payment Link Registration Page (Client-Facing)

## Status
Ready for Review

## Story

**As a** prospect,
**I want** to click a payment link and complete my registration in a single guided flow,
**so that** I can quickly sign up and proceed to payment without friction.

## Acceptance Criteria

1. Registration page created at `/register/[token]` accepting payment link token as URL parameter
2. Page fetches payment link from database using token, verifying it exists and is not expired/used
3. Expired or invalid tokens show error page: "This link has expired. Please contact support."
4. Valid link displays: Product name, Price, Description, Pre-filled email (read-only)
5. Registration form includes fields: Full Name (required), Phone (required, international format), Password (required, min 8 chars, show/hide toggle)
6. Form validation using React Hook Form + Zod with real-time error display
7. "Complete Registration & Pay" button submits form and triggers Server Action
8. Server Action creates Supabase Auth user with email/password
9. Server Action creates `profiles` record with status: PENDING, linked to auth user
10. Server Action creates `orders` record with status: PENDING, linked to profile and product
11. Server Action marks payment link as USED (`used_at: now()`, `used_by_user_id: user.id`)
12. Server Action creates Stripe Checkout Session with metadata: `order_id`, `user_id`, `product_id`
13. Checkout Session configured with success URL (`/dashboard?payment=success`) and cancel URL (`/register/{token}?payment=cancelled`)
14. User redirected to Stripe Checkout Session URL
15. Loading state shown during all async operations with spinner
16. Error handling: Duplicate email shows "Account already exists. Please login.", network errors show retry option

## Tasks / Subtasks

- [x] Create dynamic registration page route (AC: 1, 2, 3)
  - [x] Create `/register/[token]` dynamic route
  - [x] Fetch payment link by token from database
  - [x] Verify link exists and is valid (not expired/used)
  - [x] Handle invalid/expired token with error page
- [x] Display payment link information (AC: 4)
  - [x] Fetch product details (name, price, description)
  - [x] Display product information
  - [x] Display prospect email (read-only from payment link)
- [x] Build registration form (AC: 5, 6)
  - [x] Create Full Name input (required)
  - [x] Create Phone input (required, international format)
  - [x] Create Password input (required, min 8 chars)
  - [x] Add show/hide toggle for password
  - [x] Implement React Hook Form + Zod validation
  - [x] Display real-time validation errors
- [x] Implement form submission and Server Action (AC: 7, 8, 9, 10, 11)
  - [x] Create Server Action for registration
  - [x] Create Supabase Auth user with email/password
  - [x] Create `profiles` record with status: PENDING
  - [x] Create `orders` record with status: PENDING
  - [x] Update payment link: `status: USED`, `used_at: now()`, `used_by: user.id`
- [x] Create Stripe Checkout Session (AC: 12, 13, 14)
  - [x] Create Checkout Session with order/user/product metadata
  - [x] Configure success URL: `/dashboard?payment=success`
  - [x] Configure cancel URL: `/register/{token}?payment=cancelled`
  - [x] Redirect user to Checkout Session URL
- [x] Add loading states and error handling (AC: 15, 16)
  - [x] Show loading spinner during async operations
  - [x] Handle duplicate email error
  - [x] Handle network errors with retry option
  - [x] Show clear error messages to user

## Dev Notes

### Payment Link Validation Flow

1. User clicks link with token: `/register/[token]`
2. Page fetches payment link from `payment_links` table
3. Validate:
   - Token exists and has status: ACTIVE
   - `expires_at` is in future
   - `used_at` is NULL
4. If invalid, show error page
5. If valid, display product and registration form

### Stripe Checkout Session

From Story 1.5, Stripe products:
- LLC Formation - $999
- Dubai Company Setup - $1,499

Checkout Session should include metadata:
```typescript
{
  order_id: order.id,
  user_id: user.id,
  product_id: product.id
}
```

### Supabase Tables

**profiles table:**
- `user_id` - Foreign key to auth.users
- `status` - ENUM (PENDING, ACTIVE, SUSPENDED)
- Other fields as per schema

**orders table:**
- `user_id` - Foreign key to profiles.user_id
- `product_id` - Foreign key to products
- `status` - ENUM (PENDING, PAID)
- `created_at` - Timestamp

### Authentication Context

Use Supabase Auth client to create user:
```typescript
const { data, error } = await supabase.auth.signUp({
  email: prospect_email,
  password: password,
});
```

### Design System (from architecture.md)

**Color Palette:**
- Main Background: `#191A1D`
- Surface: `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

**UI Framework:** Tailwind CSS with custom design tokens
**Language:** French UI

### Testing

Testing standards from Story 1.1:
- Test invalid/expired tokens
- Test form validation (empty fields, invalid email format, weak password)
- Test Server Action database operations
- Test Stripe Checkout Session creation
- Mock Supabase and Stripe responses
- E2E test: complete registration flow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |
| 2026-01-XX | 1.1 | Implementation completed | James (DEV Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A

### Completion Notes

- Création de la route dynamique `/register/[token]` avec validation du payment link
- Page principale qui vérifie la validité du lien (non expiré, non utilisé, status ACTIVE)
- Affichage des informations du produit (nom, prix formaté, description) et de l'email du prospect (read-only)
- Formulaire de registration avec validation React Hook Form + Zod :
  - Nom complet (requis)
  - Téléphone (requis, format international validé avec regex)
  - Mot de passe (requis, min 8 caractères, toggle show/hide)
- Server Action `registerWithPaymentLink` qui :
  1. Valide le payment link
  2. Crée l'utilisateur Supabase Auth avec email/password
  3. Met à jour le profil (phone, full_name, status: PENDING)
  4. Crée la commande (order) avec status: PENDING
  5. Marque le payment link comme USED (status, used_at, used_by)
  6. Crée la session Stripe Checkout avec métadonnées (order_id, user_id, product_id)
  7. Configure les URLs de succès et d'annulation
  8. Met à jour la commande avec le stripe_checkout_session_id
- Gestion complète des erreurs (duplicate email, lien invalide, erreurs réseau, etc.)
- États de chargement avec spinner pendant les opérations asynchrones
- Design cohérent avec le reste de l'application (même style que la page de login)

**Note technique importante** : La Server Action utilise `supabase.auth.signUp()` qui peut nécessiter une confirmation par email selon la configuration Supabase. Si nécessaire, il faudra ajuster pour utiliser le service role ou une API route.

### File List

- `app/(public)/register/[token]/page.tsx` (nouveau)
- `app/(public)/register/[token]/RegisterPaymentLinkForm.tsx` (nouveau)
- `app/actions/register-payment-link.ts` (nouveau)

## QA Results

*Results from QA Agent review will be documented here.*
