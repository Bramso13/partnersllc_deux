# Story 1.7: Payment Link Registration Page (Client-Facing)

## Status
Draft

## Story

**As a** prospect,
**I want** to click a payment link and complete my registration in a single guided flow,
**so that** I can quickly sign up and proceed to payment without friction.

## Acceptance Criteria

1. Registration page created at `/register/[token]` accepting payment link token as URL parameter
2. Page fetches payment link from database using token, verifying it exists and is not expired/used
3. Expired or invalid tokens show error page: "This link has expired. Please contact support."
4. Valid link displays: Product name, Price, Description, Pre-filled email (read-only)
5. Registration form includes fields: Full Name (required), Phone (required, international format), Password (required, min 8 chars, show/hide toggle)
6. Form validation using React Hook Form + Zod with real-time error display
7. "Complete Registration & Pay" button submits form and triggers Server Action
8. Server Action creates Supabase Auth user with email/password
9. Server Action creates `profiles` record with status: PENDING, linked to auth user
10. Server Action creates `orders` record with status: PENDING, linked to profile and product
11. Server Action marks payment link as USED (`used_at: now()`, `used_by_user_id: user.id`)
12. Server Action creates Stripe Checkout Session with metadata: `order_id`, `user_id`, `product_id`
13. Checkout Session configured with success URL (`/dashboard?payment=success`) and cancel URL (`/register/{token}?payment=cancelled`)
14. User redirected to Stripe Checkout Session URL
15. Loading state shown during all async operations with spinner
16. Error handling: Duplicate email shows "Account already exists. Please login.", network errors show retry option

## Tasks / Subtasks

- [ ] Create dynamic registration page route (AC: 1, 2, 3)
  - [ ] Create `/register/[token]` dynamic route
  - [ ] Fetch payment link by token from database
  - [ ] Verify link exists and is valid (not expired/used)
  - [ ] Handle invalid/expired token with error page
- [ ] Display payment link information (AC: 4)
  - [ ] Fetch product details (name, price, description)
  - [ ] Display product information
  - [ ] Display prospect email (read-only from payment link)
- [ ] Build registration form (AC: 5, 6)
  - [ ] Create Full Name input (required)
  - [ ] Create Phone input (required, international format)
  - [ ] Create Password input (required, min 8 chars)
  - [ ] Add show/hide toggle for password
  - [ ] Implement React Hook Form + Zod validation
  - [ ] Display real-time validation errors
- [ ] Implement form submission and Server Action (AC: 7, 8, 9, 10, 11)
  - [ ] Create Server Action for registration
  - [ ] Create Supabase Auth user with email/password
  - [ ] Create `profiles` record with status: PENDING
  - [ ] Create `orders` record with status: PENDING
  - [ ] Update payment link: `status: USED`, `used_at: now()`, `used_by_user_id: user.id`
- [ ] Create Stripe Checkout Session (AC: 12, 13, 14)
  - [ ] Create Checkout Session with order/user/product metadata
  - [ ] Configure success URL: `/dashboard?payment=success`
  - [ ] Configure cancel URL: `/register/{token}?payment=cancelled`
  - [ ] Redirect user to Checkout Session URL
- [ ] Add loading states and error handling (AC: 15, 16)
  - [ ] Show loading spinner during async operations
  - [ ] Handle duplicate email error
  - [ ] Handle network errors with retry option
  - [ ] Show clear error messages to user

## Dev Notes

### Payment Link Validation Flow

1. User clicks link with token: `/register/[token]`
2. Page fetches payment link from `payment_links` table
3. Validate:
   - Token exists and has status: ACTIVE
   - `expires_at` is in future
   - `used_at` is NULL
4. If invalid, show error page
5. If valid, display product and registration form

### Stripe Checkout Session

From Story 1.5, Stripe products:
- LLC Formation - $999
- Dubai Company Setup - $1,499

Checkout Session should include metadata:
```typescript
{
  order_id: order.id,
  user_id: user.id,
  product_id: product.id
}
```

### Supabase Tables

**profiles table:**
- `user_id` - Foreign key to auth.users
- `status` - ENUM (PENDING, ACTIVE, SUSPENDED)
- Other fields as per schema

**orders table:**
- `user_id` - Foreign key to profiles.user_id
- `product_id` - Foreign key to products
- `status` - ENUM (PENDING, PAID)
- `created_at` - Timestamp

### Authentication Context

Use Supabase Auth client to create user:
```typescript
const { data, error } = await supabase.auth.signUp({
  email: prospect_email,
  password: password,
});
```

### Design System (from architecture.md)

**Color Palette:**
- Main Background: `#191A1D`
- Surface: `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

**UI Framework:** Tailwind CSS with custom design tokens
**Language:** French UI

### Testing

Testing standards from Story 1.1:
- Test invalid/expired tokens
- Test form validation (empty fields, invalid email format, weak password)
- Test Server Action database operations
- Test Stripe Checkout Session creation
- Mock Supabase and Stripe responses
- E2E test: complete registration flow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
