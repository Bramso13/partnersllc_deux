# Story 5.2: Agent Assigned Steps Queue

## Status

Draft

## Story

**As an** agent,
**I want** to see all steps assigned to me in a queue,
**so that** I can prioritize and process my work efficiently.

## Acceptance Criteria

1. Steps queue page at `/agent/steps` displays all step_instances where `assigned_to = current_agent.id`
2. Only incomplete steps shown by default (`completed_at IS NULL`)
3. Each step card displays:
   - Step name (from `steps.label`)
   - Dossier info: Product name, Client name/email, Dossier ID (truncated)
   - Step status indicator: "Non dÃ©marrÃ©" (gray), "En cours" (yellow), "BloquÃ©" (red)
   - Pending documents count for this step
   - Time assigned (relative: "AssignÃ© il y a 2 jours")
4. Cards arranged in list view (vertical stack) for easier scanning
5. Sortable by: Date assigned (default), Step type, Client name, Pending documents count
6. Filterable by: Step type (dropdown), Has pending documents (toggle)
7. Search by client name, email, or dossier ID
8. Clicking step card navigates to `/agent/steps/[step_instance_id]`
9. Toggle to show completed steps (historical view)
10. Empty state: "Aucune Ã©tape assignÃ©e. Contactez votre administrateur."
11. Badge on navigation showing total incomplete assigned steps count
12. Auto-refresh every 60 seconds to show newly assigned steps

## Tasks / Subtasks

- [ ] Create steps data fetching function (AC: 1, 2, 3)
  - [ ] Create `lib/agent-steps.ts` with `getAgentAssignedSteps()` function
  - [ ] Query step_instances joined with steps, dossiers, products, profiles
  - [ ] Filter by assigned_to = current agent ID
  - [ ] Filter by completed_at IS NULL (default)
  - [ ] Include pending documents count per step
  - [ ] Return typed `AgentStepInstance[]`

- [ ] Build steps queue page (AC: 1, 3, 4, 8, 10)
  - [ ] Create `app/(protected)/agent/steps/page.tsx`
  - [ ] Create `AgentStepsQueueContent` client component
  - [ ] Build step card component with all required info
  - [ ] Implement list view layout
  - [ ] Add click handler to navigate to step detail
  - [ ] Add loading skeleton
  - [ ] Add empty state

- [ ] Implement sorting and filtering (AC: 5, 6, 7)
  - [ ] Create sort dropdown component
  - [ ] Create step type filter dropdown
  - [ ] Create "Has pending docs" toggle
  - [ ] Create search input with debounce
  - [ ] Implement client-side sorting/filtering
  - [ ] Persist selections in URL query params

- [ ] Implement completed steps toggle (AC: 9)
  - [ ] Add "Voir les Ã©tapes terminÃ©es" toggle
  - [ ] Fetch completed steps when toggle is on
  - [ ] Show completed steps with distinct styling (grayed out)

- [ ] Add navigation badge (AC: 11)
  - [ ] Query count of incomplete assigned steps
  - [ ] Display badge on "Mes Ã©tapes" nav item
  - [ ] Update badge dynamically

- [ ] Implement auto-refresh (AC: 12)
  - [ ] Set up 60-second interval refresh
  - [ ] Use React Query or SWR for automatic refetching
  - [ ] Show subtle refresh indicator

- [ ] Testing
  - [ ] Test only assigned steps are shown
  - [ ] Test sorting and filtering
  - [ ] Test search functionality
  - [ ] Test navigation to step detail
  - [ ] Test empty state
  - [ ] Test completed steps toggle
  - [ ] Test responsive layout

## Dev Notes

### Data Model

```typescript
interface AgentStepInstance {
  id: string;
  step_id: string;
  dossier_id: string;
  assigned_to: string;
  started_at: string | null;
  completed_at: string | null;
  created_at: string;
  
  // Joined data
  step: {
    code: string;
    label: string;
    description: string | null;
    position: number;
  };
  dossier: {
    id: string;
    status: string;
    product: {
      name: string;
    };
    client: {
      full_name: string;
      email: string;
    };
  };
  
  // Computed
  pending_documents_count: number;
  status_indicator: 'not_started' | 'in_progress' | 'blocked';
}
```

### Database Query

```sql
SELECT 
  si.*,
  s.code as step_code, 
  s.label as step_label, 
  s.description as step_description,
  s.position as step_position,
  d.id as dossier_id, 
  d.status as dossier_status,
  p.name as product_name,
  pr.full_name as client_name, 
  pr.id as client_id,
  -- Get email from auth.users or wherever it's stored
  (SELECT COUNT(*) FROM documents doc 
   WHERE doc.step_instance_id = si.id 
   AND doc.status = 'PENDING') as pending_documents_count
FROM step_instances si
JOIN steps s ON s.id = si.step_id
JOIN dossiers d ON d.id = si.dossier_id
JOIN products p ON p.id = d.product_id
JOIN profiles pr ON pr.id = d.user_id
WHERE si.assigned_to = $agent_id
  AND si.completed_at IS NULL
ORDER BY si.created_at ASC;
```

### Step Status Indicator Logic

```typescript
function getStepStatusIndicator(step: AgentStepInstance): 'not_started' | 'in_progress' | 'blocked' {
  // Blocked if there are rejected documents requiring re-upload
  if (hasRejectedDocuments(step)) return 'blocked';
  
  // In progress if started
  if (step.started_at) return 'in_progress';
  
  // Not started
  return 'not_started';
}
```

### Status Colors

- Not Started: Gray (`#6B7280`)
- In Progress: Yellow (`#FACC15`)
- Blocked: Red (`#F95757`)

### Step Card Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Icon] Qualification                          Il y a 2 joursâ”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Client: Jean Dupont (jean@email.com)                        â”‚
â”‚ Produit: LLC Formation  |  Dossier: abc-123...              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ“„ 2 documents en attente                    [En cours] âšª   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Structure

```
partnersllc-app/
â”œâ”€â”€ app/(protected)/agent/steps/
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ components/agent/
â”‚   â”œâ”€â”€ StepsQueueContent.tsx
â”‚   â”œâ”€â”€ StepCard.tsx
â”‚   â””â”€â”€ StepsFilters.tsx
â””â”€â”€ lib/
    â””â”€â”€ agent-steps.ts
```

### Auto-Refresh with SWR

```typescript
import useSWR from 'swr';

const { data: steps, isLoading, mutate } = useSWR(
  '/api/agent/steps',
  fetcher,
  { refreshInterval: 60000 } // 60 seconds
);
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*To be filled during implementation*

## QA Results

*To be filled after QA review*
