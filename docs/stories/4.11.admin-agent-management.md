# Story 4.11: Admin Agent Management Page

## Status

Draft

## Story

**As an** administrator,
**I want** a dedicated page to view and manage all agents,
**so that** I can invite new agents, monitor their workload, and activate or deactivate their accounts.

## Acceptance Criteria

### Agent List Page

1. Agent management page at `/admin/agents` accessible only to users with ADMIN role
2. Page displays all profiles with `role = 'AGENT'` joined with `agents` table data
3. Table columns: Name, Email, Status (Active/Inactive badge), Assigned Steps, Workload %, Last Activity, Actions
4. Status badges: Active (green), Inactive (gray/red)
5. Assigned Steps shows count of step_instances assigned to agent (not completed)
6. Workload % calculated as: (assigned steps / max capacity) - or simple indicator (Low/Medium/High)
7. Last Activity shows most recent action timestamp (document review, step completion, etc.)
8. Table sortable by: Name, Status, Assigned Steps, Last Activity
9. Table paginated: 25 agents per page
10. Loading skeleton while fetching data
11. Empty state: "Aucun agent enregistré. Invitez votre premier agent."

### Search & Filters

12. Search input with placeholder "Rechercher par nom ou email..."
13. Search debounced (300ms), case-insensitive
14. Status filter: "Tous", "Actifs", "Inactifs"
15. Filters persist in URL query parameters
16. Show count: "X agents"

### Invite New Agent

17. "Inviter un agent" button prominently displayed
18. Button opens modal with invitation form
19. Form fields: Email (required), Full Name (required)
20. Email validation: Must be valid email format, not already registered
21. On submit, creates invitation (via Supabase Auth invite or custom flow)
22. New agent record created in `agents` table with active = true
23. Success notification: "Invitation envoyée à {email}"
24. Invited agent receives email with signup link
25. When agent signs up, their profile role is set to 'AGENT'

### Agent Actions

26. Each row has action dropdown: "Voir les steps assignés", "Désactiver", "Voir le profil"
27. "Voir les steps assignés" navigates to agent's assigned steps view (or filtered list)
28. "Désactiver" opens confirmation modal
29. Deactivation updates `agents.active = false` and `profiles.status = 'SUSPENDED'`
30. Deactivated agents cannot log in
31. Deactivated agents' assigned steps can be reassigned
32. "Activer" option appears for inactive agents to reactivate
33. "Voir le profil" opens slide-over with full agent details

### Agent Profile Slide-over

34. Slide-over shows: Name, Email, Status, Role, Active Since, Total Steps Completed, Avg Review Time
35. Performance metrics: Documents reviewed (total), Steps completed (total), Average response time
36. Currently assigned steps list with dossier info
37. Quick actions: Activate/Deactivate, View Assigned Steps
38. Close with X or click outside

### Workload Overview

39. Summary cards above table showing:
    - Total Agents (active count / total)
    - Total Assigned Steps (pending across all agents)
    - Average Workload (steps per agent)
    - Unassigned Steps (steps with no agent assigned)
40. Cards clickable to filter/navigate

### Navigation

41. Navigation config updated to include "Gestion Agents" in admin menu
42. Menu item: href `/admin/agents`, icon `fa-user-tie`, label "Gestion Agents"
43. Placed after "Gestion Clients" in menu order

## Tasks / Subtasks

- [ ] Create agent data fetching functions (AC: 2, 5, 6, 7)
  - [ ] Create `lib/agents-admin.ts` with `getAllAgents()` function
  - [ ] Query profiles with role = 'AGENT' joined with agents table
  - [ ] Include count of assigned step_instances
  - [ ] Calculate workload indicator
  - [ ] Fetch last activity from events table
  - [ ] Return typed `AgentWithWorkload[]`

- [ ] Build agent list page (AC: 1, 3, 4, 8, 9, 10, 11)
  - [ ] Create page at `app/(protected)/admin/agents/page.tsx`
  - [ ] Add `requireAdminAuth()` check
  - [ ] Create `AdminAgentsContent` client component
  - [ ] Build data table with all required columns
  - [ ] Implement status badges
  - [ ] Add sorting functionality
  - [ ] Add pagination
  - [ ] Add loading skeleton
  - [ ] Add empty state with invite CTA

- [ ] Implement search and filters (AC: 12, 13, 14, 15, 16)
  - [ ] Create search input with debounce
  - [ ] Create status filter dropdown
  - [ ] Implement filtering logic
  - [ ] Sync with URL query parameters
  - [ ] Show agent count

- [ ] Build invite agent feature (AC: 17, 18, 19, 20, 21, 22, 23, 24, 25)
  - [ ] Create "Inviter un agent" button
  - [ ] Create invitation modal with form
  - [ ] Add email and name validation
  - [ ] Create API route `POST /api/admin/agents/invite`
  - [ ] Implement Supabase Auth invitation (or custom invite flow)
  - [ ] Create agents table record
  - [ ] Show success/error notifications
  - [ ] Handle invited user signup to set role = 'AGENT'

- [ ] Build agent actions (AC: 26, 27, 28, 29, 30, 31, 32, 33)
  - [ ] Create action dropdown component
  - [ ] Implement "Voir les steps assignés" navigation
  - [ ] Create deactivation confirmation modal
  - [ ] Create API route `POST /api/admin/agents/[id]/status`
  - [ ] Update agents.active and profiles.status
  - [ ] Implement reactivation flow
  - [ ] Implement "Voir le profil" slide-over trigger

- [ ] Build agent profile slide-over (AC: 34, 35, 36, 37, 38)
  - [ ] Create slide-over panel component
  - [ ] Display all agent fields
  - [ ] Calculate and display performance metrics
  - [ ] Show assigned steps list
  - [ ] Add quick action buttons
  - [ ] Implement close functionality

- [ ] Build workload overview cards (AC: 39, 40)
  - [ ] Create summary cards component
  - [ ] Query aggregate data for cards
  - [ ] Make cards clickable for filtering

- [ ] Update navigation (AC: 41, 42, 43)
  - [ ] Update `lib/navigation-config.ts`
  - [ ] Add "Gestion Agents" menu item
  - [ ] Place after "Gestion Clients"

- [ ] Testing
  - [ ] Test admin-only access
  - [ ] Test agent invitation flow
  - [ ] Test activation/deactivation
  - [ ] Test search and filters
  - [ ] Test workload calculations
  - [ ] Test responsive design

## Dev Notes

### Data Model

The system uses two related entities for agents:
1. `profiles` table: Authentication and user identity (linked to auth.users)
2. `agents` table: Agent-specific data (name, email, active status)

When inviting a new agent:
1. Create record in `agents` table
2. Send Supabase Auth invite email
3. When user signs up, their profile is created with role = 'AGENT'
4. Link profile to agents table via email match

### Agent Invitation Flow

```typescript
// API Route: /api/admin/agents/invite
export async function POST(request: NextRequest) {
  await requireAdminAuth();
  
  const { email, fullName } = await request.json();
  
  const supabase = await createServiceRoleClient(); // Need service role for admin.inviteUserByEmail
  
  // 1. Create agents table record
  const { data: agent, error: agentError } = await supabase
    .from('agents')
    .insert({
      email,
      name: fullName,
      active: true
    })
    .select()
    .single();
    
  if (agentError) {
    return NextResponse.json({ error: 'Agent already exists' }, { status: 400 });
  }
  
  // 2. Send invitation email via Supabase Auth
  const { error: inviteError } = await supabase.auth.admin.inviteUserByEmail(email, {
    data: {
      full_name: fullName,
      role: 'AGENT' // This will be used to set profile.role on signup
    }
  });
  
  if (inviteError) {
    // Rollback agent creation
    await supabase.from('agents').delete().eq('id', agent.id);
    return NextResponse.json({ error: 'Failed to send invitation' }, { status: 500 });
  }
  
  return NextResponse.json({ success: true, agent });
}
```

### Handling Signup

In your auth callback or trigger, ensure new signups with `role: 'AGENT'` metadata get the correct profile role:

```sql
-- Trigger on profile creation to set role from metadata
CREATE OR REPLACE FUNCTION set_profile_role_from_metadata()
RETURNS TRIGGER AS $$
DECLARE
  v_role user_role;
BEGIN
  -- Get role from auth.users metadata
  SELECT COALESCE(
    (raw_user_meta_data->>'role')::user_role,
    'CLIENT'
  ) INTO v_role
  FROM auth.users
  WHERE id = NEW.id;
  
  NEW.role := v_role;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER before_profile_insert
BEFORE INSERT ON profiles
FOR EACH ROW
EXECUTE FUNCTION set_profile_role_from_metadata();
```

### Workload Calculation

Simple workload calculation:

```typescript
function calculateWorkload(assignedSteps: number): 'LOW' | 'MEDIUM' | 'HIGH' {
  if (assignedSteps <= 5) return 'LOW';
  if (assignedSteps <= 15) return 'MEDIUM';
  return 'HIGH';
}
```

Or percentage-based (if you define max capacity):

```typescript
const MAX_CAPACITY = 20; // configurable
const workloadPercent = Math.min(100, Math.round((assignedSteps / MAX_CAPACITY) * 100));
```

### Performance Metrics Query

```sql
-- Get agent performance metrics
SELECT
  a.id,
  a.name,
  a.email,
  a.active,
  p.id as profile_id,
  p.created_at as member_since,
  -- Assigned steps (not completed)
  (SELECT COUNT(*) FROM step_instances si 
   WHERE si.assigned_to = a.id AND si.completed_at IS NULL) as assigned_steps,
  -- Total steps completed
  (SELECT COUNT(*) FROM step_instances si 
   WHERE si.assigned_to = a.id AND si.completed_at IS NOT NULL) as completed_steps,
  -- Documents reviewed
  (SELECT COUNT(*) FROM document_reviews dr 
   WHERE dr.reviewer_id = a.id) as documents_reviewed,
  -- Last activity
  (SELECT MAX(created_at) FROM events e 
   WHERE e.actor_id = a.id::text) as last_activity
FROM agents a
LEFT JOIN profiles p ON p.id IN (
  SELECT id FROM auth.users WHERE email = a.email
)
ORDER BY a.name;
```

### Component Structure

```
partnersllc-app/
├── app/(protected)/admin/agents/
│   └── page.tsx
├── components/admin/agents/
│   ├── AdminAgentsContent.tsx
│   ├── AgentsTable.tsx
│   ├── AgentsFilters.tsx
│   ├── InviteAgentModal.tsx
│   ├── AgentStatusModal.tsx
│   ├── AgentProfileSlideOver.tsx
│   └── WorkloadSummaryCards.tsx
├── lib/
│   └── agents-admin.ts
└── app/api/admin/agents/
    ├── invite/
    │   └── route.ts
    └── [id]/
        └── status/
            └── route.ts
```

### Navigation Update

Add to `adminNavConfig`:

```typescript
{
  href: "/admin/agents",
  icon: "fa-user-tie",
  label: "Gestion Agents",
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review of the completed story implementation*
