# Story 3.3: WhatsApp Notification Delivery System

## Status

Draft

## Story

**As a** user,
**I want** to receive WhatsApp messages for critical updates,
**so that** I get instant notifications on my preferred communication channel.

## Acceptance Criteria

1. Twilio WhatsApp Business API configured with account SID, auth token, and WhatsApp phone number
2. WhatsApp service module created (`lib/notifications/whatsapp.ts`) with `sendWhatsApp(to, message, mediaUrl?)` function
3. WhatsApp message templates created for each notification type following Twilio template requirements
4. User phone numbers validated to E.164 format before sending (international format with country code)
5. For each WhatsApp notification, `notification_deliveries` record created with `status: PENDING`
6. Message sent via Twilio API with error handling
7. Successful send updates delivery: `status: SENT`, `provider_message_id` (Twilio SID)
8. Failed send (e.g., invalid number, user not on WhatsApp) updates delivery: `status: FAILED`, `error_message`
9. Twilio webhook configured to receive delivery status updates (delivered, read, failed)
10. Webhook updates delivery status based on Twilio events
11. WhatsApp notification priority: Try WhatsApp first, if fails, fallback to SMS (handled in notification orchestrator)
12. Message includes call-to-action link when applicable (e.g., "View your dossier: {link}")
13. Test mode uses Twilio sandbox for development testing
14. Rate limiting implemented (Twilio limits): Max 60 messages/minute per number

## Tasks / Subtasks

- [ ] Configure Twilio WhatsApp Business API (AC: 1)
  - [ ] Create/access Twilio account
  - [ ] Enable WhatsApp Business API
  - [ ] Get Account SID and Auth Token
  - [ ] Register WhatsApp Business phone number
  - [ ] Add credentials to environment variables
- [ ] Create WhatsApp service module (AC: 2)
  - [ ] Create `lib/notifications/whatsapp.ts`
  - [ ] Implement `sendWhatsApp(to, message, mediaUrl?)` function
  - [ ] Initialize Twilio client with credentials
  - [ ] Add error handling and logging
  - [ ] Create type definitions
- [ ] Create WhatsApp message templates (AC: 3)
  - [ ] Document approved notification
  - [ ] Document rejected notification
  - [ ] Step completed notification
  - [ ] Payment reminder notification
  - [ ] Payment successful notification
  - [ ] Follow Twilio template requirements
- [ ] Implement phone number validation (AC: 4)
  - [ ] Create phone number validator using libphonenumber-js
  - [ ] Convert numbers to E.164 format
  - [ ] Handle country code injection for French numbers
  - [ ] Validate before sending WhatsApp messages
- [ ] Create notification processor (AC: 5)
  - [ ] Filter notifications by `channel: WHATSAPP`
  - [ ] Validate phone number to E.164 format (AC: 4)
  - [ ] Create `notification_deliveries` record with status PENDING
  - [ ] Pass to WhatsApp service
- [ ] Implement send logic with error handling (AC: 6, 7, 8)
  - [ ] Send via Twilio API (AC: 6)
  - [ ] Update delivery record on success: `status: SENT`, `provider_message_id` (AC: 7)
  - [ ] Update delivery record on failure: `status: FAILED`, `error_message` (AC: 8)
  - [ ] Log errors for debugging
- [ ] Configure Twilio webhook (AC: 9, 10)
  - [ ] Create webhook endpoint `/api/webhooks/twilio-whatsapp`
  - [ ] Configure webhook URL in Twilio Console
  - [ ] Implement webhook handler to receive delivery status updates
  - [ ] Update `notification_deliveries` based on webhook events
  - [ ] Handle: delivered, read, failed events
- [ ] Implement fallback to SMS (AC: 11)
  - [ ] In notification processor, catch WhatsApp failures
  - [ ] Create SMS notification if WhatsApp fails
  - [ ] Document fallback logic
- [ ] Add call-to-action links (AC: 12)
  - [ ] Include action links in message templates
  - [ ] Use URL shortener or custom domain for brevity
  - [ ] Test link clicks in development
- [ ] Configure test mode (AC: 13)
  - [ ] Set up Twilio Sandbox for development
  - [ ] Document sandbox phone number and pairing
  - [ ] Create test WhatsApp configuration
- [ ] Implement rate limiting (AC: 14)
  - [ ] Track messages per phone number per minute
  - [ ] Implement queue/delay if limit approaching
  - [ ] Log rate limit events
  - [ ] Honor Twilio 60 msg/min per number limit

## Dev Notes

### Twilio WhatsApp Integration

**Account Setup:**
- Sign up at twilio.com
- Enable WhatsApp Business API
- Get Account SID (starts with AC)
- Get Auth Token (keep secure in environment)
- Register WhatsApp Business phone number (can use trial number initially)

**Environment Variables:**
- `TWILIO_ACCOUNT_SID` - Account identifier
- `TWILIO_AUTH_TOKEN` - Authentication token (keep secret)
- `TWILIO_WHATSAPP_PHONE` - WhatsApp phone number (with country code, e.g., +1234567890)
- `TWILIO_WEBHOOK_SECRET` - For webhook signature verification

**Phone Number Validation:**
- Use `libphonenumber-js` library for E.164 format validation
- Example: "06 12 34 56 78" (France) â†’ "+33612345678" (E.164)
- Always validate before sending to prevent failures

### WhatsApp Service Implementation

```typescript
// lib/notifications/whatsapp.ts
import twilio from 'twilio';

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

export async function sendWhatsApp(
  to: string,
  message: string,
  mediaUrl?: string
) {
  // Validate phone number E.164 format
  // Send via Twilio WhatsApp API
  // Return message SID or throw error
  // Include error handling for common failures
}
```

### Message Templates

Keep messages concise (WhatsApp max 1600 chars, but shorter is better):

**Document Approved:**
"Document [type] approved! Your dossier is progressing. View: [short-link]"

**Step Completed:**
"Step X complete! Next step ready. View: [short-link]"

**Payment Reminder:**
"Complete your payment to access your dossier. Pay now: [stripe-link]"

**Payment Successful:**
"Payment received! Welcome back. Your dossier is ready. View: [short-link]"

### Twilio Webhook Configuration

**Webhook URL:** `https://your-app.com/api/webhooks/twilio-whatsapp`

**Events to subscribe:**
- `message_sent` (optional)
- `message_delivered`
- `message_read`
- `message_failed`

**Webhook signature verification:**
```typescript
// Verify Twilio signature to prevent spoofing
import twilio from 'twilio';
const isValidRequest = twilio.webhooks.validateRequest(
  process.env.TWILIO_AUTH_TOKEN,
  signature,
  url,
  body
);
```

### Fallback Logic (with Story 3.4)

When WhatsApp fails (user not on WhatsApp, invalid number, etc.):
1. Catch error in WhatsApp send
2. Create SMS notification record
3. Story 3.4 processes SMS as fallback

### Testing Standards

- **Test location:** `__tests__/integration/whatsapp-notifications.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Mock Twilio API, verify calls, check database updates
- **Specific requirements:**
  - Verify phone number validation (E.164 format)
  - Verify PENDING delivery record created before send
  - Verify SENT status updated after successful send
  - Verify FAILED status on invalid numbers
  - Verify webhook signature validation
  - Verify webhook updates delivery status
  - Verify fallback to SMS on WhatsApp failure
  - Test rate limiting (queue messages if >60/min)
  - Sandbox testing with Twilio Sandbox pairing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
