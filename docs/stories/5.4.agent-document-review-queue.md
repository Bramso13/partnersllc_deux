# Story 5.4: Agent Document Review Queue

## Status

Draft

## Story

**As an** agent,
**I want** a centralized queue to review all pending documents across my assigned steps,
**so that** I can process document reviews efficiently without navigating to each step individually.

## Acceptance Criteria

### Document Queue
1. Document review queue at `/agent/reviews` displays all pending documents
2. Queue shows documents where:
   - `documents.status = 'PENDING'`
   - AND document belongs to a step instance assigned to current agent (`step_instances.assigned_to = agent_id`)
3. Each document row displays:
   - Document type name (from `document_types.label`)
   - Client name and dossier ID (truncated)
   - Step name (which step this document belongs to)
   - Uploaded date (relative: "il y a 2 jours")
   - File size (formatted: "2.3 MB")
   - Version number
4. Table sortable by: Upload date (default oldest first), Document type, Client name
5. Filterable by: Document type (dropdown), Step type (dropdown)
6. Search by client name, dossier ID
7. Empty state: "Aucun document Ã  reviewer. Bon travail ! ğŸ‰"

### Review Modal
8. "Reviewer" button opens document review modal
9. Modal displays:
   - Full-screen document preview (PDF viewer for PDFs, image viewer for images)
   - Sidebar with document metadata (type, client, dossier, step, version, upload date)
   - Previous versions list (if any) with links to view
10. "Approuver" button (green) approves document
11. "Rejeter" button (red) opens rejection reason textarea (min 10 characters required)
12. After approve/reject:
    - Document status updated in database
    - `document_reviews` record created
    - `DOCUMENT_REVIEWED` event created
    - Modal closes automatically
    - Next pending document loads automatically (for efficient batch processing)
13. Keyboard shortcuts: `A` to approve, `R` to open reject dialog

### Bulk Review
14. Checkbox column for selecting multiple documents
15. "SÃ©lectionner tout" checkbox in header selects all visible documents
16. Selected count displayed: "X documents sÃ©lectionnÃ©s"
17. Bulk action bar appears when documents selected:
    - "Approuver la sÃ©lection" button
    - "Rejeter la sÃ©lection" button (requires single reason applied to all)
    - "DÃ©sÃ©lectionner" link
18. Bulk operations process sequentially (not in parallel to avoid race conditions)
19. Progress indicator: "Traitement 3/10..."
20. Success summary: "10 documents approuvÃ©s" or "8 approuvÃ©s, 2 Ã©chouÃ©s"

### Performance
21. Pagination: 25 documents per page
22. Badge on navigation showing pending documents count
23. Auto-refresh every 60 seconds

## Tasks / Subtasks

- [ ] Create document queue fetching function (AC: 1, 2, 3)
  - [ ] Create `lib/agent-reviews.ts` with `getAgentPendingDocuments()` function
  - [ ] Query documents with status PENDING
  - [ ] Join with step_instances to filter by assigned_to
  - [ ] Join with document_types, dossiers, profiles for display data
  - [ ] Return typed `PendingDocument[]`

- [ ] Build document queue page (AC: 1, 3, 4, 5, 6, 7, 21)
  - [ ] Create `app/(protected)/agent/reviews/page.tsx`
  - [ ] Create `DocumentReviewQueueContent` client component
  - [ ] Build data table with all required columns
  - [ ] Implement sorting (upload date default oldest first)
  - [ ] Implement filtering (document type, step type)
  - [ ] Implement search
  - [ ] Add pagination
  - [ ] Add empty state
  - [ ] Add loading skeleton

- [ ] Build review modal (AC: 8, 9, 10, 11, 12, 13)
  - [ ] Create `DocumentReviewModal` component
  - [ ] Implement PDF viewer (react-pdf or similar)
  - [ ] Implement image viewer with zoom/pan
  - [ ] Build metadata sidebar
  - [ ] Show previous versions if any
  - [ ] Add approve button with API call
  - [ ] Add reject button with reason modal
  - [ ] Auto-advance to next document after action
  - [ ] Add keyboard shortcuts

- [ ] Build bulk review feature (AC: 14, 15, 16, 17, 18, 19, 20)
  - [ ] Add checkbox column to table
  - [ ] Implement select all functionality
  - [ ] Create bulk action bar component
  - [ ] Create API route `POST /api/agent/documents/bulk-review`
  - [ ] Process bulk operations sequentially
  - [ ] Show progress indicator
  - [ ] Show success/failure summary

- [ ] Add navigation badge (AC: 22)
  - [ ] Query count of pending documents for agent
  - [ ] Display badge on navigation item
  - [ ] Update badge dynamically

- [ ] Implement auto-refresh (AC: 23)
  - [ ] 60-second refresh interval
  - [ ] Use SWR or React Query

- [ ] Testing
  - [ ] Test only documents from assigned steps are shown
  - [ ] Test document preview (PDF and images)
  - [ ] Test approve flow
  - [ ] Test reject flow with reason
  - [ ] Test auto-advance to next document
  - [ ] Test bulk approve
  - [ ] Test bulk reject
  - [ ] Test keyboard shortcuts
  - [ ] Test empty state
  - [ ] Test pagination

## Dev Notes

### Data Model

```typescript
interface PendingDocument {
  id: string;
  document_type_id: string;
  dossier_id: string;
  step_instance_id: string;
  status: 'PENDING';
  
  document_type: {
    code: string;
    label: string;
  };
  
  current_version: {
    id: string;
    file_url: string;
    file_name: string;
    file_size_bytes: number;
    mime_type: string;
    version_number: number;
    uploaded_at: string;
  };
  
  step_instance: {
    step: {
      label: string;
    };
  };
  
  dossier: {
    id: string;
    client: {
      full_name: string;
      email: string;
    };
  };
  
  // For previous versions if needed
  previous_versions?: Array<{
    id: string;
    version_number: number;
    uploaded_at: string;
    file_url: string;
  }>;
}
```

### Database Query

```sql
SELECT 
  doc.id,
  doc.status,
  dt.code as document_type_code,
  dt.label as document_type_label,
  dv.id as version_id,
  dv.file_url,
  dv.file_name,
  dv.file_size_bytes,
  dv.mime_type,
  dv.version_number,
  dv.uploaded_at,
  s.label as step_label,
  d.id as dossier_id,
  pr.full_name as client_name,
  pr.id as client_id
FROM documents doc
JOIN document_types dt ON dt.id = doc.document_type_id
JOIN document_versions dv ON dv.id = doc.current_version_id
JOIN step_instances si ON si.id = doc.step_instance_id
JOIN steps s ON s.id = si.step_id
JOIN dossiers d ON d.id = doc.dossier_id
JOIN profiles pr ON pr.id = d.user_id
WHERE doc.status = 'PENDING'
  AND si.assigned_to = $agent_id
ORDER BY dv.uploaded_at ASC;
```

### Bulk Review API

```typescript
// POST /api/agent/documents/bulk-review
export async function POST(request: NextRequest) {
  const agent = await requireAgentRoleAuth();
  const { document_ids, action, reason } = await request.json();
  
  const results = {
    success: [] as string[],
    failed: [] as { id: string; error: string }[]
  };
  
  for (const docId of document_ids) {
    try {
      // Verify document belongs to agent's assigned step
      const doc = await getDocumentWithStepInstance(docId);
      if (doc.step_instance.assigned_to !== agentId && agent.role !== 'ADMIN') {
        results.failed.push({ id: docId, error: 'Not authorized' });
        continue;
      }
      
      // Process review
      await createDocumentReview(docId, action, reason, agentId);
      results.success.push(docId);
    } catch (error) {
      results.failed.push({ id: docId, error: error.message });
    }
  }
  
  return NextResponse.json({
    success: true,
    processed: results.success.length,
    failed: results.failed.length,
    details: results
  });
}
```

### Review Modal Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Document Review                                           [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚ INFORMATIONS                 â”‚
â”‚                                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚                                 â”‚ Type: Passeport              â”‚
â”‚                                 â”‚ Client: Jean Dupont          â”‚
â”‚        [PDF/IMAGE PREVIEW]      â”‚ Dossier: abc-123...          â”‚
â”‚                                 â”‚ Ã‰tape: Qualification         â”‚
â”‚                                 â”‚ Version: 2                   â”‚
â”‚                                 â”‚ UploadÃ©: il y a 2 jours      â”‚
â”‚                                 â”‚ Taille: 2.3 MB               â”‚
â”‚                                 â”‚                              â”‚
â”‚                                 â”‚ VERSIONS PRÃ‰CÃ‰DENTES         â”‚
â”‚                                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                 â”‚ v1 - 5 jan. [RejetÃ©]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Rejeter (R)]                              [Approuver (A)] âœ“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Structure

```
partnersllc-app/
â”œâ”€â”€ app/(protected)/agent/reviews/
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ components/agent/reviews/
â”‚   â”œâ”€â”€ DocumentReviewQueueContent.tsx
â”‚   â”œâ”€â”€ DocumentsTable.tsx
â”‚   â”œâ”€â”€ DocumentReviewModal.tsx
â”‚   â”œâ”€â”€ PDFViewer.tsx
â”‚   â”œâ”€â”€ ImageViewer.tsx
â”‚   â”œâ”€â”€ RejectReasonModal.tsx
â”‚   â””â”€â”€ BulkActionBar.tsx
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ agent-reviews.ts
â””â”€â”€ app/api/agent/
    â””â”€â”€ documents/
        â”œâ”€â”€ [id]/review/route.ts
        â””â”€â”€ bulk-review/route.ts
```

### PDF Viewer

Use `react-pdf` library:

```tsx
import { Document, Page, pdfjs } from 'react-pdf';

pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.js`;

function PDFViewer({ fileUrl }: { fileUrl: string }) {
  const [numPages, setNumPages] = useState(0);
  const [pageNumber, setPageNumber] = useState(1);
  
  return (
    <div>
      <Document
        file={fileUrl}
        onLoadSuccess={({ numPages }) => setNumPages(numPages)}
      >
        <Page pageNumber={pageNumber} />
      </Document>
      <div>
        Page {pageNumber} of {numPages}
        <button onClick={() => setPageNumber(p => Math.max(1, p - 1))}>â†</button>
        <button onClick={() => setPageNumber(p => Math.min(numPages, p + 1))}>â†’</button>
      </div>
    </div>
  );
}
```

### Keyboard Shortcuts

```tsx
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'a' || e.key === 'A') {
      handleApprove();
    } else if (e.key === 'r' || e.key === 'R') {
      openRejectModal();
    }
  };
  
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, []);
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*To be filled during implementation*

## QA Results

*To be filled after QA review*
