# Story 4.10: Admin Client Management Page

## Status

Ready for Review

## Story

**As an** administrator,
**I want** a dedicated page to view and manage all clients,
**so that** I can monitor client accounts, modify their status, and access their dossiers quickly.

## Acceptance Criteria

### Client List Page

1. Client management page at `/admin/clients` accessible only to users with ADMIN role
2. Page displays all profiles with `role = 'CLIENT'` in a data table
3. Table columns: Full Name, Email, Phone, Status (badge), Dossiers Count, Created Date, Actions
4. Status badges color-coded: PENDING (yellow), ACTIVE (green), SUSPENDED (red)
5. Dossiers count shows number of dossiers owned by client (clickable to filter dossier list)
6. Table sortable by: Name, Email, Status, Dossiers Count, Created Date
7. Table paginated: 25 clients per page with page navigation
8. Loading skeleton shown while fetching data
9. Empty state when no clients: "Aucun client enregistré."

### Search & Filters

10. Search input with placeholder "Rechercher par nom, email ou téléphone..."
11. Search is debounced (300ms) and case-insensitive
12. Status filter dropdown: "Tous les statuts", PENDING, ACTIVE, SUSPENDED
13. Filters persist in URL query parameters
14. Active filters show count: "X clients"

### Client Actions

15. Each row has action dropdown with options: "Voir les dossiers", "Modifier le statut", "Voir le profil"
16. "Voir les dossiers" navigates to `/admin/dossiers?client_id={id}` (filtered dossier list)
17. "Modifier le statut" opens modal to change client status (PENDING, ACTIVE, SUSPENDED)
18. Status change requires confirmation with reason input
19. Status change creates event in `events` table for audit trail
20. "Voir le profil" opens slide-over panel with full client details

### Client Profile Slide-over

21. Slide-over panel shows complete client profile: Name, Email, Phone, Status, Role, Stripe Customer ID, Created Date, Updated Date
22. Panel shows recent activity: Last 10 events related to client
23. Panel shows client's dossiers summary: List with status badges
24. Quick actions in panel: Change Status, View Dossiers
25. Panel closeable with X button or clicking outside

### Navigation

26. Navigation config updated to include "Gestion Clients" in admin menu
27. Menu item: href `/admin/clients`, icon `fa-users`, label "Gestion Clients"
28. Navigation item placed after "Dossiers LLC" in menu order

## Tasks / Subtasks

- [x] Create client fetching functions (AC: 2, 5)
  - [x] Create `lib/clients.ts` with `getAllClients()` function
  - [x] Query profiles with role = 'CLIENT' and count of dossiers
  - [x] Include proper sorting and filtering capabilities
  - [x] Return typed `ClientWithDossierCount[]`

- [x] Build client list page (AC: 1, 3, 4, 6, 7, 8, 9)
  - [x] Create page at `app/(protected)/admin/clients/page.tsx`
  - [x] Add `requireAdminAuth()` check
  - [x] Create `AdminClientsContent` client component
  - [x] Build data table with all required columns
  - [x] Implement status badges with correct colors
  - [x] Add sorting functionality
  - [x] Add pagination (25 per page)
  - [x] Add loading skeleton
  - [x] Add empty state

- [x] Implement search and filters (AC: 10, 11, 12, 13, 14)
  - [x] Create search input with debounce
  - [x] Create status filter dropdown
  - [x] Implement client-side filtering
  - [x] Sync with URL query parameters
  - [x] Show active filter count

- [x] Build client actions (AC: 15, 16, 17, 18, 19)
  - [x] Create action dropdown component
  - [x] Implement "Voir les dossiers" navigation
  - [x] Create status change modal
  - [x] Add confirmation and reason input
  - [x] Create API route `POST /api/admin/clients/[id]/status`
  - [x] Log status change to events table

- [x] Build client profile slide-over (AC: 20, 21, 22, 23, 24, 25)
  - [x] Create slide-over panel component
  - [x] Display all profile fields
  - [x] Fetch and display recent events
  - [x] Show dossiers summary
  - [x] Add quick action buttons
  - [x] Implement close functionality

- [x] Update navigation (AC: 26, 27, 28)
  - [x] Update `lib/navigation-config.ts`
  - [x] Add "Gestion Clients" menu item
  - [x] Place after "Dossiers LLC"

- [x] Testing
  - [x] Test admin-only access (non-admin redirected)
  - [x] Test search and filter combinations
  - [x] Test status change flow
  - [x] Test navigation to filtered dossiers
  - [x] Test slide-over panel
  - [x] Test responsive design

## Dev Notes

### Data Fetching

Create `lib/clients.ts`:

```typescript
import { createClient } from "@/lib/supabase/server";

export interface ClientProfile {
  id: string;
  full_name: string | null;
  email: string;
  phone: string | null;
  status: 'PENDING' | 'ACTIVE' | 'SUSPENDED';
  role: 'CLIENT';
  stripe_customer_id: string | null;
  created_at: string;
  updated_at: string;
}

export interface ClientWithDossierCount extends ClientProfile {
  dossiers_count: number;
}

export async function getAllClients(): Promise<ClientWithDossierCount[]> {
  const supabase = await createClient();
  
  // Get clients with dossier count using a subquery
  const { data, error } = await supabase
    .from('profiles')
    .select(`
      *,
      dossiers:dossiers(count)
    `)
    .eq('role', 'CLIENT')
    .order('created_at', { ascending: false });
    
  if (error) throw error;
  
  return data.map(client => ({
    ...client,
    email: client.email || '', // Get email from auth.users if needed
    dossiers_count: client.dossiers?.[0]?.count || 0
  }));
}

export async function updateClientStatus(
  clientId: string, 
  newStatus: 'PENDING' | 'ACTIVE' | 'SUSPENDED',
  reason: string
): Promise<void> {
  const supabase = await createClient();
  
  // Get old status
  const { data: client } = await supabase
    .from('profiles')
    .select('status')
    .eq('id', clientId)
    .single();
    
  // Update status
  const { error } = await supabase
    .from('profiles')
    .update({ status: newStatus })
    .eq('id', clientId);
    
  if (error) throw error;
  
  // Create event for audit trail
  await supabase.from('events').insert({
    entity_type: 'profile',
    entity_id: clientId,
    event_type: 'DOSSIER_STATUS_CHANGED', // Or create new event type
    payload: {
      old_status: client?.status,
      new_status: newStatus,
      reason
    }
  });
}
```

### Note on Email Field

The `profiles` table doesn't have an `email` field directly - it's in `auth.users`. You'll need to either:
1. Join with `auth.users` (requires service role)
2. Add email to profiles table (recommended for easier queries)
3. Fetch emails separately

**Recommendation**: Check if email is already being stored somewhere accessible or consider a migration to add it.

### API Route for Status Change

Create `app/api/admin/clients/[id]/status/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { requireAdminAuth } from '@/lib/auth';
import { updateClientStatus } from '@/lib/clients';

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  await requireAdminAuth();
  
  const { status, reason } = await request.json();
  
  if (!['PENDING', 'ACTIVE', 'SUSPENDED'].includes(status)) {
    return NextResponse.json({ error: 'Invalid status' }, { status: 400 });
  }
  
  try {
    await updateClientStatus(params.id, status, reason);
    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json({ error: 'Failed to update status' }, { status: 500 });
  }
}
```

### Design System

Use existing design tokens:
- Background: `#191A1D`
- Surface/Cards: `#2D3033`
- Border: `#363636`
- Status badges: PENDING (`#FACC15`), ACTIVE (`#4ADE80`), SUSPENDED (`#F95757`)

### Navigation Update

Add to `adminNavConfig` in `lib/navigation-config.ts`:

```typescript
{
  href: "/admin/clients",
  icon: "fa-users",
  label: "Gestion Clients",
}
```

### Component Structure

```
partnersllc-app/
├── app/(protected)/admin/clients/
│   └── page.tsx
├── components/admin/clients/
│   ├── AdminClientsContent.tsx
│   ├── ClientsTable.tsx
│   ├── ClientsFilters.tsx
│   ├── ClientStatusModal.tsx
│   └── ClientProfileSlideOver.tsx
├── lib/
│   └── clients.ts
└── app/api/admin/clients/
    └── [id]/
        └── status/
            └── route.ts
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References
No critical issues encountered. Note: Email field fetched from auth.users via admin API.

### Completion Notes List
1. Created comprehensive client management library in `lib/clients.ts`
2. Implemented data fetching with filtering, sorting, and search
3. Built full-featured client list page with table, pagination, and filters
4. Created status change modal with reason input and audit trail
5. Implemented slide-over panel with client profile, events, and dossiers
6. Added API routes for all CRUD operations
7. Navigation updated with "Gestion Clients" menu item
8. All components follow design system (dark theme with #191A1D, #2D3033, #363636)
9. Status badges color-coded: PENDING (yellow), ACTIVE (green), SUSPENDED (red)
10. Responsive design with mobile support

### File List

**Library:**
- `partnersllc-app/lib/clients.ts` (NEW)

**Pages:**
- `partnersllc-app/app/(protected)/admin/clients/page.tsx` (NEW)

**Components:**
- `partnersllc-app/components/admin/clients/AdminClientsContent.tsx` (NEW)
- `partnersllc-app/components/admin/clients/ClientsTable.tsx` (NEW)
- `partnersllc-app/components/admin/clients/ClientsFilters.tsx` (NEW)
- `partnersllc-app/components/admin/clients/ClientStatusModal.tsx` (NEW)
- `partnersllc-app/components/admin/clients/ClientProfileSlideOver.tsx` (NEW)

**API Routes:**
- `partnersllc-app/app/api/admin/clients/route.ts` (NEW)
- `partnersllc-app/app/api/admin/clients/[id]/route.ts` (NEW)
- `partnersllc-app/app/api/admin/clients/[id]/status/route.ts` (NEW)
- `partnersllc-app/app/api/admin/clients/[id]/events/route.ts` (NEW)
- `partnersllc-app/app/api/admin/clients/[id]/dossiers/route.ts` (NEW)

**Navigation:**
- `partnersllc-app/lib/navigation-config.ts` (MODIFIED)

## QA Results
*Results from QA Agent review of the completed story implementation*
