# Story 3.7: Suspended User Payment Recovery Automation

## Status

Draft

## Story

**As a** system,
**I want** to automatically send payment reminders to SUSPENDED users and enable easy payment completion,
**so that** revenue recovery is maximized without manual follow-up.

## Acceptance Criteria

1. Daily cron job (Supabase Edge Function scheduled via cron) runs at 9 AM UTC checking for SUSPENDED users
2. Query finds profiles with `status: SUSPENDED` and unpaid orders (`orders.status: PENDING`)
3. Check `payment_reminders` table to see if reminder already sent in last 3 days
4. If no recent reminder, create new Stripe Checkout Session for the unpaid order
5. Create `payment_reminders` record: `user_id`, `order_id`, `stripe_session_id`, `sent_at: now()`, `reminder_number` (1, 2, 3...)
6. Create notification with all channels (Email, WhatsApp, SMS) with message: "Complete your payment to access your [Product Name] dossier. Pay now: {stripe_checkout_url}"
7. Email template includes prominent "Complete Payment" button linking to Stripe Checkout
8. WhatsApp/SMS messages include short link to Stripe Checkout
9. In-app notification created for SUSPENDED users (shown on next login)
10. Reminder cadence: Day 1, Day 4, Day 7, Day 14, Day 30 (then stop to avoid spam)
11. After 5 reminders with no payment, mark order as `status: CANCELLED`, send final notification
12. When SUSPENDED user completes payment via reminder link, webhook processes normally (Epic 1 story 1.9)
13. Payment success notification sent: "Payment successful! Welcome back. Your dossier is ready."
14. Reminder history visible in admin dashboard for each user
15. Analytics track: Reminder sent count, Reminder → Payment conversion rate

## Tasks / Subtasks

- [ ] Create payment_reminders table schema (AC: 5)
  - [ ] Create `payment_reminders` table with columns:
    - `id` (UUID, primary key)
    - `user_id` (UUID, foreign key to profiles)
    - `order_id` (UUID, foreign key to orders)
    - `stripe_session_id` (string, reference to Stripe session)
    - `reminder_number` (integer, 1-5)
    - `sent_at` (timestamp)
    - `payment_completed_at` (timestamp, nullable)
    - `created_at` (timestamp)
  - [ ] Add indexes on user_id, order_id for query performance
  - [ ] Add constraint: only one payment_reminders per order
- [ ] Create cron job Edge Function (AC: 1)
  - [ ] Create Edge Function `/api/cron/payment-recovery`
  - [ ] Schedule with Supabase cron at 9 AM UTC daily
  - [ ] Implement scheduler call (or use external cron service)
  - [ ] Add security: verify cron secret token
  - [ ] Log execution with timestamp
- [ ] Implement user query logic (AC: 2)
  - [ ] Query profiles where `status: SUSPENDED`
  - [ ] Find associated orders where `status: PENDING`
  - [ ] Return list of (user, order) pairs needing payment recovery
- [ ] Implement reminder cadence logic (AC: 3, 10)
  - [ ] Query `payment_reminders` for (user, order)
  - [ ] Calculate days since last reminder
  - [ ] Determine if reminder should send based on cadence:
    - Day 1: No previous reminders
    - Day 4: Last reminder was 3+ days ago, reminder_number = 1
    - Day 7: Last reminder was 3+ days ago, reminder_number = 2
    - Day 14: Last reminder was 7+ days ago, reminder_number = 3
    - Day 30: Last reminder was 16+ days ago, reminder_number = 4
  - [ ] Stop reminders after reminder_number = 5
- [ ] Create Stripe Checkout Session (AC: 4)
  - [ ] For each order needing reminder, create Stripe Checkout Session
  - [ ] Session linked to order amount and user email
  - [ ] Include success/cancel URLs
  - [ ] Capture session ID for payment_reminders record
  - [ ] Handle Stripe API errors gracefully
- [ ] Create payment_reminders record (AC: 5)
  - [ ] INSERT into payment_reminders with:
    - `user_id`, `order_id`, `stripe_session_id`
    - `reminder_number` (calculated from previous reminders)
    - `sent_at: now()`
  - [ ] Update with new session ID if reminder resent
- [ ] Create multi-channel notifications (AC: 6)
  - [ ] Create single notification record with message:
    "Complete your payment to access your [Product Name] dossier. Pay now: {stripe_checkout_url}"
  - [ ] Notification channels: EMAIL, WHATSAPP, SMS, IN_APP
  - [ ] Notification processor (Stories 3.2-3.5) handles channel delivery
  - [ ] Include action link in all channels
- [ ] Create email template (AC: 7)
  - [ ] HTML email with prominent "Complete Payment" button
  - [ ] Button links to Stripe Checkout URL
  - [ ] Include order amount and product name
  - [ ] Professional design matching email templates
  - [ ] Footer with company info and support link
- [ ] Optimize SMS/WhatsApp messages (AC: 8)
  - [ ] Use shortened URL for Stripe Checkout link
  - [ ] Message template: "Complete payment for [Product] dossier. Pay now: [short-url]"
  - [ ] Keep under 160 chars for SMS
  - [ ] Match templates from Stories 3.3-3.4
- [ ] Create in-app notification (AC: 9)
  - [ ] Create in-app notification record with same content
  - [ ] In-app notification shown on next user login
  - [ ] Story 3.5 handles display in notification center
  - [ ] Include prominent payment button/link
- [ ] Implement cancellation after 5 reminders (AC: 11)
  - [ ] In cron job, check reminder_number = 5
  - [ ] If no payment received, mark order: `status: CANCELLED`
  - [ ] Create final notification: "Your order has been cancelled due to non-payment. Contact support to retry."
  - [ ] Send to all channels
  - [ ] Create event: PAYMENT_FAILED
- [ ] Implement payment success flow (AC: 12, 13)
  - [ ] When user completes payment via Stripe (Story 1.9 webhook)
  - [ ] Check if user status is SUSPENDED
  - [ ] If yes, update profile: `status: ACTIVE`
  - [ ] Update `payment_reminders.payment_completed_at: now()`
  - [ ] Create notification: "Payment successful! Welcome back. Your dossier is ready."
  - [ ] Create event: PAYMENT_RECEIVED
  - [ ] Send success notification to all channels
- [ ] Create admin dashboard integration (AC: 14)
  - [ ] Add reminder history view in admin dashboard
  - [ ] Show payment_reminders records per user
  - [ ] Display: reminder_number, sent_at, payment_completed_at, session_id
  - [ ] Allow admins to manually trigger reminders
  - [ ] Allow admins to mark as paid/cancelled
- [ ] Implement analytics (AC: 15)
  - [ ] Track reminder sent count (count payment_reminders records)
  - [ ] Track conversion rate: payments_completed / reminders_sent
  - [ ] Segment by reminder_number (which reminder converts best?)
  - [ ] Create monthly recovery report
  - [ ] Dashboard with: Total reminders, Success rate, Revenue recovered
- [ ] Create safety checks
  - [ ] Check that users are actually SUSPENDED (not accidentally sent to active users)
  - [ ] Check that orders are PENDING (not already paid)
  - [ ] Verify Stripe session creation succeeded before saving reminder record
  - [ ] Handle edge case: User pays, then immediately suspended again (rare)
- [ ] Test cron job execution (AC: 1)
  - [ ] Verify cron job runs at 9 AM UTC daily
  - [ ] Monitor logs for execution
  - [ ] Test with past date to verify past reminders don't re-trigger
  - [ ] Verify scheduler reliability (handle missed executions)

## Dev Notes

### Cron Job Architecture

**Trigger:** Daily at 9 AM UTC via Supabase Edge Function with cron

**Flow:**
1. Check all SUSPENDED users with PENDING orders
2. For each, check payment_reminders history
3. Determine if reminder due based on cadence
4. Create Stripe Checkout Session
5. Create payment_reminders record
6. Create notifications (all channels)
7. Log execution and results

**Implementation:** TypeScript Edge Function with Supabase client

### Payment Reminders Table

```sql
CREATE TABLE payment_reminders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id),
  order_id UUID NOT NULL REFERENCES orders(id),
  stripe_session_id VARCHAR NOT NULL,
  reminder_number INTEGER NOT NULL DEFAULT 1,
  sent_at TIMESTAMP NOT NULL DEFAULT now(),
  payment_completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT now(),
  UNIQUE(user_id, order_id)
);
```

### Reminder Cadence Strategy

**Timing:**
- Day 1: First suspension → Send immediate reminder
- Day 4: (~72 hours later) → Send second reminder
- Day 7: (~72 hours later) → Send third reminder
- Day 14: (~7 days later) → Send fourth reminder
- Day 30: (~16 days later) → Send fifth reminder

**Logic:**
```typescript
function shouldSendReminder(lastReminder: PaymentReminder | null): boolean {
  if (!lastReminder) return true; // Day 1
  const daysSinceLast = (Date.now() - lastReminder.sent_at) / (1000 * 86400);

  switch (lastReminder.reminder_number) {
    case 1: return daysSinceLast >= 3; // Day 4 (3+ days)
    case 2: return daysSinceLast >= 3; // Day 7 (3+ days)
    case 3: return daysSinceLast >= 7; // Day 14 (7+ days)
    case 4: return daysSinceLast >= 16; // Day 30 (16+ days)
    case 5: return false; // Stop after 5 reminders
    default: return false;
  }
}
```

### Stripe Checkout Session Creation

```typescript
// In cron job
const session = await stripe.checkout.sessions.create({
  customer_email: user.email,
  line_items: [{
    price_data: {
      currency: 'usd',
      product_data: {
        name: order.product_name,
      },
      unit_amount: order.amount * 100, // Convert to cents
    },
    quantity: 1,
  }],
  mode: 'payment',
  success_url: `${baseUrl}/dashboard/orders/${order.id}/success`,
  cancel_url: `${baseUrl}/dashboard/orders/${order.id}`,
  metadata: {
    order_id: order.id,
    user_id: user.id,
    reminder_number: nextReminderNumber,
  },
});
```

### Notification Message Templates

**Email Subject:**
"Complete Your Payment - Access Your Dossier"

**Email Body:**
```
Dear [User Name],

We noticed your account is suspended due to an unpending payment.
To regain access to your [Product Name] dossier, please complete your payment below.

Amount Due: [Order Amount]
[Button: "Complete Payment"]

If you have any questions, please contact our support team.

Best regards,
[Company Name]
```

**WhatsApp/SMS:**
```
Complete payment for [Product] dossier: [stripe-short-url]
Payment amount: [amount]
```

### User Status Transitions

**SUSPENDED → ACTIVE:**
When payment received:
1. Check user status = SUSPENDED
2. Find all PENDING orders with payment
3. Update order: status = COMPLETED
4. Update user profile: status = ACTIVE
5. Send success notification
6. Create PAYMENT_RECEIVED event

### Safety and Edge Cases

**Edge Case 1: User pays between cron runs**
- Cron queries at 9 AM UTC
- User pays at 10 AM UTC
- Payment webhook processes, marks order COMPLETED
- Next cron run sees order no longer PENDING → Skip

**Edge Case 2: Multiple unpaid orders**
- User suspended with 2 unpaid orders
- Cron sends reminder for each order
- Payment of one order → User status stays SUSPENDED (other order unpaid)
- Document: Status only activates when ALL orders paid

**Edge Case 3: User disables notifications**
- User has notification preference to disable emails
- Cron still creates notification records
- Story 3.2 respects user preferences
- SMS/WhatsApp may still send if enabled

### Admin Dashboard Features

**Payment Recovery Dashboard:**
- Total suspended users
- Total unpaid orders
- Total reminders sent this month
- Conversion rate (% of reminders → payments)
- Breakdown by reminder number (which is most effective?)
- Manual trigger: Force send reminder to specific user
- Manual mark-paid: Mark order as paid without payment
- Refund/cancel capability

### Analytics Implementation

**Metrics:**
```typescript
// Remind sent count
SELECT COUNT(*) FROM payment_reminders WHERE DATE(sent_at) = TODAY();

// Conversion rate
SELECT
  COUNT(DISTINCT CASE WHEN payment_completed_at IS NOT NULL THEN id END) /
  COUNT(*) as conversion_rate
FROM payment_reminders
WHERE DATE(sent_at) = TODAY();

// Best performing reminder
SELECT
  reminder_number,
  COUNT(*) as sent,
  COUNT(payment_completed_at) as converted,
  ROUND(100.0 * COUNT(payment_completed_at) / COUNT(*), 2) as conversion_pct
FROM payment_reminders
WHERE DATE(sent_at) >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY reminder_number
ORDER BY conversion_pct DESC;
```

### Testing Standards

- **Test location:** `__tests__/integration/payment-recovery.test.ts`
- **Framework:** Jest with Supabase test client
- **Pattern:** Create suspended user, trigger cron, verify notifications
- **Specific requirements:**
  - Verify cron job finds SUSPENDED users with PENDING orders
  - Verify reminder cadence: Day 1, 4, 7, 14, 30 sends
  - Verify no reminder sent if recent one exists
  - Verify Stripe Checkout session created
  - Verify payment_reminders record saved
  - Verify notifications created (all channels)
  - Verify after 5 reminders, order marked CANCELLED
  - Verify payment success updates user status to ACTIVE
  - Verify success notification sent
  - Test edge case: User pays during cron run
  - Test edge case: Multiple unpaid orders

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
