# Story 2.10: Admin Validation Interface & Email Notifications

## Status

Cancelled

## Story

**As an** admin,
**I want** to review and validate client field submissions with the ability to approve or reject individual fields and entire steps,
**so that** I can ensure data quality before advancing dossiers.

**As a** client,
**I want** to receive email notifications when my submissions are validated or rejected with clear feedback,
**so that** I know the status of my dossier and what actions I need to take.

## Context

This story creates the **admin interface** for the validation system introduced in Story 2.9 (migrations) and Story 2.11 (client workflow updates).

**Prerequisites:**

- Story 2.9: Database migrations completed (validation_status fields, review tables, RLS policies)
- Story 2.11: Client workflow updated to handle validation statuses

**This story delivers:**

1. Admin dashboard to review pending field values and step instances
2. Field-level validation interface (approve/reject with feedback)
3. Step-level validation interface
4. Email notifications to clients (rejection, approval)
5. Real-time admin notifications

## Acceptance Criteria

### Admin Review Dashboard

1. Admin page at `/admin/reviews` showing pending validations
2. Two tabs: "Champs Ã  valider" (Field Values) and "Ã‰tapes Ã  valider" (Step Instances)
3. "Champs Ã  valider" tab displays table with columns: Client, Dossier, Ã‰tape, Champ, Valeur, Date, Statut, Actions
4. "Ã‰tapes Ã  valider" tab displays table with columns: Client, Dossier, Ã‰tape, Champs validÃ©s, Date soumission, Statut, Actions
5. Filter dropdown: Tous, En attente, En rÃ©vision, ValidÃ©s, RefusÃ©s
6. Search bar: Search by client name or dossier ID
7. Pagination: 25 items per page with page numbers
8. Click row to open detail view
9. Badge showing count of pending reviews in admin header

### Field Value Validation Interface

10. Click field row opens modal showing: Field label, Value, Client name, Dossier ID, Step name, Validation rules, Submission date
11. Show field validation rules for context (required, min/max length, pattern, etc.)
12. "Approuver" button (green) with confirmation tooltip
13. "Rejeter" button (red) opens rejection reason textarea
14. Rejection reason required, min 10 characters, max 500 characters
15. Character counter below textarea: "X/500 caractÃ¨res"
16. Validation error if rejection reason too short
17. Success toast after approval: "Champ validÃ© avec succÃ¨s"
18. Success toast after rejection: "Champ refusÃ©. Email envoyÃ© au client."
19. Review history timeline below showing previous reviews (date, admin, status, comment)
20. Modal closes after action, table refreshes

### Step Instance Validation Interface

21. Page at `/admin/reviews/step/[step_instance_id]` showing full step details
22. Page header: Step name, Client name, Dossier ID, Submission date
23. Table of all fields for this step with columns: Champ, Valeur, Statut, Raison de refus, Actions
24. Visual progress: "X/Y champs validÃ©s" with progress bar
25. Individual field actions: Approve icon button, Reject icon button
26. Bulk action: "Approuver tous les champs en attente" button (enabled only if at least one field PENDING)
27. Step-level "Valider l'Ã©tape" button enabled only when all fields APPROVED
28. Step-level "Rejeter l'Ã©tape" button with overall rejection textarea
29. Auto-refresh when field validation changes (real-time)
30. Back button to return to reviews list

### Email Notifications - Field Rejection

31. Email sent to client when any field value is set to REJECTED
32. Subject: "PARTNERS LLC - Correction requise pour votre dossier"
33. Email body includes: Client name, Field label, Rejection reason, Link to dashboard
34. Professional email template with PARTNERS LLC branding
35. CTA button: "Corriger maintenant" linking to `/dashboard`
36. Email sent via Resend or SendGrid API

### Email Notifications - Step Rejection

37. Email sent to client when step instance is set to REJECTED
38. Subject: "PARTNERS LLC - Ã‰tape refusÃ©e : [Step Name]"
39. Email body includes: Client name, Step name, List of rejected fields with reasons, Link to dashboard
40. Summary: "X champs nÃ©cessitent des corrections"
41. CTA button: "Voir les corrections"
42. Email lists each rejected field with its rejection reason

### Email Notifications - Step Approval

43. Email sent to client when step instance is set to APPROVED
44. Subject: "PARTNERS LLC - Ã‰tape validÃ©e : [Step Name]"
45. Email body includes: Client name, Step name, Congratulations message, Next step information
46. CTA button: "Continuer mon dossier"
47. Progress indicator: "Ã‰tape X/Y complÃ©tÃ©e"

### Real-time Admin Notifications

48. Admin header shows notification badge with count of pending reviews
49. Badge updates in real-time when client submits or resubmits
50. Click badge navigates to `/admin/reviews`
51. Badge color: Red if > 10 pending, Yellow if > 5, Gray otherwise

## UI Design System & Visual DNA

**CRITICAL:** Admin interface must be professional, efficient, and follow the dark theme.

### Color System

```css
--brand-dark-bg: #191A1D
--brand-dark-surface: #2D3033
--brand-dark-border: #363636
--brand-text-primary: #F9F9F9
--brand-text-secondary: #B7B7B7
--brand-accent: #00F0FF
--brand-success: #4ADE80
--brand-warning: #FACC15
--brand-danger: #F95757
--admin-active: #F9F9F9  /* White active state for admin sidebar */
```

### Admin Dashboard Layout

**Page Structure:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header: Validation des dossiers     [Badge]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Champs Ã  valider] [Ã‰tapes Ã  valider]      â”‚
â”‚                                            â”‚
â”‚ [Filter â–¾] [Search: ________] [25/page â–¾] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TABLE                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Cl â”‚ Doss â”‚ Ã‰tap â”‚ Chmp â”‚ Stat â”‚ Act â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚... â”‚ ...  â”‚ ...  â”‚ ...  â”‚ ...  â”‚ ... â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚
â”‚ [< Previous] [1] [2] [3] [Next >]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Status Badges

**Field Value Status:**

- PENDING: `bg-brand-warning/10 text-brand-warning border-brand-warning` + â³ icon
- APPROVED: `bg-brand-success/10 text-brand-success border-brand-success` + âœ“ icon
- REJECTED: `bg-brand-danger/10 text-brand-danger border-brand-danger` + âœ— icon

**Step Instance Status:**

- DRAFT: `bg-gray-500/10 text-gray-500 border-gray-500` + âœï¸ icon
- SUBMITTED: `bg-blue-500/10 text-blue-500 border-blue-500` + ğŸ“¨ icon
- UNDER_REVIEW: `bg-purple-500/10 text-purple-500 border-purple-500` + ğŸ‘ï¸ icon
- APPROVED: `bg-brand-success/10 text-brand-success border-brand-success` + âœ“ icon
- REJECTED: `bg-brand-danger/10 text-brand-danger border-brand-danger` + âœ— icon

### Field Validation Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validation du champ         [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Client: John Doe                 â”‚
â”‚ Dossier: #ABC123                 â”‚
â”‚ Ã‰tape: Qualification             â”‚
â”‚ Champ: Email                     â”‚
â”‚                                  â”‚
â”‚ Valeur soumise:                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ john.doe@example.com         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚ RÃ¨gles de validation:            â”‚
â”‚ â€¢ Requis: Oui                    â”‚
â”‚ â€¢ Type: Email                    â”‚
â”‚ â€¢ Pattern: ^[^@]+@[^@]+\.[^@]+$ â”‚
â”‚                                  â”‚
â”‚ Soumis le: 07/01/2026 14:30     â”‚
â”‚                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Historique des rÃ©visions:        â”‚
â”‚ â€¢ 05/01 14:00 - RefusÃ© par Aliceâ”‚
â”‚   "Format invalide"             â”‚
â”‚ â€¢ 07/01 14:30 - Resoumis        â”‚
â”‚                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ [Approuver] [Rejeter]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rejection Reason Textarea:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Raison du refus *                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Expliquez pourquoi...        â”‚ â”‚
â”‚ â”‚                              â”‚ â”‚
â”‚ â”‚                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ 45/500 caractÃ¨res                â”‚
â”‚                                  â”‚
â”‚ [Annuler] [Confirmer le refus]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Email Template Design

**HTML Email Template (React Email):**

```tsx
<Html>
  <Head />
  <Body style={{ backgroundColor: "#F5F5F5", fontFamily: "Inter, sans-serif" }}>
    <Container
      style={{
        maxWidth: "600px",
        margin: "40px auto",
        backgroundColor: "#FFFFFF",
        borderRadius: "16px",
        overflow: "hidden",
      }}
    >
      {/* Header */}
      <div style={{ backgroundColor: "#00F0FF", height: "4px" }} />
      <div style={{ padding: "32px", textAlign: "center" }}>
        <img src="logo.png" alt="PARTNERS LLC" height="40" />
      </div>

      {/* Content */}
      <div style={{ padding: "0 32px 32px" }}>
        <Heading
          style={{ color: "#191A1D", fontSize: "24px", marginBottom: "16px" }}
        >
          Correction requise
        </Heading>

        <Text
          style={{ color: "#666666", fontSize: "16px", lineHeight: "24px" }}
        >
          Bonjour {clientName},
        </Text>

        <Text
          style={{ color: "#666666", fontSize: "16px", lineHeight: "24px" }}
        >
          Nous avons examinÃ© votre soumission et un champ nÃ©cessite une
          correction :
        </Text>

        {/* Field Info Card */}
        <div
          style={{
            backgroundColor: "#F9F9F9",
            padding: "20px",
            borderRadius: "12px",
            margin: "20px 0",
            borderLeft: "4px solid #F95757",
          }}
        >
          <Text
            style={{ color: "#191A1D", fontWeight: "bold", margin: "0 0 8px" }}
          >
            ğŸ“‹ {fieldLabel}
          </Text>
          <Text style={{ color: "#F95757", fontWeight: "bold", margin: "0" }}>
            âŒ {rejectionReason}
          </Text>
        </div>

        {/* CTA Button */}
        <div style={{ textAlign: "center", margin: "32px 0" }}>
          <Button
            href="https://app.partnersllc.com/dashboard"
            style={{
              backgroundColor: "#00F0FF",
              color: "#191A1D",
              padding: "14px 32px",
              borderRadius: "12px",
              textDecoration: "none",
              fontWeight: "bold",
              fontSize: "16px",
              display: "inline-block",
            }}
          >
            Corriger maintenant
          </Button>
        </div>
      </div>

      {/* Footer */}
      <div
        style={{
          backgroundColor: "#F9F9F9",
          padding: "24px 32px",
          borderTop: "1px solid #E5E5E5",
        }}
      >
        <Text
          style={{
            color: "#999999",
            fontSize: "12px",
            textAlign: "center",
            margin: "0",
          }}
        >
          Â© 2026 PARTNERS LLC - Tous droits rÃ©servÃ©s
        </Text>
        <Text
          style={{
            color: "#999999",
            fontSize: "12px",
            textAlign: "center",
            margin: "8px 0 0",
          }}
        >
          <a
            href="mailto:support@partnersllc.com"
            style={{ color: "#00F0FF", textDecoration: "none" }}
          >
            Besoin d'aide ?
          </a>
        </Text>
      </div>
    </Container>
  </Body>
</Html>
```

## Tasks / Subtasks

- [ ] Create admin review dashboard (AC: 1-9)

  - [ ] Build `/admin/reviews` page layout with tabs
  - [ ] Create ReviewsTable component for fields and steps
  - [ ] Implement filters, search, pagination
  - [ ] Fetch data from `pending_field_values_for_review` and `pending_step_instances_for_review` views
  - [ ] Add pending count badge to admin header

- [ ] Build field validation modal (AC: 10-20)

  - [ ] Create FieldValidationModal component
  - [ ] Display field details and validation rules
  - [ ] Add Approve and Reject buttons
  - [ ] Implement rejection reason textarea with validation
  - [ ] Show review history timeline
  - [ ] Handle approve/reject actions with API calls

- [ ] Build step validation page (AC: 21-30)

  - [ ] Create `/admin/reviews/step/[id]` page
  - [ ] Display all fields for step in table
  - [ ] Add visual progress indicator
  - [ ] Implement individual field approve/reject
  - [ ] Add bulk approve action
  - [ ] Add step-level validate/reject actions
  - [ ] Implement auto-refresh with Supabase Realtime

- [ ] Set up email service and templates (AC: 31-47)

  - [ ] Install Resend SDK (`npm install resend react-email`)
  - [ ] Create React Email templates for rejection/approval
  - [ ] Build email utility functions
  - [ ] Create API route `/api/emails/send-validation-notification`
  - [ ] Test email delivery and rendering

- [ ] Implement validation API routes (New)

  - [ ] `POST /api/admin/field-values/[id]/approve`
  - [ ] `POST /api/admin/field-values/[id]/reject` (triggers email)
  - [ ] `POST /api/admin/step-instances/[id]/approve` (triggers email)
  - [ ] `POST /api/admin/step-instances/[id]/reject` (triggers email)
  - [ ] `POST /api/admin/step-instances/[id]/bulk-approve-fields`

- [ ] Add real-time notifications (AC: 48-51)
  - [ ] Subscribe to step_instances changes (SUBMITTED status)
  - [ ] Update badge count in real-time
  - [ ] Add toast notification when new review needed

## Dev Notes

### API Routes

**POST `/api/admin/field-values/[id]/approve`**

```typescript
import { createClient } from "@/lib/supabase/server";

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const supabase = createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  // Verify user is an agent
  const { data: agent } = await supabase
    .from("agents")
    .select("id")
    .eq("email", user.email)
    .eq("active", true)
    .single();

  if (!agent) {
    return new Response("Forbidden", { status: 403 });
  }

  // Update field value
  const { data, error } = await supabase
    .from("step_field_values")
    .update({
      validation_status: "APPROVED",
      reviewed_by: agent.id,
      reviewed_at: new Date().toISOString(),
      rejection_reason: null,
    })
    .eq("id", params.id)
    .select()
    .single();

  if (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
    });
  }

  return new Response(JSON.stringify({ success: true, data }), { status: 200 });
}
```

**POST `/api/admin/field-values/[id]/reject`**

```typescript
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  const supabase = createClient();
  const { rejection_reason } = await request.json();

  if (!rejection_reason || rejection_reason.length < 10) {
    return new Response("Rejection reason must be at least 10 characters", {
      status: 400,
    });
  }

  // ... verify agent ...

  // Update field value
  const { data: fieldValue } = await supabase
    .from("step_field_values")
    .update({
      validation_status: "REJECTED",
      rejection_reason,
      reviewed_by: agent.id,
      reviewed_at: new Date().toISOString(),
    })
    .eq("id", params.id)
    .select("*, step_instances(*, dossiers(*, profiles(*)))")
    .single();

  // Send email notification
  await sendFieldRejectionEmail(fieldValue);

  return new Response(JSON.stringify({ success: true }), { status: 200 });
}
```

### Email Sending Utility

```typescript
// lib/emails/send-email.ts
import { Resend } from "resend";
import FieldRejectionEmail from "./templates/field-rejection";
import StepRejectionEmail from "./templates/step-rejection";
import StepApprovalEmail from "./templates/step-approval";

const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendFieldRejectionEmail(fieldValue: any) {
  const clientEmail = fieldValue.step_instances.dossiers.profiles.email;
  const clientName = fieldValue.step_instances.dossiers.profiles.full_name;

  await resend.emails.send({
    from: "PARTNERS LLC <noreply@partnersllc.com>",
    to: clientEmail,
    subject: "PARTNERS LLC - Correction requise pour votre dossier",
    react: FieldRejectionEmail({
      clientName,
      fieldLabel: fieldValue.step_fields.label,
      rejectionReason: fieldValue.rejection_reason,
      dashboardUrl: "https://app.partnersllc.com/dashboard",
    }),
  });
}

export async function sendStepApprovalEmail(stepInstance: any) {
  // Similar implementation
}

export async function sendStepRejectionEmail(
  stepInstance: any,
  rejectedFields: any[]
) {
  // Similar implementation with list of rejected fields
}
```

### Real-time Subscription

```typescript
// Admin header component
import { useEffect, useState } from "react";
import { createClient } from "@/lib/supabase/client";

export function AdminHeader() {
  const [pendingCount, setPendingCount] = useState(0);
  const supabase = createClient();

  useEffect(() => {
    // Fetch initial count
    fetchPendingCount();

    // Subscribe to real-time changes
    const channel = supabase
      .channel("admin-notifications")
      .on(
        "postgres_changes",
        {
          event: "UPDATE",
          schema: "public",
          table: "step_instances",
          filter: "validation_status=eq.SUBMITTED",
        },
        () => {
          fetchPendingCount();
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  const fetchPendingCount = async () => {
    const { count } = await supabase
      .from("step_instances")
      .select("*", { count: "exact", head: true })
      .in("validation_status", ["SUBMITTED", "UNDER_REVIEW"]);

    setPendingCount(count || 0);
  };

  return (
    <header>
      {/* ... */}
      <NotificationBadge count={pendingCount} />
    </header>
  );
}
```

### Testing Checklist

- [ ] Admin can view pending field values
- [ ] Admin can approve field value
- [ ] Admin can reject field value with reason
- [ ] Rejection reason validation works (min 10 chars)
- [ ] Email sent on field rejection
- [ ] Email sent on step rejection
- [ ] Email sent on step approval
- [ ] Emails render correctly in Gmail/Outlook
- [ ] Real-time badge updates when client submits
- [ ] Review history displays correctly
- [ ] Bulk approve works for all pending fields
- [ ] Step validation only enabled when all fields approved

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2026-01-07 | 1.0     | Initial story creation for admin validation interface | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

## QA Results

_Results from QA Agent review will be documented here._
