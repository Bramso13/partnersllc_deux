# Story 2.5: Document Review and Approval Workflow

## Status

Draft

## Story

**As an** agent,
**I want** to review document previews and approve or reject them with clear feedback,
**so that** clients receive timely validation of their submissions and know if corrections are needed.

## Acceptance Criteria

1. Review modal opens when "Review" button clicked, displaying full-screen document preview
2. PDF documents rendered using PDF viewer library (react-pdf or similar) with zoom and navigation controls
3. Image documents (JPG, PNG) displayed with zoom and pan capabilities
4. Sidebar shows document metadata: Document Type, Client Name, Dossier ID, Upload Date, File Size, Version Number
5. If document has previous versions, version history shown with links to view older versions
6. "Approve" button (green) and "Reject" button (red) prominently displayed
7. Clicking "Approve" creates `document_reviews` record with: `document_version_id`, `reviewer_id` (current agent), `review_status: APPROVED`, `reviewed_at: now()`
8. Approval updates `document_versions.status: APPROVED`
9. Approval creates event: `DOCUMENT_REVIEWED` with payload including review details
10. Clicking "Reject" shows text area requiring rejection reason (minimum 10 characters)
11. Rejection creates `document_reviews` record with: `review_status: REJECTED`, `rejection_reason`
12. Rejection updates `document_versions.status: REJECTED`
13. Rejection creates event: `DOCUMENT_REVIEWED`
14. After approve or reject, modal closes and next pending document loads automatically (for efficiency)
15. Toast notification confirms action: "Document approved" or "Document rejected. Client will be notified."
16. Review actions logged in agent activity history for audit trail

## Tasks / Subtasks

- [ ] Create review modal component (AC: 1)
  - [ ] Build full-screen modal layout
  - [ ] Create close button
  - [ ] Fetch document details
- [ ] Implement PDF viewer (AC: 2)
  - [ ] Integrate react-pdf library
  - [ ] Add zoom controls
  - [ ] Add page navigation for PDFs
  - [ ] Handle PDF rendering errors
- [ ] Implement image viewer (AC: 3)
  - [ ] Display JPG/PNG with zoom capability
  - [ ] Add pan/drag functionality
  - [ ] Handle image loading
- [ ] Build metadata sidebar (AC: 4)
  - [ ] Display Document Type name
  - [ ] Show Client Name
  - [ ] Show Dossier ID
  - [ ] Show Upload Date
  - [ ] Show File Size
  - [ ] Show Version Number
- [ ] Implement version history (AC: 5)
  - [ ] Query previous versions
  - [ ] Display version history with links
  - [ ] Allow viewing older versions
- [ ] Build action buttons (AC: 6)
  - [ ] Create green "Approve" button
  - [ ] Create red "Reject" button
  - [ ] Position prominently
- [ ] Implement approval logic (AC: 7, 8, 9)
  - [ ] Create `document_reviews` record on approval
  - [ ] Update `document_versions.status` to APPROVED
  - [ ] Create `DOCUMENT_REVIEWED` event with payload
  - [ ] Record reviewer_id (current agent)
  - [ ] Set reviewed_at timestamp
- [ ] Implement rejection flow (AC: 10, 11, 12, 13)
  - [ ] Show text area for rejection reason
  - [ ] Validate minimum 10 characters
  - [ ] Create `document_reviews` record with rejection_reason
  - [ ] Update `document_versions.status` to REJECTED
  - [ ] Create `DOCUMENT_REVIEWED` event
- [ ] Implement modal auto-advance (AC: 14)
  - [ ] Fetch next pending document after approval/rejection
  - [ ] Load next document in modal automatically
  - [ ] Close modal if no more pending documents
- [ ] Add action notifications (AC: 15)
  - [ ] Show "Document approved" toast on approval
  - [ ] Show "Document rejected. Client will be notified." toast on rejection
- [ ] Log activity history (AC: 16)
  - [ ] Create entry in agent activity history
  - [ ] Record approval/rejection action
  - [ ] Include document and dossier info
  - [ ] Timestamp the action

## Dev Notes

### Database Context

**Document Versions Table:**
- `id`: UUID primary key
- `document_id`: UUID foreign key
- `version_number`: integer
- `file_path`: text (Supabase Storage path)
- `file_size`: integer (bytes)
- `mime_type`: text
- `status`: ENUM (PENDING, APPROVED, REJECTED, OUTDATED)
- `created_at`: timestamp

**Document Reviews Table (NEW):**
- `id`: UUID primary key
- `document_version_id`: UUID foreign key
- `reviewer_id`: UUID foreign key (agents/users table)
- `review_status`: ENUM (APPROVED, REJECTED)
- `rejection_reason`: text (nullable)
- `reviewed_at`: timestamp

**Events Table:**
- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `event_type`: ENUM (DOSSIER_CREATED, DOCUMENT_UPLOADED, DOCUMENT_REVIEWED, STEP_COMPLETED, DOSSIER_STATUS_CHANGED)
- `payload`: JSON
- `created_at`: timestamp

**Agent Activity History Table (NEW):**
- `id`: UUID primary key
- `agent_id`: UUID foreign key (users table)
- `action_type`: text
- `entity_type`: text (DOCUMENT, DOSSIER, etc.)
- `entity_id`: UUID
- `details`: JSON (additional context)
- `created_at`: timestamp

### Supabase Storage Access

Get download URL for document preview:
```typescript
const { data: urlData } = await supabase.storage
  .from('documents')
  .createSignedUrl(filePath, 3600); // 1 hour expiry

const publicUrl = urlData?.signedUrl;
```

### PDF Viewer Integration

Use react-pdf library:
```bash
npm install react-pdf pdfjs-dist
```

Initialize PDF worker:
```typescript
import { pdfjs } from 'react-pdf';
pdfjs.GlobalWorkerOptions.workerSrc = `/pdf.worker.min.js`;
```

### Image Viewer Libraries

Consider:
- `react-image-zoom`
- `yet-another-react-lightbox`
- Custom canvas-based zoom/pan

### Server Actions for Review

```typescript
// app/admin/reviews/approve-document.ts
'use server'

export async function approveDocument(documentVersionId: string) {
  // Create document_reviews record
  // Update document_versions.status
  // Create DOCUMENT_REVIEWED event
  // Log agent activity
  // Return next pending document
}

export async function rejectDocument(
  documentVersionId: string,
  rejectionReason: string
) {
  // Create document_reviews record with rejection_reason
  // Update document_versions.status
  // Create DOCUMENT_REVIEWED event
  // Log agent activity
  // Return next pending document
}
```

### Event Payload Structure

```typescript
// DOCUMENT_REVIEWED event payload
{
  document_id: string;
  document_version_id: string;
  dossier_id: string;
  client_id: string;
  agent_id: string;
  review_status: 'APPROVED' | 'REJECTED';
  rejection_reason?: string;
  reviewed_at: timestamp;
}
```

### Component Architecture

- **DocumentReviewModal:** Client Component with document preview and review actions
- **PDFViewer Component:** Displays PDF with controls
- **ImageViewer Component:** Displays JPG/PNG with zoom
- **MetadataSidebar Component:** Shows document info
- **VersionHistory Component:** Displays previous versions
- **RejectionReasonForm Component:** Text area for rejection reason
- **ActionButtons Component:** Approve/Reject buttons

### Rejection Reason Validation

- Minimum 10 characters
- Required when rejecting
- Show validation error if too short

### Auto-Advance Logic

After approval or rejection:
```typescript
// Query next pending document
const nextPending = await fetchNextPendingDocument();

if (nextPending) {
  // Load next document in modal
  setCurrentDocument(nextPending);
} else {
  // Close modal
  closeModal();
  showToast('All reviews complete!');
}
```

### Testing

- Test modal opens on Review button click
- Test PDF displays with zoom and navigation
- Test image displays with zoom
- Test metadata displays correctly
- Test version history shows previous versions
- Test approval creates document_reviews record
- Test approval updates status to APPROVED
- Test approval creates DOCUMENT_REVIEWED event
- Test rejection requires reason (10+ chars)
- Test rejection creates proper records
- Test auto-advance to next document
- Test modal closes when no more pending
- Test toast notifications show
- Test agent activity logged
- Test multiple reviews in sequence

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-06 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be documented here.*
