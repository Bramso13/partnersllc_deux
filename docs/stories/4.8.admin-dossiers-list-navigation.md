# Story 4.8: Admin Dossiers List & Navigation Update

## Status

Ready for Review

## Story

**As an** admin,
**I want** to view a comprehensive list of all dossiers with the ability to select one to work on, and have an updated navigation reflecting all existing admin pages,
**so that** I can easily find and access any dossier in the system and navigate efficiently between all admin tools.

## Acceptance Criteria

### Admin Dossiers List Page

1. Dossiers list page at `/admin/dossiers` displays all dossiers in the system (no user filtering, agents see all)
2. Data fetched using new `getAllAdminDossiers()` function with proper agent authentication
3. Each dossier displayed as a card showing: Client name/email, Product name, Status badge, Progress percentage, Current step title, Created date, Assigned agent name (if any)
4. Cards arranged in responsive grid: 1 column (mobile), 2 columns (tablet), 3 columns (desktop)
5. Empty state shown when no dossiers exist: "Aucun dossier trouvé dans le système."
6. Loading skeleton shown while fetching dossiers

### Status Filter

7. Filter dropdown above grid showing all available statuses
8. Filter options: "Tous les statuts" (default), "QUALIFICATION", "FORM_SUBMITTED", "NM_PENDING", "LLC_ACCEPTED", "EIN_PENDING", "BANK_PREPARATION", "BANK_OPENED", "WAITING_48H", "IN_PROGRESS", "UNDER_REVIEW", "COMPLETED", "CLOSED", "ERROR"
9. Filter dropdown styled with dark theme colors from design system (bg: #2D3033, accent: #00F0FF)
10. Selecting a status filters cards to show only dossiers with that status
11. Active filter shows count: "X dossiers" or "X dossier"
12. Filter persists in URL query parameter: `?status=IN_PROGRESS`

### Search Functionality

13. Search input field above grid with placeholder "Rechercher par nom de client, email, ou numéro de dossier..."
14. Search filters dossiers in real-time (debounced 300ms)
15. Search matches against: Client name, Client email, Dossier ID, Product name, Dossier metadata
16. Search is case-insensitive
17. Search input has clear button (X) when text is entered
18. Search term persists in URL query parameter: `?search=john`

### Sort Functionality

19. Sort dropdown with options: "Plus récents" (default), "Plus anciens", "Progression croissante", "Progression décroissante", "Statut A-Z"
20. Sort is applied client-side to filtered results
21. Sort selection persists in URL query parameter: `?sort=progress_asc`

### Dossier Selection & Navigation

22. Each dossier card is clickable, navigating to `/admin/dossiers/[id]` (existing detail page)
23. Hover state on cards: subtle scale transform, border color change to accent cyan
24. Cards show "Voir le dossier" button on hover for explicit call-to-action
25. Quick action badges on cards: "Documents en attente" badge showing count of pending documents if any exist

### Admin Navigation Update

26. Navigation config at `partnersllc-app/lib/navigation-config.ts` updated to reflect all existing admin pages
27. Admin navigation menu section includes:
    - Vue d'ensemble (href: `/admin`, icon: `fa-chart-pie`) - links to dashboard overview if exists, or analytics
    - Tableau de bord (href: `/admin/dashboard`, icon: `fa-gauge-high`) - agent personal dashboard
    - Dossiers LLC (href: `/admin/dossiers`, icon: `fa-folder-tree`) - NEW page from this story
    - Gestion Clients (href: `/admin/clients`, icon: `fa-users`) - client management (Story 4.10)
    - Gestion Agents (href: `/admin/agents`, icon: `fa-user-tie`) - agent management (Story 4.11)
    - Produits (href: `/admin/products`, icon: `fa-box`) - existing products management
    - Liens de paiement (href: `/admin/payment-links`, icon: `fa-link`) - existing payment links
    - Analytiques (href: `/admin/analytics`, icon: `fa-chart-line`) - existing analytics dashboard
28. Navigation items ordered logically by frequency of use and workflow
29. Active route highlighted with accent color (#00F0FF) and left border indicator
30. Navigation responsive: Collapsible sidebar on mobile, persistent sidebar on desktop

### Performance & UX

31. Dossiers list page loads within 2 seconds for up to 500 dossiers
32. Search and filter operations feel instant (< 100ms perceived delay)
33. Page maintains scroll position when returning from dossier detail view (using URL state restoration)
34. Error state handles network failures with retry button and clear error message
35. Agent authentication enforced: Only users with role AGENT or ADMIN can access `/admin/dossiers`

## Tasks / Subtasks

- [ ] Create admin dossiers list data fetching function (AC: 2, 35)

  - [ ] Add `getAllAdminDossiers()` function to `partnersllc-app/lib/dossiers.ts`
  - [ ] Query all dossiers with products, step instances, and user details (LEFT JOIN on users table)
  - [ ] Calculate progress percentage and completed steps count for each dossier
  - [ ] Return array of `DossierWithDetails` including client name and email
  - [ ] Test function with multiple dossiers in different statuses

- [ ] Build admin dossiers list page component (AC: 1, 3, 4, 5, 6)

  - [ ] Create page at `partnersllc-app/app/(protected)/admin/dossiers/page.tsx`
  - [ ] Add `requireAgentAuth()` middleware check
  - [ ] Fetch dossiers using `getAllAdminDossiers()` server-side
  - [ ] Create `AdminDossiersListContent` client component in `partnersllc-app/components/admin/dossiers/`
  - [ ] Build dossier card component showing all required details
  - [ ] Implement responsive grid layout (1/2/3 columns)
  - [ ] Add loading skeleton component
  - [ ] Add empty state with icon and message

- [ ] Implement status filter (AC: 7-12)

  - [ ] Create `StatusFilter` component (reuse/adapt from client version if applicable)
  - [ ] Build dropdown with all status options using dark theme colors
  - [ ] Add "Tous les statuts" default option
  - [ ] Implement client-side filtering logic
  - [ ] Show dossier count for active filter
  - [ ] Sync filter state with URL query parameter using `useSearchParams` and `useRouter`
  - [ ] Style with design system colors (bg: #2D3033, accent: #00F0FF)

- [ ] Implement search functionality (AC: 13-18)

  - [ ] Create search input component with Font Awesome search icon
  - [ ] Add debounced search handler (300ms delay using `useDebounce` hook or custom implementation)
  - [ ] Implement case-insensitive search matching against client name, email, dossier ID, product name, metadata
  - [ ] Add clear button (X icon) that appears when text is entered
  - [ ] Sync search term with URL query parameter
  - [ ] Test search with various inputs and edge cases

- [ ] Implement sort functionality (AC: 19-21)

  - [ ] Create sort dropdown component
  - [ ] Add sort options: Plus récents, Plus anciens, Progression croissante/décroissante, Statut A-Z
  - [ ] Implement sort logic for each option (created_at desc/asc, progress_percentage asc/desc, status alphabetical)
  - [ ] Sync sort selection with URL query parameter
  - [ ] Apply sort to filtered results before rendering

- [ ] Add dossier selection and navigation (AC: 22-25)

  - [ ] Make dossier cards clickable with Next.js `Link` component
  - [ ] Add hover state with scale transform (scale: 1.02) and border color change
  - [ ] Show "Voir le dossier" button on hover
  - [ ] Add "Documents en attente" badge if dossier has pending documents (query from `documents` table joined with `document_versions`)
  - [ ] Test navigation to existing `/admin/dossiers/[id]` page
  - [ ] Ensure URL state is preserved on back navigation

- [ ] Update admin navigation config (AC: 26-30)

  - [ ] Update `partnersllc-app/lib/navigation-config.ts` file
  - [ ] Modify `adminNavConfig` sections to include all existing admin pages
  - [ ] Add new menu items: Tableau de bord, Dossiers LLC (new), Produits, Liens de paiement, Analytiques
  - [ ] Order items logically by workflow and frequency
  - [ ] Verify navigation highlights active route with accent color and left border
  - [ ] Test navigation on mobile (collapsible) and desktop (persistent sidebar)
  - [ ] Ensure Font Awesome icons render correctly

- [ ] Performance optimization and error handling (AC: 31-34)

  - [ ] Add loading states for initial data fetch
  - [ ] Optimize search/filter to feel instant (memoize filtered results)
  - [ ] Implement error boundary for network failures
  - [ ] Add retry button on error state
  - [ ] Test with 500+ dossiers to ensure performance meets 2-second load time
  - [ ] Verify scroll position restoration works correctly

- [ ] Testing (AC: All)
  - [ ] Test with various dossier counts (0, 1, 50, 500)
  - [ ] Test all filter combinations (status + search + sort)
  - [ ] Test agent vs admin role access (both should work)
  - [ ] Test client role access (should be denied with 403)
  - [ ] Test navigation between dossiers list and detail pages
  - [ ] Test responsive layout on mobile, tablet, desktop
  - [ ] Verify all URL query parameters persist and restore correctly
  - [ ] Test error states and retry functionality

## Dev Notes

This story creates a comprehensive admin dossiers list page similar to the client version (Story 2.12) but with full system visibility for agents. It also updates the admin navigation to reflect all existing admin pages that have been built in previous stories.

### Key Differences from Client Dossiers List (Story 2.12)

- **No RLS filtering**: Agents see ALL dossiers in the system, not just their own
- **Client information displayed**: Cards show client name and email since agents need to identify whose dossier it is
- **Assigned agent shown**: If dossier is assigned to an agent, their name is displayed
- **Pending documents badge**: Agents need quick visibility into which dossiers need attention
- **Navigation context**: Admin navigation instead of client navigation

### Data Fetching

Create new function `getAllAdminDossiers()` in `partnersllc-app/lib/dossiers.ts`:

```typescript
/**
 * Get all dossiers for admin view (no user filtering)
 * Requires agent authentication to access
 */
export async function getAllAdminDossiers(): Promise<
  DossierWithDetailsAndClient[]
> {
  const supabase = await createClient();

  // Fetch all dossiers with client information
  const { data: dossiers, error: dossiersError } = await supabase
    .from("dossiers")
    .select(
      `
      *,
      user:users!dossiers_user_id_fkey(id, email, full_name),
      assigned_agent:users!dossiers_assigned_agent_id_fkey(id, email, full_name)
    `
    )
    .order("created_at", { ascending: false });

  if (dossiersError) {
    console.error("Error fetching admin dossiers:", dossiersError);
    throw dossiersError;
  }

  // ... enrich with product, steps, progress similar to getUserDossiers()
}
```

**Note**: You'll need to add a new interface `DossierWithDetailsAndClient` that extends `DossierWithDetails` to include client information:

```typescript
export interface DossierWithDetailsAndClient extends DossierWithDetails {
  user?: {
    id: string;
    email: string;
    full_name: string;
  } | null;
  assigned_agent?: {
    id: string;
    email: string;
    full_name: string;
  } | null;
  pending_documents_count?: number;
}
```

### Project Structure

**Source:** `docs/architecture.md#Repository Structure`

```
partnersllc-app/
├── app/(protected)/admin/dossiers/
│   ├── page.tsx                           # Admin dossiers list page (NEW)
│   └── [id]/
│       ├── page.tsx                        # Existing detail page
│       └── AdminDossierDetailContent.tsx   # Existing detail component
├── components/admin/dossiers/
│   ├── AdminDossiersListContent.tsx       # NEW - Main list component
│   ├── AdminDossierCard.tsx               # NEW - Individual dossier card
│   └── AdminDossiersFilters.tsx           # NEW - Filters component (status, search, sort)
├── lib/
│   ├── dossiers.ts                        # Add getAllAdminDossiers() function
│   └── navigation-config.ts               # Update adminNavConfig
```

### Design System Colors

**Source:** `docs/architecture.md#Design System Constraints`

Use the following colors from the design system:

- Main Background: `#191A1D`
- Surface (card background): `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

### Status Badge Colors

Map status to badge colors:

- QUALIFICATION → Blue (`#60A5FA`)
- FORM_SUBMITTED → Purple (`#A78BFA`)
- NM_PENDING, LLC_ACCEPTED, EIN_PENDING → Yellow (`#FACC15`)
- BANK_PREPARATION, BANK_OPENED → Cyan (`#00F0FF`)
- IN_PROGRESS, UNDER_REVIEW → Orange (`#FB923C`)
- COMPLETED, CLOSED → Green (`#4ADE80`)
- ERROR → Red (`#F95757`)

### Navigation Structure

Update `partnersllc-app/lib/navigation-config.ts` - replace `adminNavConfig` sections:

```typescript
export const adminNavConfig: NavConfig = {
  sections: [
    {
      label: "Menu",
      items: [
        {
          href: "/admin",
          icon: "fa-chart-pie",
          label: "Vue d'ensemble",
        },
        {
          href: "/admin/dashboard",
          icon: "fa-gauge-high",
          label: "Tableau de bord",
        },
        {
          href: "/admin/dossiers",
          icon: "fa-folder-tree",
          label: "Dossiers LLC",
        },
        {
          href: "/admin/clients",
          icon: "fa-users",
          label: "Gestion Clients",
        },
        {
          href: "/admin/agents",
          icon: "fa-user-tie",
          label: "Gestion Agents",
        },
        {
          href: "/admin/products",
          icon: "fa-box",
          label: "Produits",
        },
        {
          href: "/admin/payment-links",
          icon: "fa-link",
          label: "Liens de paiement",
        },
        {
          href: "/admin/analytics",
          icon: "fa-chart-line",
          label: "Analytiques",
        },
      ],
    },
  ],
};
```

**Note**: If `/admin` route doesn't have a page yet, either create a simple redirect to `/admin/dashboard` or use `/admin/analytics` as the overview page.

**Note**: Gestion Clients (Story 4.10) and Gestion Agents (Story 4.11) pages must be created for these navigation items to work.

### Search Implementation

Implement client-side search with debouncing:

```typescript
// In AdminDossiersListContent component
const [searchTerm, setSearchTerm] = useState("");
const debouncedSearchTerm = useDebounce(searchTerm, 300);

const filteredDossiers = useMemo(() => {
  let filtered = dossiers;

  // Apply search filter
  if (debouncedSearchTerm) {
    const term = debouncedSearchTerm.toLowerCase();
    filtered = filtered.filter(
      (d) =>
        d.user?.full_name?.toLowerCase().includes(term) ||
        d.user?.email?.toLowerCase().includes(term) ||
        d.id.toLowerCase().includes(term) ||
        d.product?.name?.toLowerCase().includes(term) ||
        JSON.stringify(d.metadata).toLowerCase().includes(term)
    );
  }

  // Apply status filter
  if (selectedStatus && selectedStatus !== "all") {
    filtered = filtered.filter((d) => d.status === selectedStatus);
  }

  // Apply sort
  return sortDossiers(filtered, sortOption);
}, [dossiers, debouncedSearchTerm, selectedStatus, sortOption]);
```

### Authentication

**Source:** `docs/architecture.md#Authentication` and existing `partnersllc-app/lib/auth.ts`

Use `requireAgentAuth()` from `lib/auth.ts` to enforce agent/admin role:

```typescript
// In page.tsx
import { requireAgentAuth } from "@/lib/auth";

export default async function AdminDossiersListPage() {
  const agent = await requireAgentAuth();
  // ... fetch and render
}
```

This function already exists and is used in `/admin/dossiers/[id]/page.tsx`.

### Pending Documents Count

To show "Documents en attente" badge, you need to count pending documents for each dossier. Add this to the `getAllAdminDossiers()` function:

```typescript
// For each dossier, count pending documents
const { count: pendingDocsCount } = await supabase
  .from("documents")
  .select("id", { count: "exact", head: true })
  .eq("dossier_id", dossier.id)
  .in("status", ["PENDING"]);

dossierWithDetails.pending_documents_count = pendingDocsCount || 0;
```

**Alternative (more efficient)**: Use a single query with aggregation for all dossiers to avoid N+1 queries:

```typescript
const { data: pendingDocsCounts } = await supabase
  .from("documents")
  .select("dossier_id")
  .in("status", ["PENDING"]);

const countsMap =
  pendingDocsCounts?.reduce((acc, doc) => {
    acc[doc.dossier_id] = (acc[doc.dossier_id] || 0) + 1;
    return acc;
  }, {} as Record<string, number>) || {};

// Then in the loop:
dossierWithDetails.pending_documents_count = countsMap[dossier.id] || 0;
```

### URL State Management

Use Next.js App Router URL management:

```typescript
"use client";

import { useSearchParams, useRouter, usePathname } from "next/navigation";

export function AdminDossiersFilters() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();

  const updateQueryParams = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    router.push(`${pathname}?${params.toString()}`, { scroll: false });
  };

  // Usage:
  updateQueryParams("status", "IN_PROGRESS");
  updateQueryParams("search", "john");
  updateQueryParams("sort", "progress_asc");
}
```

### Existing Pages Reference

The following admin pages already exist (from git status and file system):

1. `/admin/dashboard` - Agent dashboard (Story 4.2)
2. `/admin/dossiers/[id]` - Dossier detail (Story 4.3)
3. `/admin/products` - Products management (Story 4.5)
4. `/admin/products/[id]/workflow` - Workflow configuration (Story 4.5)
5. `/admin/payment-links` - Payment links analytics (Story 4.6)
6. `/admin/analytics` - Analytics dashboard (Story 4.7)

All of these should be reflected in the updated navigation config.

### Testing

#### Testing Standards

**Source:** `docs/architecture.md#Testing Strategy` (section would be in architecture if v4+ sharded)

- Use Vitest for unit tests, Jest for integration tests, Playwright for E2E
- Test files located in `partnersllc-app/__tests__/` or co-located as `ComponentName.test.tsx`
- Test coverage requirement: 80%+ for critical business logic

#### Specific Test Cases

1. **Unit Tests** (`getAllAdminDossiers.test.ts`):

   - Test function returns all dossiers with client details
   - Test progress calculation is correct
   - Test pending documents count is accurate
   - Test function throws error on database failure

2. **Component Tests** (`AdminDossiersListContent.test.tsx`):

   - Test renders loading skeleton initially
   - Test renders empty state when no dossiers
   - Test renders correct number of dossier cards
   - Test status filter works correctly
   - Test search filters correctly
   - Test sort orders correctly
   - Test clicking card navigates to detail page

3. **E2E Tests** (`admin-dossiers-list.spec.ts`):
   - Test agent can access page
   - Test client cannot access page (403)
   - Test can filter, search, and sort dossiers
   - Test can navigate to dossier detail and back
   - Test URL query parameters persist
   - Test page works on mobile viewport

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2026-01-11 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References

No critical issues. Note: auth.admin.listUsers() used to fetch emails for client display.

### Completion Notes List

1. Created `getAllAdminDossiers()` function in `lib/dossiers.ts` with client info and pending docs count
2. Implemented efficient data fetching with bulk queries to avoid N+1 problems
3. Built admin dossiers list page at `/admin/dossiers` with requireAdminAuth()
4. Created responsive grid layout (1/2/3 columns) with hover effects
5. Implemented comprehensive filters: status, search (debounced 300ms), and sort
6. All filters sync with URL query parameters for shareable links
7. Search matches: client name, email, dossier ID, product name, metadata
8. Status badges color-coded according to design system
9. Cards show: client info, product, progress bar, current step, assigned agent, pending docs badge
10. Navigation already includes Dossiers LLC menu item (from story 4.9)

### File List

**Library:**

- `partnersllc-app/lib/dossiers.ts` (MODIFIED - added `DossierWithDetailsAndClient` interface and `getAllAdminDossiers()` function)

**Pages:**

- `partnersllc-app/app/(protected)/admin/dossiers/page.tsx` (NEW)

**Components:**

- `partnersllc-app/components/admin/dossiers/AdminDossiersListContent.tsx` (NEW)
- `partnersllc-app/components/admin/dossiers/AdminDossiersFilters.tsx` (NEW)
- `partnersllc-app/components/admin/dossiers/AdminDossierCard.tsx` (NEW)

**Navigation:**

- `partnersllc-app/lib/navigation-config.ts` (ALREADY UP TO DATE)

## QA Results

_Results from QA Agent review of the completed story implementation_
