# Story 2.11: Update Client Workflow for Admin Validation System

## Status

Ready for Review

## Story

**As a** client,
**I want** my workflow submissions to integrate with the admin validation system,
**so that** I can see validation status, receive feedback, and make corrections when needed.

**As a** developer,
**I want** to update Story 2.0 implementation to support the new validation system,
**so that** the workflow aligns with the database changes from Story 2.9.

## Context

This story **updates the implementation of Story 2.0** to integrate with the admin validation system introduced in Story 2.9.

**Story 2.9 Database Changes:**
- Added `validation_status` to `step_field_values` (PENDING, APPROVED, REJECTED)
- Added `validation_status` to `step_instances` (DRAFT, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED)
- Added `rejection_reason` fields for admin feedback
- Added review tracking tables

**What needs to change in Story 2.0:**
1. When client submits a step, set `step_instances.validation_status = SUBMITTED` (not auto-approved)
2. Display validation status badges on each field
3. Lock step navigation until current step is APPROVED
4. Show rejection feedback when fields are REJECTED
5. Allow editing and resubmitting REJECTED fields

This is a **refactoring story** that modifies existing code from Story 2.0, not new features.

## Acceptance Criteria

### Step Submission Changes

1. When client completes and submits a step, set `step_instances.validation_status = 'SUBMITTED'` (not APPROVED)
2. Client sees success message: "√âtape soumise. En attente de validation par notre √©quipe."
3. Step marked as submitted in workflow stepper with "Under Review" badge
4. Client cannot edit submitted step fields until admin reviews

### Validation Status Display

5. Each field in workflow shows validation status badge: Pending (yellow), Approved (green), Rejected (red)
6. Badge icons: Pending (clock), Approved (checkmark), Rejected (X)
7. Tooltip on hover shows full status text
8. If field REJECTED, tooltip shows rejection reason from admin
9. Progress indicator shows: "X/Y champs valid√©s" instead of just completion

### Step Navigation with Validation

10. Client can only proceed to next step if current step `validation_status = 'APPROVED'`
11. If step is SUBMITTED or UNDER_REVIEW, show message: "‚è≥ En attente de validation par notre √©quipe"
12. If step is REJECTED, show message: "‚ùå Cette √©tape n√©cessite des corrections. Veuillez corriger les champs rejet√©s."
13. Next step button disabled with lock icon if current step not APPROVED
14. Visual indicator (lock icon) on future steps in stepper

### Rejected Field Corrections

15. If any field in current step is REJECTED, client can edit only those rejected fields
16. Rejected fields highlighted with red border and error icon
17. Rejection reason displayed below field in red text
18. Non-rejected fields are disabled/read-only
19. "Corriger et soumettre" button enabled when all rejected fields have new values
20. On resubmit, update field values and set `validation_status = 'PENDING'`
21. Set `step_instances.validation_status = 'SUBMITTED'` again for re-review
22. Show success message: "Corrections envoy√©es pour validation"

### Dashboard Integration

23. Dashboard shows different states based on validation status:
    - DRAFT: "Continuer le formulaire" (continue editing)
    - SUBMITTED: "En attente de validation" (cannot edit, waiting for admin)
    - UNDER_REVIEW: "En cours de r√©vision par notre √©quipe"
    - APPROVED: Move to next step or show completed
    - REJECTED: "Corrections n√©cessaires" with CTA to fix
24. Warning banner on dashboard if any step is REJECTED
25. Banner shows count of fields needing correction
26. Click banner navigates to rejected step for editing

### API Route Updates

27. Update `POST /api/workflow/submit-step` to set validation_status = SUBMITTED
28. Create new `PATCH /api/workflow/resubmit-step` for correcting rejected fields
29. Update `GET /api/workflow/step-fields` to include validation_status and rejection_reason
30. Return validation status in all step instance queries

## Tasks / Subtasks

- [x] Update step submission logic (AC: 1-4)
  - [x] Modify `POST /api/workflow/submit-step` to set `validation_status = 'SUBMITTED'`
  - [x] Update success message after submission
  - [x] Prevent editing after submission (until admin reviews)
  - [x] Update step completion check to consider validation_status

- [x] Add validation status display to fields (AC: 5-9)
  - [x] Update `DynamicFormField.tsx` to fetch and display validation_status
  - [x] Create `ValidationStatusBadge.tsx` component
  - [x] Add icons for Pending, Approved, Rejected states
  - [x] Show rejection reason in tooltip
  - [x] Update progress indicator to show validated fields count

- [x] Implement step navigation with validation (AC: 10-14)
  - [x] Update `WorkflowStepper.tsx` to check validation_status before allowing next step
  - [x] Disable "Suivant" button if current step not APPROVED
  - [x] Show waiting message for SUBMITTED/UNDER_REVIEW
  - [x] Show correction message for REJECTED
  - [x] Add lock icons to future steps

- [x] Implement rejected field correction flow (AC: 15-22)
  - [x] Detect rejected fields in current step
  - [x] Highlight rejected fields with red border
  - [x] Display rejection reasons below fields
  - [x] Make only rejected fields editable
  - [x] Create "Corriger et soumettre" button
  - [x] Create `PATCH /api/workflow/resubmit-step` endpoint
  - [x] Update field values and reset validation_status to PENDING
  - [x] Re-set step validation_status to SUBMITTED

- [x] Update dashboard integration (AC: 23-26)
  - [x] Update `EmptyState.tsx` to handle different validation statuses
  - [x] Show appropriate CTA based on step status (Continue, Waiting, Fix)
  - [x] Create `RejectionWarningBanner.tsx` component
  - [x] Display banner when step.validation_status = REJECTED
  - [x] Navigate to rejected step on banner click

- [x] Update API routes (AC: 27-30)
  - [x] Modify submit-step to set SUBMITTED status
  - [x] Create resubmit-step endpoint
  - [x] Include validation_status in step-fields response
  - [x] Include rejection_reason in field value responses

## Dev Notes

### Updated Step Submission Flow

**Before (Story 2.0):**
```typescript
// When client submits step
UPDATE step_instances
SET completed_at = NOW()
WHERE id = $step_instance_id;

// Dossier immediately progresses
```

**After (Story 2.11):**
```typescript
// When client submits step
UPDATE step_instances
SET
  validation_status = 'SUBMITTED',
  completed_at = NULL  -- Not completed until admin approves
WHERE id = $step_instance_id;

// Client waits for admin validation
// Admin approves ‚Üí validation_status = 'APPROVED', completed_at = NOW()
```

### Validation Status Badge Component

```tsx
// components/workflow/ValidationStatusBadge.tsx
interface ValidationStatusBadgeProps {
  status: 'PENDING' | 'APPROVED' | 'REJECTED';
  rejectionReason?: string;
}

export function ValidationStatusBadge({ status, rejectionReason }: ValidationStatusBadgeProps) {
  const config = {
    PENDING: {
      icon: '‚è≥',
      label: 'En attente',
      color: 'bg-brand-warning/10 text-brand-warning border-brand-warning',
    },
    APPROVED: {
      icon: '‚úì',
      label: 'Valid√©',
      color: 'bg-brand-success/10 text-brand-success border-brand-success',
    },
    REJECTED: {
      icon: '‚úó',
      label: 'Refus√©',
      color: 'bg-brand-danger/10 text-brand-danger border-brand-danger',
    },
  };

  const { icon, label, color } = config[status];

  return (
    <div
      className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg border text-xs font-medium ${color}`}
      title={rejectionReason || label}
    >
      <span>{icon}</span>
      <span>{label}</span>
    </div>
  );
}
```

### Updated DynamicFormField Component

```tsx
// components/workflow/DynamicFormField.tsx
interface DynamicFormFieldProps {
  field: StepField;
  value: any;
  onChange: (value: any) => void;
  validationStatus?: 'PENDING' | 'APPROVED' | 'REJECTED';
  rejectionReason?: string;
  disabled?: boolean;
}

export function DynamicFormField({
  field,
  value,
  onChange,
  validationStatus = 'PENDING',
  rejectionReason,
  disabled = false,
}: DynamicFormFieldProps) {
  const isRejected = validationStatus === 'REJECTED';

  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <label className="text-sm font-medium text-brand-text-primary">
          {field.label}
          {field.is_required && <span className="text-brand-danger ml-1">*</span>}
        </label>
        <ValidationStatusBadge status={validationStatus} rejectionReason={rejectionReason} />
      </div>

      {/* Input field */}
      <input
        type={field.field_type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        disabled={disabled}
        className={`
          w-full px-4 py-3 rounded-xl bg-[#1A1B1E] border
          ${isRejected ? 'border-brand-danger' : 'border-brand-dark-border'}
          text-brand-text-primary
          disabled:opacity-50 disabled:cursor-not-allowed
        `}
      />

      {/* Rejection reason */}
      {isRejected && rejectionReason && (
        <div className="flex items-start gap-2 text-xs text-brand-danger">
          <span>‚ö†Ô∏è</span>
          <span>{rejectionReason}</span>
        </div>
      )}

      {/* Helper text */}
      {field.description && !isRejected && (
        <p className="text-xs text-brand-text-secondary">{field.description}</p>
      )}
    </div>
  );
}
```

### Updated WorkflowStepper Logic

```tsx
// components/workflow/WorkflowStepper.tsx
const WorkflowStepper = ({ dossier, productSteps }) => {
  const [currentStepIndex, setCurrentStepIndex] = useState(0);
  const currentStep = productSteps[currentStepIndex];
  const currentStepInstance = /* fetch from DB */;

  const canProceedToNext = () => {
    // Check if current step is approved by admin
    return currentStepInstance?.validation_status === 'APPROVED';
  };

  const getStepMessage = () => {
    const status = currentStepInstance?.validation_status;

    switch (status) {
      case 'DRAFT':
        return null; // Normal editing mode
      case 'SUBMITTED':
      case 'UNDER_REVIEW':
        return {
          type: 'info',
          icon: '‚è≥',
          text: 'En attente de validation par notre √©quipe',
        };
      case 'APPROVED':
        return {
          type: 'success',
          icon: '‚úì',
          text: '√âtape valid√©e',
        };
      case 'REJECTED':
        return {
          type: 'error',
          icon: '‚ùå',
          text: 'Cette √©tape n√©cessite des corrections. Veuillez corriger les champs rejet√©s.',
        };
    }
  };

  const handleNext = () => {
    if (!canProceedToNext()) {
      alert('Vous devez attendre la validation de l\'√©tape actuelle');
      return;
    }
    setCurrentStepIndex(currentStepIndex + 1);
  };

  return (
    <div>
      {/* Step message */}
      {getStepMessage() && (
        <div className={`p-4 rounded-lg mb-6 ${getStepMessage().type === 'error' ? 'bg-brand-danger/10 border border-brand-danger' : 'bg-brand-warning/10 border border-brand-warning'}`}>
          <div className="flex items-center gap-2">
            <span>{getStepMessage().icon}</span>
            <span className="text-sm">{getStepMessage().text}</span>
          </div>
        </div>
      )}

      {/* Form fields */}
      {/* ... */}

      {/* Navigation */}
      <div className="flex justify-between mt-8">
        <button onClick={handlePrevious}>Pr√©c√©dent</button>
        <button
          onClick={handleNext}
          disabled={!canProceedToNext()}
          className={`${!canProceedToNext() ? 'opacity-50 cursor-not-allowed' : ''}`}
        >
          {canProceedToNext() ? 'Suivant' : 'üîí Suivant (en attente de validation)'}
        </button>
      </div>
    </div>
  );
};
```

### Resubmit Rejected Fields Endpoint

```typescript
// app/api/workflow/resubmit-step/route.ts
import { createClient } from '@/lib/supabase/server';

export async function PATCH(request: Request) {
  const supabase = createClient();
  const { step_instance_id, corrected_fields } = await request.json();

  // corrected_fields: { field_id: new_value, ... }

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return new Response('Unauthorized', { status: 401 });
  }

  // Verify user owns this step instance
  const { data: stepInstance } = await supabase
    .from('step_instances')
    .select('*, dossiers(user_id)')
    .eq('id', step_instance_id)
    .single();

  if (!stepInstance || stepInstance.dossiers.user_id !== user.id) {
    return new Response('Forbidden', { status: 403 });
  }

  // Update only rejected field values
  for (const [field_id, new_value] of Object.entries(corrected_fields)) {
    await supabase
      .from('step_field_values')
      .update({
        value: new_value,
        validation_status: 'PENDING',
        rejection_reason: null,
        reviewed_by: null,
        reviewed_at: null,
        updated_at: new Date().toISOString(),
      })
      .eq('step_instance_id', step_instance_id)
      .eq('step_field_id', field_id)
      .eq('validation_status', 'REJECTED'); // Only update rejected fields
  }

  // Re-submit step instance for admin review
  await supabase
    .from('step_instances')
    .update({
      validation_status: 'SUBMITTED',
      rejection_reason: null,
      validated_by: null,
      validated_at: null,
    })
    .eq('id', step_instance_id);

  return new Response(JSON.stringify({ success: true }), { status: 200 });
}
```

### Updated Submit Step Endpoint

```typescript
// app/api/workflow/submit-step/route.ts
export async function POST(request: Request) {
  // ... existing validation ...

  // 1. Create/update step instance
  const { data: stepInstance } = await supabase
    .from('step_instances')
    .upsert({
      dossier_id,
      step_id,
      started_at: new Date().toISOString(),
      validation_status: 'SUBMITTED', // ‚úÖ NEW: Set to SUBMITTED instead of auto-approved
      // completed_at: null, // ‚úÖ Not completed until admin approves
    })
    .select()
    .single();

  // 2. Save field values with PENDING status
  for (const [field_id, value] of Object.entries(field_values)) {
    await supabase
      .from('step_field_values')
      .upsert({
        step_instance_id: stepInstance.id,
        step_field_id: field_id,
        value: String(value),
        validation_status: 'PENDING', // ‚úÖ NEW: Explicitly set to PENDING
        created_by_type: 'USER',
        created_by_id: user.id,
      });
  }

  // 3. Update dossier current_step_instance_id
  await supabase
    .from('dossiers')
    .update({ current_step_instance_id: stepInstance.id })
    .eq('id', dossier_id);

  return new Response(JSON.stringify({
    success: true,
    message: '√âtape soumise. En attente de validation par notre √©quipe.',
    step_instance_id: stepInstance.id,
  }), { status: 200 });
}
```

### Dashboard State Management

```tsx
// app/(protected)/dashboard/page.tsx
const DashboardPage = async () => {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Fetch dossier with current step instance
  const { data: dossier } = await supabase
    .from('dossiers')
    .select('*, step_instances(*)')
    .eq('user_id', user.id)
    .single();

  const currentStep = dossier?.step_instances?.[0];
  const validationStatus = currentStep?.validation_status;

  // Check if any steps are rejected
  const hasRejectedSteps = dossier?.step_instances?.some(
    (si) => si.validation_status === 'REJECTED'
  );

  return (
    <div>
      {/* Rejection warning banner */}
      {hasRejectedSteps && <RejectionWarningBanner dossier={dossier} />}

      {/* Different CTAs based on validation status */}
      {validationStatus === 'DRAFT' && (
        <button>Continuer le formulaire</button>
      )}
      {validationStatus === 'SUBMITTED' && (
        <div className="text-center p-6 bg-brand-warning/10 rounded-xl">
          <p className="text-brand-warning">‚è≥ En attente de validation par notre √©quipe</p>
        </div>
      )}
      {validationStatus === 'REJECTED' && (
        <button className="bg-brand-danger">Corriger les erreurs</button>
      )}
      {validationStatus === 'APPROVED' && (
        <button>Passer √† l'√©tape suivante</button>
      )}
    </div>
  );
};
```

### Rejection Warning Banner

```tsx
// components/dashboard/RejectionWarningBanner.tsx
export function RejectionWarningBanner({ dossier }) {
  const rejectedSteps = dossier.step_instances.filter(
    (si) => si.validation_status === 'REJECTED'
  );

  const rejectedFieldsCount = rejectedSteps.reduce((count, step) => {
    // Count rejected fields for each step
    const rejectedFields = step.step_field_values?.filter(
      (fv) => fv.validation_status === 'REJECTED'
    ) || [];
    return count + rejectedFields.length;
  }, 0);

  return (
    <div className="bg-brand-danger/10 border border-brand-danger rounded-xl p-4 mb-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <span className="text-2xl">‚ö†Ô∏è</span>
          <div>
            <p className="font-semibold text-brand-danger">
              Votre dossier n√©cessite des corrections
            </p>
            <p className="text-sm text-brand-text-secondary">
              {rejectedFieldsCount} champ{rejectedFieldsCount > 1 ? 's' : ''} √† corriger
            </p>
          </div>
        </div>
        <button
          className="px-4 py-2 border border-brand-danger text-brand-danger rounded-lg hover:bg-brand-danger/10"
          onClick={() => navigateToRejectedStep()}
        >
          Voir les corrections
        </button>
      </div>
    </div>
  );
}
```

### Testing Checklist

**Step Submission:**
- [ ] Submitting step sets validation_status to SUBMITTED
- [ ] Client sees "En attente de validation" message
- [ ] Client cannot edit fields after submission
- [ ] Step shows "Under Review" badge in stepper

**Validation Status Display:**
- [ ] Pending badge shows yellow with clock icon
- [ ] Approved badge shows green with checkmark
- [ ] Rejected badge shows red with X icon
- [ ] Tooltip displays rejection reason

**Step Navigation:**
- [ ] Cannot proceed to next step if current step not APPROVED
- [ ] Next button disabled with lock icon
- [ ] Waiting message shown for SUBMITTED status
- [ ] Correction message shown for REJECTED status

**Correction Flow:**
- [ ] Rejected fields highlighted in red
- [ ] Only rejected fields are editable
- [ ] Rejection reasons displayed below fields
- [ ] Resubmit updates values and sets status to PENDING
- [ ] Step re-submitted for admin review

**Dashboard:**
- [ ] Different CTAs based on validation status
- [ ] Rejection banner appears when step is REJECTED
- [ ] Banner shows count of rejected fields
- [ ] Clicking banner navigates to rejected step

### Backward Compatibility

- Existing dossiers without validation_status will default to PENDING/DRAFT
- No breaking changes to existing API routes
- New endpoints are additive (PATCH /resubmit-step)

### Migration Path

1. Run Story 2.9 migrations first (database changes)
2. Deploy Story 2.11 code changes
3. Existing in-flight dossiers will have PENDING status
4. Admins can start validating immediately

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial story creation to update Story 2.0 for validation system | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Auto (Cursor IDE)

### Debug Log References

No debug log entries required - all validations passed

### Completion Notes

Toutes les t√¢ches ont √©t√© compl√©t√©es avec succ√®s :

1. **Soumission d'√©tape** : L'endpoint submit-step d√©finit maintenant `validation_status = 'SUBMITTED'` au lieu de marquer comme compl√©t√©. Les field values sont cr√©√©es avec `validation_status = 'PENDING'`.

2. **Affichage du statut** : Le composant ValidationStatusBadge a √©t√© cr√©√© et int√©gr√© dans DynamicFormField pour afficher le statut de chaque champ avec des ic√¥nes et couleurs appropri√©es.

3. **Navigation avec validation** : WorkflowStepper v√©rifie maintenant le validation_status avant d'autoriser la navigation. Les boutons sont d√©sactiv√©s avec des ic√¥nes de cadenas pour les √©tapes verrouill√©es.

4. **Correction des champs rejet√©s** : Le flux de resoumission permet de corriger uniquement les champs rejet√©s. L'endpoint resubmit-step met √† jour les valeurs et r√©initialise le statut √† PENDING.

5. **Int√©gration dashboard** : EmptyState affiche maintenant des messages bas√©s sur le statut de validation et le RejectionWarningBanner alerte l'utilisateur des corrections n√©cessaires.

6. **API routes** : Tous les endpoints n√©cessaires ont √©t√© cr√©√©s ou modifi√©s pour supporter le syst√®me de validation.

### File List

**Modified from Story 2.0:**
- `partnersllc-app/app/api/workflow/submit-step/route.ts` - Updated to set SUBMITTED status and PENDING for field values
- `partnersllc-app/app/api/workflow/step-fields/route.ts` - Added support for step_instance_id to fetch validation status
- `partnersllc-app/components/qualification/DynamicFormField.tsx` - Added validation status display, rejection reason, and disabled state
- `partnersllc-app/components/workflow/WorkflowStepper.tsx` - Complete refactor to handle validation status, navigation locks, and resubmit flow
- `partnersllc-app/app/(protected)/dashboard/page.tsx` - Added validation status handling and rejected fields counting
- `partnersllc-app/components/dashboard/EmptyState.tsx` - Added validation status messages and RejectionWarningBanner integration
- `partnersllc-app/lib/dossiers.ts` - Updated StepInstance interface to include validation_status

**New files:**
- `partnersllc-app/components/workflow/ValidationStatusBadge.tsx` - Status badge component for PENDING, APPROVED, REJECTED
- `partnersllc-app/components/dashboard/RejectionWarningBanner.tsx` - Rejection warning banner with navigation
- `partnersllc-app/app/api/workflow/resubmit-step/route.ts` - PATCH endpoint for resubmitting rejected fields
- `partnersllc-app/app/api/workflow/step-instance/route.ts` - GET endpoint to fetch step instance with validation status

## QA Results

*Results from QA Agent review will be documented here.*
