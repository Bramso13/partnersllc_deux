# Story 1.6: Payment Link Generation (Admin Interface)

## Status

Done

## Story

**As an** admin,
**I want** to generate unique payment links for prospects by selecting a product and entering their email,
**so that** I can send personalized registration links that track conversions.

## Acceptance Criteria

1. Admin page created at `/admin/payment-links` (protected, requires AGENT or ADMIN role)
2. Payment link generation form includes: Product dropdown, Prospect Email input, Expiration Days input (default: 30)
3. Form validation: Email format validated, Product selection required, Expiration Days must be 1-90
4. On submit, Server Action creates record in `payment_links` table with generated 32-character token
5. Token generated using `generate_payment_link_token()` database function ensuring uniqueness
6. Record includes: `product_id`, `prospect_email`, `expires_at` (calculated from expiration days), `status: ACTIVE`
7. Success message displays with copyable link: `{BASE_URL}/register/{token}`
8. Payment links table displayed below form showing: Token (truncated with copy button), Prospect Email, Product Name, Created Date, Status, Expiration Date
9. Table supports filtering by status (ACTIVE, USED, EXPIRED) and sorting by created date
10. Expired links automatically marked as EXPIRED (handled by database constraint or daily cron - note for future epic)

## Tasks / Subtasks

- [ ] Create admin payment links page structure (AC: 1)
  - [ ] Create route `/admin/payment-links`
  - [ ] Add role-based access control (AGENT/ADMIN only)
  - [ ] Create page component layout
- [ ] Build payment link generation form (AC: 2, 3)
  - [ ] Add Product dropdown with populated options from database
  - [ ] Add Prospect Email input field
  - [ ] Add Expiration Days input (default: 30)
  - [ ] Implement form validation with React Hook Form + Zod
  - [ ] Ensure email format validation
  - [ ] Ensure product selection is required
  - [ ] Ensure expiration days 1-90 validation
- [ ] Implement Server Action for link generation (AC: 4, 5, 6)
  - [ ] Create Server Action to handle form submission
  - [ ] Call `generate_payment_link_token()` database function
  - [ ] Create record in `payment_links` table
  - [ ] Set `status: ACTIVE` and calculate `expires_at`
- [ ] Display success message with copyable link (AC: 7)
  - [ ] Show success notification after creation
  - [ ] Display generated link: `{BASE_URL}/register/{token}`
  - [ ] Add copy-to-clipboard button
- [ ] Build payment links data table (AC: 8, 9)
  - [ ] Display table with columns: Token (truncated), Prospect Email, Product Name, Created Date, Status, Expiration Date
  - [ ] Add copy button for token
  - [ ] Implement status filter (ACTIVE, USED, EXPIRED)
  - [ ] Implement sorting by created date
  - [ ] Fetch and display existing payment links
- [ ] Handle expired link status updates (AC: 10)
  - [ ] Note implementation for future epic (database constraint or cron job)

## Dev Notes

### Payment Links Table Structure

From `database-v2.sql`, the `payment_links` table has:

- `id` - Primary key
- `product_id` - Foreign key to products table
- `prospect_email` - Email of prospect
- `token` - Unique 32-character token
- `status` - ENUM (ACTIVE, USED, EXPIRED)
- `expires_at` - Timestamp for expiration
- `used_at` - Timestamp when link was used
- `used_by_user_id` - User ID who used the link
- `created_at` - Created timestamp
- `created_by` - User ID who created the link

### Database Function

The `generate_payment_link_token()` function in database:

- Generates unique 32-character tokens
- Returns the token value for insertion
- Ensures no duplicate tokens

### Products Data

Products available for selection:

- LLC Formation - $999
- Dubai Company Setup - $1,499

### Role-Based Access

Only AGENT and ADMIN roles can access `/admin/payment-links`. Use auth context/middleware to verify.

### Design System (from architecture.md)

**Color Palette:**

- Main Background: `#191A1D`
- Surface: `#2D3033`
- Border: `#363636`
- Text Primary: `#F9F9F9`
- Text Secondary: `#B7B7B7`
- Accent (Cyan): `#00F0FF`
- Success (Green): `#4ADE80`
- Warning (Yellow): `#FACC15`
- Danger (Red): `#F95757`

**UI Framework:** Tailwind CSS with custom design tokens
**Language:** French UI

### Testing

Testing standards from Story 1.1:

- Test file location: `__tests__` directory
- Test framework: Jest or Playwright
- Test form validation with valid and invalid inputs
- Test Server Action creation logic
- Test table filtering and sorting
- Mock Supabase responses

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be documented here._
