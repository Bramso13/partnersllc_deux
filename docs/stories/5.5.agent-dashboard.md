# Story 5.5: Agent Dashboard Overview

## Status

Draft

## Story

**As an** agent,
**I want** a dashboard showing my workload summary and recent activity,
**so that** I can quickly understand my current tasks and priorities.

## Acceptance Criteria

### Summary Cards
1. Dashboard at `/agent` (root of agent workspace)
2. Summary cards at top of page:
   - **Ã‰tapes assignÃ©es**: Count of incomplete assigned step_instances
   - **Documents Ã  reviewer**: Count of pending documents in assigned steps
   - **ComplÃ©tÃ©es aujourd'hui**: Count of steps completed today by this agent
   - **Temps moyen de review**: Average time from document upload to review (for this agent)
3. Cards clickable: Navigate to respective queue/list
4. Cards show trend indicator (optional): â†‘â†“ compared to yesterday

### Quick Access Sections
5. **Mes Ã©tapes** (compact view):
   - Show top 5 assigned steps sorted by age (oldest first)
   - Each shows: Step name, Client name, Time assigned
   - "Voir tout" link navigates to `/agent/steps`
6. **Documents en attente** (compact view):
   - Show top 5 pending documents sorted by upload date (oldest first)
   - Each shows: Document type, Client name, Upload date
   - "Voir tout" link navigates to `/agent/reviews`

### Activity Feed
7. **ActivitÃ© rÃ©cente** section:
   - Last 10 actions performed by current agent
   - Actions: step completed, document reviewed, note added, message sent
   - Each shows: Action description, Timestamp (relative)
   - Icon per action type
8. Feed fetched from `events` table where `actor_id = agent_id`

### User Experience
9. Welcome message: "Bonjour, {agent_name} !"
10. Current date displayed
11. Auto-refresh dashboard every 60 seconds
12. Loading skeletons for each section
13. Responsive layout: Cards stack on mobile, grid on desktop

## Tasks / Subtasks

- [ ] Create dashboard data fetching functions (AC: 2, 3, 5, 6, 7)
  - [ ] Create `lib/agent-dashboard.ts`
  - [ ] `getAgentDashboardStats()`: Returns all card counts
  - [ ] `getAgentTopSteps()`: Returns top 5 assigned steps
  - [ ] `getAgentPendingDocsPreview()`: Returns top 5 pending docs
  - [ ] `getAgentRecentActivity()`: Returns last 10 events

- [ ] Build dashboard page (AC: 1, 9, 10)
  - [ ] Update `app/(protected)/agent/page.tsx`
  - [ ] Create `AgentDashboardContent` client component
  - [ ] Add welcome message with agent name
  - [ ] Display current date

- [ ] Build summary cards (AC: 2, 3, 4)
  - [ ] Create `DashboardStatsCards` component
  - [ ] Display all 4 stats cards
  - [ ] Make cards clickable with navigation
  - [ ] Add trend indicators (optional)

- [ ] Build quick access sections (AC: 5, 6)
  - [ ] Create `QuickStepsSection` component
  - [ ] Create `QuickDocumentsSection` component
  - [ ] Display top 5 items each
  - [ ] Add "Voir tout" links

- [ ] Build activity feed (AC: 7, 8)
  - [ ] Create `ActivityFeed` component
  - [ ] Query events for current agent
  - [ ] Format event descriptions
  - [ ] Add icons per event type
  - [ ] Display relative timestamps

- [ ] Implement auto-refresh and loading states (AC: 11, 12)
  - [ ] 60-second refresh interval using SWR
  - [ ] Add loading skeletons for each section

- [ ] Responsive design (AC: 13)
  - [ ] Test on mobile, tablet, desktop
  - [ ] Ensure cards stack properly on mobile

- [ ] Testing
  - [ ] Test all stats are accurate
  - [ ] Test card navigation
  - [ ] Test activity feed shows correct events
  - [ ] Test auto-refresh
  - [ ] Test responsive layout

## Dev Notes

### Dashboard Data Structure

```typescript
interface AgentDashboardStats {
  assigned_steps_count: number;
  pending_documents_count: number;
  completed_today_count: number;
  avg_review_time_hours: number | null;
}

interface QuickStep {
  id: string;
  step_label: string;
  client_name: string;
  assigned_at: string;
}

interface QuickDocument {
  id: string;
  document_type_label: string;
  client_name: string;
  uploaded_at: string;
}

interface ActivityEvent {
  id: string;
  event_type: string;
  description: string;
  created_at: string;
  icon: string;
}
```

### Database Queries

**Stats Query:**
```sql
-- Assigned steps count
SELECT COUNT(*) FROM step_instances 
WHERE assigned_to = $agent_id AND completed_at IS NULL;

-- Pending documents count
SELECT COUNT(*) FROM documents doc
JOIN step_instances si ON si.id = doc.step_instance_id
WHERE doc.status = 'PENDING' AND si.assigned_to = $agent_id;

-- Completed today count
SELECT COUNT(*) FROM step_instances 
WHERE assigned_to = $agent_id 
AND DATE(completed_at) = CURRENT_DATE;

-- Average review time (in hours)
SELECT AVG(EXTRACT(EPOCH FROM (dr.reviewed_at - dv.uploaded_at)) / 3600)
FROM document_reviews dr
JOIN document_versions dv ON dv.id = dr.document_version_id
WHERE dr.reviewer_id = $agent_id
AND dr.reviewed_at > NOW() - INTERVAL '30 days';
```

**Activity Query:**
```sql
SELECT 
  id, event_type, payload, created_at
FROM events
WHERE actor_type = 'AGENT' AND actor_id = $agent_id
ORDER BY created_at DESC
LIMIT 10;
```

### Event Descriptions

```typescript
function formatEventDescription(event: Event): string {
  switch (event.event_type) {
    case 'STEP_COMPLETED':
      return `Ã‰tape "${event.payload.step_label}" complÃ©tÃ©e`;
    case 'DOCUMENT_REVIEWED':
      const action = event.payload.status === 'APPROVED' ? 'approuvÃ©' : 'rejetÃ©';
      return `Document ${action}`;
    case 'MESSAGE_SENT':
      return 'Message envoyÃ© au client';
    default:
      return event.event_type;
  }
}
```

### Event Icons

- `STEP_COMPLETED`: âœ… (`fa-circle-check`)
- `DOCUMENT_REVIEWED` (approved): ğŸ‘ (`fa-thumbs-up`)
- `DOCUMENT_REVIEWED` (rejected): ğŸ‘ (`fa-thumbs-down`)
- `MESSAGE_SENT`: ğŸ’¬ (`fa-comment`)
- Default: ğŸ“‹ (`fa-clipboard`)

### Dashboard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bonjour, Jean Dupont !                      11 janvier 2026   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Ã‰tapes     â”‚ â”‚ Documents  â”‚ â”‚ ComplÃ©tÃ©es â”‚ â”‚ Temps      â”‚   â”‚
â”‚ â”‚ assignÃ©es  â”‚ â”‚ Ã  reviewer â”‚ â”‚ aujourd'huiâ”‚ â”‚ moyen      â”‚   â”‚
â”‚ â”‚     12     â”‚ â”‚     8      â”‚ â”‚     5      â”‚ â”‚   2.3h     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MES Ã‰TAPES                                        [Voir tout] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Qualification - Jean Dupont         AssignÃ© il y a 3j    â”‚  â”‚
â”‚ â”‚ Documents - Marie Martin            AssignÃ© il y a 2j    â”‚  â”‚
â”‚ â”‚ ...                                                      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DOCUMENTS EN ATTENTE                              [Voir tout] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Passeport - Jean Dupont             UploadÃ© il y a 5j    â”‚  â”‚
â”‚ â”‚ Proof of Address - Marie Martin     UploadÃ© il y a 3j    â”‚  â”‚
â”‚ â”‚ ...                                                      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ACTIVITÃ‰ RÃ‰CENTE                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ âœ… Ã‰tape "Documents" complÃ©tÃ©e           il y a 2 heures â”‚  â”‚
â”‚ â”‚ ğŸ‘ Document approuvÃ©                     il y a 3 heures â”‚  â”‚
â”‚ â”‚ ğŸ‘ Document rejetÃ©                       il y a 4 heures â”‚  â”‚
â”‚ â”‚ ğŸ’¬ Message envoyÃ© au client              il y a 5 heures â”‚  â”‚
â”‚ â”‚ ...                                                      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Structure

```
partnersllc-app/
â”œâ”€â”€ app/(protected)/agent/
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ components/agent/dashboard/
â”‚   â”œâ”€â”€ AgentDashboardContent.tsx
â”‚   â”œâ”€â”€ DashboardStatsCards.tsx
â”‚   â”œâ”€â”€ QuickStepsSection.tsx
â”‚   â”œâ”€â”€ QuickDocumentsSection.tsx
â”‚   â””â”€â”€ ActivityFeed.tsx
â””â”€â”€ lib/
    â””â”€â”€ agent-dashboard.ts
```

### API Routes

Single API route for dashboard data:

```typescript
// app/api/agent/dashboard/route.ts
export async function GET() {
  const agent = await requireAgentRoleAuth();
  
  const [stats, topSteps, pendingDocs, activity] = await Promise.all([
    getAgentDashboardStats(agent.id),
    getAgentTopSteps(agent.id, 5),
    getAgentPendingDocsPreview(agent.id, 5),
    getAgentRecentActivity(agent.id, 10)
  ]);
  
  return NextResponse.json({
    stats,
    top_steps: topSteps,
    pending_documents: pendingDocs,
    recent_activity: activity
  });
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*To be filled during implementation*

## QA Results

*To be filled after QA review*
