# Story 2.7: Basic Workflow Step Completion

## Status

Cancelled

## Story

**As an** agent,
**I want** to manually complete workflow steps once all required documents are approved,
**so that** dossiers progress through the workflow and clients move to the next stage.

## Acceptance Criteria

1. Dossier detail page (agent view at `/admin/dossiers/[id]`) includes "Complete Step" button for current step
2. Button disabled (grayed out) until all required documents for step are APPROVED
3. Button enabled (green) when `are_step_documents_complete(step_instance_id)` returns TRUE
4. Clicking "Complete Step" triggers Server Action validating completion requirements
5. Server Action marks `step_instances.completed_at: now()` for current step
6. Server Action calls `get_next_step_for_dossier(dossier_id)` to retrieve next step instance ID
7. If next step exists, mark `step_instances.started_at: now()` for next step
8. Update `dossiers.current_step_instance_id` to next step instance ID
9. Create event: `STEP_COMPLETED` with payload including completed step and next step info
10. If no next step exists (final step completed), update `dossiers.status: COMPLETED`, set `completed_at: now()`
11. Create event: `DOSSIER_STATUS_CHANGED` when status changes to COMPLETED
12. Client dashboard immediately reflects updated progress (via page refresh or optimistic UI update)
13. Timeline shows new entry: "Step X completed by [Agent Name]"
14. Confirmation toast: "Step completed. Client will be notified of next steps."
15. E2E test covers: Upload docs → Agent approves → Complete step → Verify next step active

## Tasks / Subtasks

- [ ] Create agent dossier detail page at `/admin/dossiers/[id]` (AC: 1)
  - [ ] Build page layout with dossier information
  - [ ] Display current step details
  - [ ] Show step progress and completion status
- [ ] Build "Complete Step" button (AC: 2, 3)
  - [ ] Create button component
  - [ ] Query required documents for current step
  - [ ] Check if all documents are APPROVED
  - [ ] Disable button if any document not approved
  - [ ] Enable button when all documents approved (green color)
- [ ] Implement completion validation Server Action (AC: 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Call Server Action on button click
  - [ ] Validate all required documents are APPROVED
  - [ ] Mark current step_instances.completed_at
  - [ ] Call helper function get_next_step_for_dossier
  - [ ] If next step exists: mark step_instances.started_at
  - [ ] Update dossiers.current_step_instance_id
  - [ ] Create STEP_COMPLETED event with payload
  - [ ] Check if final step completed
  - [ ] If final: update dossiers.status to COMPLETED, set completed_at
  - [ ] Create DOSSIER_STATUS_CHANGED event if status changed
- [ ] Update client dashboard (AC: 12)
  - [ ] Implement page refresh trigger
  - [ ] Or implement optimistic UI update
  - [ ] Update progress indicator
  - [ ] Show new current step
- [ ] Add timeline entry (AC: 13)
  - [ ] Create timeline event entry
  - [ ] Show "Step X completed by [Agent Name]"
  - [ ] Display with timestamp
- [ ] Add confirmation notification (AC: 14)
  - [ ] Show toast: "Step completed. Client will be notified of next steps."
- [ ] Create E2E test (AC: 15)
  - [ ] Test upload documents
  - [ ] Approve documents
  - [ ] Complete step
  - [ ] Verify next step is active

## Dev Notes

### Database Context

**Step Instances Table:**

- `id`: UUID primary key
- `step_id`: UUID foreign key to steps table
- `dossier_id`: UUID foreign key to dossiers table
- `started_at`: timestamp (when step became active)
- `completed_at`: timestamp (nullable, when step was completed)

**Steps Table:**

- `id`: UUID primary key
- `product_id`: UUID foreign key to products table
- `step_number`: integer (order within product workflow)
- `title`: text
- `description`: text
- `total_steps`: integer (total steps for this product)

**Dossiers Table:**

- `id`: UUID primary key
- `user_id`: UUID foreign key
- `product_id`: UUID foreign key
- `status`: ENUM (QUALIFICATION, IN_PROGRESS, PENDING_REVIEW, COMPLETED, CANCELLED)
- `current_step_instance_id`: UUID foreign key to step_instances
- `created_at`: timestamp
- `completed_at`: timestamp (nullable)

**Document Versions Table:**

- `id`: UUID primary key
- `document_id`: UUID foreign key
- `version_number`: integer
- `status`: ENUM (PENDING, APPROVED, REJECTED, OUTDATED)
- `created_at`: timestamp

**Documents Table:**

- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `document_type_id`: UUID foreign key
- `step_instance_id`: UUID foreign key
- `current_version_id`: UUID foreign key to document_versions

**Events Table:**

- `id`: UUID primary key
- `dossier_id`: UUID foreign key
- `event_type`: ENUM (DOSSIER_CREATED, DOCUMENT_UPLOADED, DOCUMENT_REVIEWED, STEP_COMPLETED, DOSSIER_STATUS_CHANGED)
- `payload`: JSON
- `created_at`: timestamp

**Required Step Documents Table:**

- `id`: UUID primary key
- `step_id`: UUID foreign key to steps
- `document_type_id`: UUID foreign key to document_types

### Helper Functions

**are_step_documents_complete(step_instance_id):**

```typescript
// Check if all required documents for a step are approved
export async function are_step_documents_complete(
  stepInstanceId: string
): Promise<boolean> {
  // Query required documents for step
  const requiredDocTypes = await db.query(
    `SELECT document_type_id FROM required_step_documents
     WHERE step_id = (
       SELECT step_id FROM step_instances WHERE id = $1
     )`
  );

  // Check if all required document types have approved versions
  for (const docType of requiredDocTypes) {
    const approved = await db.query(
      `SELECT COUNT(*) FROM document_versions dv
       JOIN documents d ON d.current_version_id = dv.id
       WHERE d.step_instance_id = $1
         AND d.document_type_id = $2
         AND dv.status = 'APPROVED'`
    );

    if (approved.count === 0) return false;
  }

  return true;
}
```

**get_next_step_for_dossier(dossier_id):**

```typescript
// Get the next step for a dossier
export async function get_next_step_for_dossier(
  dossierId: string
): Promise<StepInstance | null> {
  const currentStep = await db.query(
    `SELECT si.* FROM step_instances si
     JOIN dossiers d ON d.current_step_instance_id = si.id
     WHERE d.id = $1`
  );

  const nextStep = await db.query(
    `SELECT si.*, s.step_number FROM step_instances si
     JOIN steps s ON s.id = si.step_id
     WHERE si.dossier_id = $1
       AND s.step_number = (
         SELECT step_number + 1 FROM steps
         WHERE id = $2
       )`
  );

  return nextStep || null;
}
```

### Server Action Pattern

```typescript
// app/admin/dossiers/[id]/complete-step.ts
"use server";

export async function completeCurrentStep(dossierId: string) {
  // 1. Verify user is agent/admin
  const user = await getUser();
  if (user.role !== "AGENT" && user.role !== "ADMIN") {
    throw new Error("Unauthorized");
  }

  // 2. Get current step instance
  const dossier = await db.query(
    `SELECT current_step_instance_id FROM dossiers WHERE id = $1`,
    [dossierId]
  );

  // 3. Validate all documents approved
  const allApproved = await are_step_documents_complete(
    dossier.current_step_instance_id
  );
  if (!allApproved) {
    throw new Error("Not all documents are approved");
  }

  // 4. Mark current step completed
  await db.query(
    `UPDATE step_instances SET completed_at = NOW()
     WHERE id = $1`,
    [dossier.current_step_instance_id]
  );

  // 5. Get next step
  const nextStep = await get_next_step_for_dossier(dossierId);

  if (nextStep) {
    // 6a. Mark next step started
    await db.query(
      `UPDATE step_instances SET started_at = NOW() WHERE id = $1`,
      [nextStep.id]
    );

    // 7. Update current step on dossier
    await db.query(
      `UPDATE dossiers SET current_step_instance_id = $1
       WHERE id = $2`,
      [nextStep.id, dossierId]
    );

    // 8. Create STEP_COMPLETED event
    await db.query(
      `INSERT INTO events (dossier_id, event_type, payload, created_at)
       VALUES ($1, 'STEP_COMPLETED', $2, NOW())`,
      [
        dossierId,
        JSON.stringify({
          completed_step_id: dossier.current_step_instance_id,
          next_step_id: nextStep.id,
          completed_by: user.id,
        }),
      ]
    );
  } else {
    // 6b. Final step completed
    await db.query(
      `UPDATE dossiers
       SET status = 'COMPLETED', completed_at = NOW()
       WHERE id = $1`,
      [dossierId]
    );

    // 9. Create DOSSIER_STATUS_CHANGED event
    await db.query(
      `INSERT INTO events (dossier_id, event_type, payload, created_at)
       VALUES ($1, 'DOSSIER_STATUS_CHANGED', $2, NOW())`,
      [
        dossierId,
        JSON.stringify({
          new_status: "COMPLETED",
          completed_at: new Date().toISOString(),
          completed_by: user.id,
        }),
      ]
    );
  }

  // 10. Create timeline entry
  await db.query(
    `INSERT INTO timeline_events (dossier_id, event_description, created_at)
     VALUES ($1, $2, NOW())`,
    [dossierId, `Step completed by ${user.full_name}`]
  );

  return { success: true };
}
```

### Component Architecture

- **AgentDossierDetailPage:** Server Component with dossier and step data
- **CurrentStepSection Component:** Shows current step with completion button
- **CompleteStepButton Component:** Disabled/enabled based on document approval status
- **StepProgressBar Component:** Visual progress indicator
- **DocumentApprovalStatus Component:** Shows approval status of required documents
- **TimelineComponent:** Displays step completion in timeline

### Button State Logic

```typescript
const [isComplete, setIsComplete] = useState(false);

useEffect(() => {
  // Check if all required documents are approved
  const checkCompletion = async () => {
    const allApproved = await are_step_documents_complete(stepInstanceId);
    setIsComplete(allApproved);
  };

  checkCompletion();
}, [stepInstanceId]);

// Button disabled={!isComplete}
```

### Event Payload Structure

**STEP_COMPLETED:**

```typescript
{
  completed_step_id: string;
  next_step_id?: string;
  completed_by: string;
  timestamp: ISO 8601 string;
}
```

**DOSSIER_STATUS_CHANGED:**

```typescript
{
  new_status: 'COMPLETED' | 'CANCELLED' | ...;
  previous_status: string;
  completed_by: string;
  timestamp: ISO 8601 string;
}
```

### Testing

**Unit Tests:**

- Test are_step_documents_complete() returns true when all docs approved
- Test are_step_documents_complete() returns false when any doc pending/rejected
- Test get_next_step_for_dossier() returns next step
- Test get_next_step_for_dossier() returns null for final step

**Integration Tests:**

- Test button disabled when documents not all approved
- Test button enabled when all documents approved
- Test clicking button calls Server Action
- Test Server Action marks step completed
- Test Server Action advances to next step
- Test Server Action updates dossier status on final step
- Test events created correctly
- Test timeline entry added

**E2E Test:**

```
Scenario: Complete workflow step
1. Upload document for current step
2. Agent reviews and approves document
3. Agent clicks "Complete Step" button
4. Verify step marked as completed
5. Verify next step becomes active
6. Verify client dashboard updated
7. Verify timeline shows step completion
```

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2026-01-06 | 1.0     | Initial story creation | John (PM Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be documented here._
