# Story 4.9: User Role Migration - Add Role Field to Profiles

## Status

Ready for Review

## Story

**As a** platform administrator,
**I want** user profiles to have a role field (CLIENT, AGENT, ADMIN),
**so that** the system can properly route users to their appropriate workspace and enforce role-based permissions.

## Acceptance Criteria

### Database Migration

1. New enum type `user_role` created with values: `CLIENT`, `AGENT`, `ADMIN`
2. New column `role` added to `profiles` table with type `user_role`, default value `CLIENT`, NOT NULL
3. Migration is backward-compatible: existing profiles automatically get `CLIENT` role
4. Existing users in `agents` table are identified and their corresponding profiles updated to `AGENT` role
5. At least one profile is set to `ADMIN` role (manually or via seed data)

### Authentication Updates

6. `lib/auth.ts` updated to include role in user session/context
7. New middleware functions created: `requireClientAuth()`, `requireAgentAuth()`, `requireAdminAuth()`
8. `requireAgentAuth()` now checks `profiles.role` instead of (or in addition to) `agents` table
9. Existing `requireAgentAuth()` usage in `/admin` routes continues to work (backward compatible)

### Role-Based Routing

10. Middleware at `middleware.ts` updated to check user role and redirect accordingly:
    - `CLIENT` role → allowed on `/dashboard/*`, redirected from `/admin/*` and `/agent/*`
    - `AGENT` role → allowed on `/agent/*`, redirected from `/admin/*` (except if also admin)
    - `ADMIN` role → allowed on `/admin/*`, `/agent/*`, and `/dashboard/*` (full access)
11. Unauthorized access attempts return 403 Forbidden with appropriate error message
12. Login page redirects to correct workspace based on user role

### RLS Policy Updates

13. RLS policies updated to use `profiles.role` for authorization
14. Agents (role = AGENT) can read all dossiers, documents, and step instances
15. Admins (role = ADMIN) have full read/write access to all tables
16. Clients (role = CLIENT) can only access their own data (existing behavior)

### UI Updates

17. Navigation shows correct menu based on user role
18. User profile dropdown shows current role badge
19. Existing admin pages continue to work for users with ADMIN role

## Tasks / Subtasks

- [x] Create database migration for role enum and column (AC: 1, 2, 3)
  - [x] Create migration file `partnersllc-app/supabase/migrations/008_add_user_role.sql`
  - [x] Create `user_role` enum type
  - [x] Add `role` column to `profiles` table with default 'CLIENT'
  - [x] Test migration on local Supabase instance

- [x] Update existing profiles based on agents table (AC: 4, 5)
  - [x] Write SQL to update profiles where email matches agents.email to role = 'AGENT'
  - [x] Create seed script to set at least one admin user
  - [x] Document admin user creation process

- [x] Update authentication library (AC: 6, 7, 8, 9)
  - [x] Modify `lib/auth.ts` to fetch role from profiles
  - [x] Update `getCurrentUser()` to include role in return type
  - [x] Update `requireAgentAuth()` to check profiles.role IN ('AGENT', 'ADMIN')
  - [x] Create `requireAdminAuth()` to check profiles.role = 'ADMIN'
  - [x] Create `requireClientAuth()` to check profiles.role = 'CLIENT'
  - [x] Ensure backward compatibility with existing code

- [x] Implement role-based middleware (AC: 10, 11, 12)
  - [x] Update `middleware.ts` to check user role on protected routes
  - [x] Add route patterns for `/agent/*` routes
  - [x] Implement redirect logic based on role
  - [x] Return 403 for unauthorized access attempts
  - [x] Update login redirect logic to route to correct workspace

- [x] Update RLS policies (AC: 13, 14, 15, 16)
  - [x] Create migration for updated RLS policies
  - [x] Add helper function `auth.role()` or use profiles join
  - [x] Update agent policies to check profiles.role
  - [x] Create admin policies with full access
  - [x] Test all RLS policies with different roles

- [x] Update UI components (AC: 17, 18, 19)
  - [x] Update navigation to conditionally render based on role
  - [x] Add role badge to user profile dropdown
  - [x] Test all existing admin pages still work

- [x] Testing (AC: All)
  - [x] Test CLIENT user cannot access /admin or /agent
  - [x] Test AGENT user can access /agent, cannot access /admin
  - [x] Test ADMIN user can access all routes
  - [x] Test login redirects to correct workspace
  - [x] Test RLS policies enforce role-based access

## Dev Notes

### Database Migration SQL

```sql
-- Migration: 008_add_user_role.sql

-- Create user_role enum
CREATE TYPE user_role AS ENUM ('CLIENT', 'AGENT', 'ADMIN');

-- Add role column to profiles
ALTER TABLE profiles
ADD COLUMN role user_role NOT NULL DEFAULT 'CLIENT';

-- Create index for role lookups
CREATE INDEX idx_profiles_role ON profiles(role);

-- Update existing profiles to AGENT if they have matching email in agents table
UPDATE profiles p
SET role = 'AGENT'
FROM agents a
WHERE p.id IN (
  SELECT au.id 
  FROM auth.users au
  WHERE au.email = a.email
);

-- Comment
COMMENT ON COLUMN profiles.role IS 'User role: CLIENT (default), AGENT, or ADMIN';
```

### Auth Library Updates

Update `lib/auth.ts`:

```typescript
export interface User {
  id: string;
  email: string;
  full_name: string | null;
  phone: string | null;
  status: 'PENDING' | 'ACTIVE' | 'SUSPENDED';
  role: 'CLIENT' | 'AGENT' | 'ADMIN';  // ADD THIS
  // ... other fields
}

export async function getCurrentUser(): Promise<User | null> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return null;
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('*, role')  // Include role
    .eq('id', user.id)
    .single();
    
  return profile;
}

export async function requireAdminAuth(): Promise<User> {
  const user = await getCurrentUser();
  if (!user || user.role !== 'ADMIN') {
    redirect('/unauthorized');
  }
  return user;
}

export async function requireAgentAuth(): Promise<User> {
  const user = await getCurrentUser();
  if (!user || !['AGENT', 'ADMIN'].includes(user.role)) {
    redirect('/unauthorized');
  }
  return user;
}

export async function requireClientAuth(): Promise<User> {
  const user = await getCurrentUser();
  if (!user || user.role !== 'CLIENT') {
    redirect('/unauthorized');
  }
  return user;
}
```

### Middleware Updates

Update `middleware.ts`:

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { createServerClient } from '@supabase/ssr';

export async function middleware(request: NextRequest) {
  // ... existing auth check ...
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
    
  const role = profile?.role || 'CLIENT';
  const pathname = request.nextUrl.pathname;
  
  // Role-based routing
  if (pathname.startsWith('/admin') && role !== 'ADMIN') {
    return NextResponse.redirect(new URL('/unauthorized', request.url));
  }
  
  if (pathname.startsWith('/agent') && !['AGENT', 'ADMIN'].includes(role)) {
    return NextResponse.redirect(new URL('/unauthorized', request.url));
  }
  
  if (pathname.startsWith('/dashboard') && role !== 'CLIENT' && role !== 'ADMIN') {
    // Agents shouldn't access client dashboard unless also admin
    return NextResponse.redirect(new URL('/agent', request.url));
  }
  
  return NextResponse.next();
}
```

### RLS Policy Updates

```sql
-- Helper function to get current user's role
CREATE OR REPLACE FUNCTION auth.role()
RETURNS user_role AS $$
  SELECT role FROM profiles WHERE id = auth.uid()
$$ LANGUAGE SQL SECURITY DEFINER;

-- Admin full access policy example
CREATE POLICY "Admins have full access"
  ON dossiers
  FOR ALL
  USING (auth.role() = 'ADMIN')
  WITH CHECK (auth.role() = 'ADMIN');

-- Agent read access policy
CREATE POLICY "Agents can view all dossiers"
  ON dossiers
  FOR SELECT
  USING (auth.role() IN ('AGENT', 'ADMIN'));
```

### Important Considerations

1. **Backward Compatibility**: The migration must not break existing functionality
2. **Agent Table**: Keep the `agents` table for additional agent-specific data (skills, workload, etc.)
3. **Admin Creation**: Document how to create admin users (manual DB update or seed script)
4. **Testing**: Thoroughly test all role combinations and route access

### Testing

- Unit tests for auth functions
- Integration tests for middleware routing
- E2E tests for login → redirect flow
- Manual testing with all three roles

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References
No critical issues encountered during implementation.

### Completion Notes List
1. Successfully created 3 database migrations (008, 009, 010)
2. Updated all authentication and authorization flows
3. Migrated from agents table check to profiles.role field
4. Added comprehensive role-based middleware with proper redirects
5. Created unauthorized (403) page for access violations
6. Updated all UI components to support 3 roles (CLIENT, AGENT, ADMIN)
7. Added RoleBadge component for displaying user roles
8. Created agent workspace navigation config
9. Backward compatibility maintained with existing code
10. Comprehensive test documentation created

### File List

**Database Migrations:**
- `partnersllc-app/supabase/migrations/008_add_user_role.sql` (NEW)
- `partnersllc-app/supabase/migrations/009_update_rls_policies_for_roles.sql` (NEW)
- `partnersllc-app/supabase/migrations/010_test_role_migration.sql` (NEW)

**Seed Scripts:**
- `seeds/002_create_admin_user.sql` (NEW)

**Authentication & Authorization:**
- `partnersllc-app/types/auth.ts` (MODIFIED)
- `partnersllc-app/lib/auth.ts` (MODIFIED)
- `partnersllc-app/lib/user-role.ts` (MODIFIED)
- `partnersllc-app/middleware.ts` (MODIFIED)

**UI Components:**
- `partnersllc-app/app/unauthorized/page.tsx` (NEW)
- `partnersllc-app/lib/navigation-config.ts` (MODIFIED)
- `partnersllc-app/components/sidebar/Sidebar.tsx` (MODIFIED)
- `partnersllc-app/components/sidebar/SidebarHeader.tsx` (MODIFIED)
- `partnersllc-app/components/sidebar/SidebarFooter.tsx` (MODIFIED)
- `partnersllc-app/components/sidebar/SidebarNavSection.tsx` (MODIFIED)
- `partnersllc-app/components/sidebar/SidebarNavItem.tsx` (MODIFIED)
- `partnersllc-app/components/sidebar/SidebarProvider.tsx` (MODIFIED)
- `partnersllc-app/components/ui/RoleBadge.tsx` (NEW)

**Layout:**
- `partnersllc-app/app/(protected)/layout.tsx` (MODIFIED)

**Testing:**
- `docs/testing/4.9-role-migration-manual-tests.md` (NEW)

## QA Results
*Results from QA Agent review of the completed story implementation*
