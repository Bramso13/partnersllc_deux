# Manual Testing Guide - Story 4.9: User Role Migration

## Test Date: 2026-01-11
## Tester: [Your Name]

---

## Prerequisites

- [ ] Local Supabase instance running
- [ ] All migrations applied (001-010)
- [ ] Test users created for each role (CLIENT, AGENT, ADMIN)

---

## Test 1: CLIENT Role Access

### Setup
1. Create test user account
2. Verify role = 'CLIENT' in profiles table
3. Login with test user

### Test Cases

- [ ] **TC1.1**: User can access `/dashboard`
- [ ] **TC1.2**: User is redirected from `/admin` to `/unauthorized`
- [ ] **TC1.3**: User is redirected from `/agent` to `/unauthorized`
- [ ] **TC1.4**: Navigation shows only CLIENT menu items
- [ ] **TC1.5**: User can view only their own dossiers
- [ ] **TC1.6**: User can create new dossiers
- [ ] **TC1.7**: User can upload documents to their dossiers
- [ ] **TC1.8**: User cannot view other users' dossiers

### Expected Result
✅ CLIENT users have restricted access to dashboard only

---

## Test 2: AGENT Role Access

### Setup
1. Create test user account
2. Update profile role to 'AGENT' in database
3. Login with test user

### Test Cases

- [ ] **TC2.1**: User is redirected from `/dashboard` to `/agent`
- [ ] **TC2.2**: User can access `/agent/*` routes
- [ ] **TC2.3**: User is redirected from `/admin` to `/unauthorized`
- [ ] **TC2.4**: Navigation shows AGENT workspace menu
- [ ] **TC2.5**: User can view ALL dossiers (not just own)
- [ ] **TC2.6**: User can view ALL documents
- [ ] **TC2.7**: User can update dossiers and step instances
- [ ] **TC2.8**: Sidebar shows "Espace Agent" label

### Expected Result
✅ AGENT users can access agent workspace and view all data

---

## Test 3: ADMIN Role Access

### Setup
1. Create test user account
2. Update profile role to 'ADMIN' in database
3. Login with test user

### Test Cases

- [ ] **TC3.1**: User can access `/admin/*` routes
- [ ] **TC3.2**: User can access `/agent/*` routes
- [ ] **TC3.3**: User can access `/dashboard` routes
- [ ] **TC3.4**: Navigation shows full ADMIN menu
- [ ] **TC3.5**: User has full CRUD access to dossiers
- [ ] **TC3.6**: User can view all profiles
- [ ] **TC3.7**: User can manage payment links
- [ ] **TC3.8**: User can manage products
- [ ] **TC3.9**: Sidebar shows "Back-Office" label
- [ ] **TC3.10**: Admin can update user roles (via database)

### Expected Result
✅ ADMIN users have full access to all areas

---

## Test 4: Login Redirection

### Test Cases

- [ ] **TC4.1**: CLIENT login redirects to `/dashboard`
- [ ] **TC4.2**: AGENT login redirects to `/agent`
- [ ] **TC4.3**: ADMIN login redirects to `/admin`
- [ ] **TC4.4**: Authenticated CLIENT accessing `/login` redirects to `/dashboard`
- [ ] **TC4.5**: Authenticated AGENT accessing `/login` redirects to `/agent`
- [ ] **TC4.6**: Authenticated ADMIN accessing `/login` redirects to `/admin`

### Expected Result
✅ Users are redirected to appropriate workspace based on role

---

## Test 5: RLS Policy Enforcement

### Test Cases (Use SQL queries)

```sql
-- As CLIENT user
SET request.jwt.claims.sub = '[CLIENT_USER_ID]';

-- Should return only their dossiers
SELECT COUNT(*) FROM dossiers;

-- Should fail or return 0 for other user's dossiers
SELECT COUNT(*) FROM dossiers WHERE user_id != '[CLIENT_USER_ID]';
```

- [ ] **TC5.1**: CLIENT can only query their own dossiers
- [ ] **TC5.2**: AGENT can query all dossiers
- [ ] **TC5.3**: ADMIN can query and modify all dossiers
- [ ] **TC5.4**: CLIENT cannot read other profiles
- [ ] **TC5.5**: AGENT can read all profiles
- [ ] **TC5.6**: ADMIN can read and update all profiles

### Expected Result
✅ RLS policies correctly enforce role-based access

---

## Test 6: Middleware Protection

### Test Cases (Manual browser testing)

- [ ] **TC6.1**: Unauthenticated access to `/dashboard` redirects to `/login`
- [ ] **TC6.2**: Unauthenticated access to `/admin` redirects to `/login`
- [ ] **TC6.3**: Unauthenticated access to `/agent` redirects to `/login`
- [ ] **TC6.4**: CLIENT accessing `/admin` returns 403 page
- [ ] **TC6.5**: CLIENT accessing `/agent` returns 403 page
- [ ] **TC6.6**: AGENT accessing `/admin` returns 403 page
- [ ] **TC6.7**: ADMIN can access all protected routes

### Expected Result
✅ Middleware correctly enforces authentication and authorization

---

## Test 7: UI Role Display

### Test Cases

- [ ] **TC7.1**: CLIENT sees "Client" badge (if profile dropdown exists)
- [ ] **TC7.2**: AGENT sees "Agent" badge with green styling
- [ ] **TC7.3**: ADMIN sees "Admin" badge with purple styling
- [ ] **TC7.4**: Navigation menu matches user role
- [ ] **TC7.5**: Sidebar header shows correct label per role

### Expected Result
✅ UI correctly displays role information

---

## Test 8: Backward Compatibility

### Test Cases

- [ ] **TC8.1**: Existing dossiers still accessible
- [ ] **TC8.2**: Existing documents still accessible
- [ ] **TC8.3**: Existing admin routes still work
- [ ] **TC8.4**: No broken API endpoints
- [ ] **TC8.5**: User sessions remain valid after migration

### Expected Result
✅ Migration doesn't break existing functionality

---

## Database Verification

Run the test migration script:

```bash
psql -U postgres -d partnersllc < supabase/migrations/010_test_role_migration.sql
```

- [ ] **All database tests pass**
- [ ] **Role distribution shows correct counts**
- [ ] **No errors in test output**

---

## Issues Found

| Issue # | Description | Severity | Status |
|---------|-------------|----------|--------|
| | | | |

---

## Sign-off

- [ ] All critical tests passed
- [ ] All issues documented
- [ ] Migration is safe to deploy to production

**Tester Signature**: ________________  
**Date**: ________________
